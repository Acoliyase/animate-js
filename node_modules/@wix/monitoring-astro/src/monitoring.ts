import { monitoring } from '@wix/essentials';
import { CaptureContext } from '@wix/monitoring-types';
import { getCallStack, getCallLocation } from '@wix/monitoring-common';
import type { LogParams } from './types.js';
import { METHODS } from './constants.js';

const transformLevel = (method: LogParams['method']): CaptureContext['level'] => {
  switch (method) {
    case 'log':
      return 'info';
    case 'warn':
      return 'warning';
    default:
      return method as CaptureContext['level'];
  }
};

const stringifySafe = (value: any) => {
  try {
    return JSON.stringify(value);
  } catch (error) {
    return `Failed to stringify log value: ${(error as Error)?.toString()}`;
  }
};

export const log = ({ method, stack }: LogParams, ...args: any[]): void => {
  const message = args
    .map((value) => (typeof value === 'string' ? value : value instanceof Error ? value.toString(): stringifySafe(value)))
    .join(' ');

  stack = stack ?? getCallStack();

  const sourceLocation = getCallLocation(stack);
  const contexts = sourceLocation ? {
    __sourceLocation: sourceLocation,
  } : undefined;

    monitoring.getMonitoringClient().captureMessage(message, {
      level: transformLevel(method),
      contexts,
    });
};

export const overrideConsoleMethods = (
  originalConsole: Pick<Console, LogParams['method']>
): void => {
  for (const method of METHODS) {
    const originalMethod = originalConsole[method];
    
    console[method] = (...args: unknown[]) => {
      originalMethod(...args);

      log({ method }, ...args);
    };
  }
};
