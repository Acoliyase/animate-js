import type { AstroIntegration } from 'astro';
import { outdent } from 'outdent';
import { getInlineMonitoringSnippet } from './client/setup-client.js';

export default(): AstroIntegration => {
  return {
    hooks: {
      'astro:config:setup'({ config, injectScript }) {
        if (!config.integrations.find((integration) => integration.name === '@wix/astro')) {
          throw new Error('The @wix/astro integration is required when using @wix/monitoring-astro');
        }

        injectScript('head-inline', getInlineMonitoringSnippet());

        injectScript(
          'page',
          outdent`
            import { setupClientMonitoring } from '@wix/monitoring-astro/setup-client';

            setupClientMonitoring();
          `
        );

        injectScript(
          'page-ssr',
          outdent`
            import { setupServerMonitoring } from '@wix/monitoring-astro/setup-server';

            setupServerMonitoring();
          `
        );
      },
      'astro:config:done': ({ config }) => {
        const astroIntegrationIndex = config.integrations.findIndex((integration) => integration.name === '@wix/astro');
        const monitoringInterationIndex = config.integrations.findIndex((integration) => integration.name === '@wix/monitoring-astro');
        
        if (astroIntegrationIndex > monitoringInterationIndex) {
          throw new Error('Please make sure the @wix/monitoring-astro integration is listed after @wix/astro');
        }
      },
    },
    name: '@wix/monitoring-astro',
  };
};
