{"version":3,"sources":["../src/index.ts","../src/client/setup-client.ts","../src/constants.ts"],"sourcesContent":["import type { AstroIntegration } from 'astro';\nimport { outdent } from 'outdent';\nimport { getInlineMonitoringSnippet } from './client/setup-client.js';\n\nexport default(): AstroIntegration => {\n  return {\n    hooks: {\n      'astro:config:setup'({ config, injectScript }) {\n        if (!config.integrations.find((integration) => integration.name === '@wix/astro')) {\n          throw new Error('The @wix/astro integration is required when using @wix/monitoring-astro');\n        }\n\n        injectScript('head-inline', getInlineMonitoringSnippet());\n\n        injectScript(\n          'page',\n          outdent`\n            import { setupClientMonitoring } from '@wix/monitoring-astro/setup-client';\n\n            setupClientMonitoring();\n          `\n        );\n\n        injectScript(\n          'page-ssr',\n          outdent`\n            import { setupServerMonitoring } from '@wix/monitoring-astro/setup-server';\n\n            setupServerMonitoring();\n          `\n        );\n      },\n      'astro:config:done': ({ config }) => {\n        const astroIntegrationIndex = config.integrations.findIndex((integration) => integration.name === '@wix/astro');\n        const monitoringInterationIndex = config.integrations.findIndex((integration) => integration.name === '@wix/monitoring-astro');\n        \n        if (astroIntegrationIndex > monitoringInterationIndex) {\n          throw new Error('Please make sure the @wix/monitoring-astro integration is listed after @wix/astro');\n        }\n      },\n    },\n    name: '@wix/monitoring-astro',\n  };\n};\n","import { outdent } from 'outdent';\nimport { METHODS } from '../constants.js';\nimport { log, overrideConsoleMethods } from '../monitoring.js';\nimport type { LogParams } from '../types.js';\n\ndeclare global {\n  interface Window {\n    __wixMonitoring?: {\n      originalMethods: Record<LogParams['method'], (...args: unknown[]) => void>;\n      queue: Array<{\n        args: unknown[];\n        method: LogParams['method'];\n        timestamp: number;\n        stack: string;\n      }>;\n    };\n  }\n}\n\nexport const getInlineMonitoringSnippet = () => outdent`\n  if (!window.__wixMonitoring && !location.pathname.startsWith('/_wix/extensions/backoffice')) {\n    window.__wixMonitoring = {\n      queue: [],\n      originalMethods: {},\n    };\n\n    ${JSON.stringify(METHODS)}.forEach((method) => {\n      window.__wixMonitoring.originalMethods[method] = console[method];\n\n      console[method] = (...args) => {\n        let stack = '';\n\n        try { throw Error() } catch(e) { stack = e.stack; } \n\n        window.__wixMonitoring.queue.push({method, stack, timestamp: Date.now(), args });\n        window.__wixMonitoring.originalMethods[method].apply(console, args);\n      };\n    });\n  }\n  `\n\nexport function setupClientMonitoring(): void {\n  if (location.pathname.startsWith('/_wix/extensions/backoffice')) {\n    return;\n  }\n\n  if (!window.__wixMonitoring) {\n    overrideConsoleMethods(console);\n    return;\n  }\n\n  const { originalMethods, queue } = window.__wixMonitoring;\n\n  overrideConsoleMethods(originalMethods);\n\n  for (const { method, stack, timestamp, args } of queue) {\n    log({ method, stack, timestamp }, ...args);\n  }\n\n  delete window.__wixMonitoring;\n}\n","import type { LogParams } from './types.js';\n\nexport const REPORT_URL = 'https://www.wixapis.com/wixcode/v1/telemetry/telemetry-messages';\n\nexport const METHODS: LogParams['method'][] = [\n  'debug',\n  'error',\n  'info',\n  'log',\n  'warn',\n];\n\nexport const MAX_LOGS = 10;\nexport const LOG_DEBOUNCE_MS = 1000;\n\n"],"mappings":";AACA,SAAS,WAAAA,gBAAe;;;ACDxB,SAAS,eAAe;;;ACIjB,IAAM,UAAiC;AAAA,EAC5C;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;;;ADSO,IAAM,6BAA6B,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAO1C,KAAK,UAAU,OAAO,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ADtB7B,IAAO,gBAAO,MAAwB;AACpC,SAAO;AAAA,IACL,OAAO;AAAA,MACL,qBAAqB,EAAE,QAAQ,aAAa,GAAG;AAC7C,YAAI,CAAC,OAAO,aAAa,KAAK,CAAC,gBAAgB,YAAY,SAAS,YAAY,GAAG;AACjF,gBAAM,IAAI,MAAM,yEAAyE;AAAA,QAC3F;AAEA,qBAAa,eAAe,2BAA2B,CAAC;AAExD;AAAA,UACE;AAAA,UACAC;AAAA;AAAA;AAAA;AAAA;AAAA,QAKF;AAEA;AAAA,UACE;AAAA,UACAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAKF;AAAA,MACF;AAAA,MACA,qBAAqB,CAAC,EAAE,OAAO,MAAM;AACnC,cAAM,wBAAwB,OAAO,aAAa,UAAU,CAAC,gBAAgB,YAAY,SAAS,YAAY;AAC9G,cAAM,4BAA4B,OAAO,aAAa,UAAU,CAAC,gBAAgB,YAAY,SAAS,uBAAuB;AAE7H,YAAI,wBAAwB,2BAA2B;AACrD,gBAAM,IAAI,MAAM,mFAAmF;AAAA,QACrG;AAAA,MACF;AAAA,IACF;AAAA,IACA,MAAM;AAAA,EACR;AACF;","names":["outdent","outdent"]}