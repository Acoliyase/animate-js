"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var cell_normalizing_exports = {};
__export(cell_normalizing_exports, {
  createCellNormalizingTransactionPlugin: () => createCellNormalizingTransactionPlugin
});
module.exports = __toCommonJS(cell_normalizing_exports);
var import_state = require("@tiptap/pm/state");
var import_transform = require("@tiptap/pm/transform");
var import_ricos_content = require("./../../ricos-content/index.js");
var import_shared = require("./shared.js");
const createCellNormalizingTransactionPlugin = () => {
  return new import_state.Plugin({
    key: new import_state.PluginKey("normalize-cell"),
    appendTransaction: (_, oldState, newState) => {
      if (newState.doc.eq(oldState.doc) && newState.selection.eq(oldState.selection)) {
        return;
      }
      const tr = newState.tr;
      tr.doc.forEach((node, pos) => {
        if (node.type.name === import_ricos_content.TIPTAP_LAYOUT_TYPE && node.childCount === 1 && node.firstChild?.attrs.id === null) {
          tr.deleteRange(pos, pos + node.nodeSize);
        }
      });
      tr.doc.descendants((node, pos, parent) => {
        if (node.type.name === import_ricos_content.TIPTAP_LAYOUT_CELL_TYPE && parent?.type.name !== import_ricos_content.TIPTAP_LAYOUT_TYPE) {
          const $from = tr.doc.resolve(pos);
          const $to = tr.doc.resolve(pos + node.nodeSize);
          const nodeRange = $from.blockRange($to);
          const wrapping = nodeRange && (0, import_transform.findWrapping)(nodeRange, newState.schema.nodes[import_ricos_content.TIPTAP_LAYOUT_TYPE], {
            id: (0, import_ricos_content.generateId)()
          });
          if (!wrapping) {
            return;
          }
          tr.wrap(nodeRange, wrapping);
        }
        if (node.type.name === import_ricos_content.TIPTAP_LAYOUT_CELL_TYPE && parent?.type.name === import_ricos_content.TIPTAP_LAYOUT_TYPE && node.attrs.colSpan === null) {
          const colSpans = [];
          parent.content.forEach((child) => colSpans.push(child.attrs.colSpan ?? 0));
          const totalColSpan = colSpans.reduce((acc, curr) => acc + curr, 0);
          const remainingColumns = import_shared.MAX_COLUMNS - totalColSpan;
          tr.setNodeAttribute(pos, "colSpan", remainingColumns);
        }
        if (node.type.name === import_ricos_content.TIPTAP_LAYOUT_CELL_TYPE && parent?.type.name === import_ricos_content.TIPTAP_LAYOUT_TYPE && node.childCount === 0) {
          const paragraphNode = newState.schema.nodes.PARAGRAPH.create({
            id: (0, import_ricos_content.generateId)()
          });
          const insertPos = pos + 1;
          tr.insert(insertPos, paragraphNode);
          const textPos = insertPos + 1;
          tr.setSelection(import_state.TextSelection.create(tr.doc, textPos));
        }
      });
      tr.doc.forEach((node, pos) => {
        if (node.type.name === import_ricos_content.TIPTAP_LAYOUT_TYPE) {
          const colSpans = [];
          node.content.forEach((child) => colSpans.push(child.attrs.colSpan ?? 0));
          const allColSpansValid = colSpans.every((colSpan) => colSpan >= import_shared.MIN_COL_SPAN);
          const colSpansSum = colSpans.reduce((acc, curr) => acc + curr, 0);
          if (colSpansSum !== import_shared.MAX_COLUMNS || !allColSpansValid) {
            (0, import_shared.balanceLayoutCells)(tr, node, pos);
          }
        }
      });
      return tr;
    }
  });
};
//# sourceMappingURL=cell-normalizing.js.map
