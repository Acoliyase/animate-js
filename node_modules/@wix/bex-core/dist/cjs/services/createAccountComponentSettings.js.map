{"version":3,"names":["_AccountPreferencesStrategy","require","_AccountPreferencesMergeStrategy","isDataCapsuleStorage","storageStrategy","createAccountComponentSettings","httpClient","environment","createEssentials","options","scope","componentId","artifactId","dataCapsule","_dataCapsule","namespace","join","oldLocalStorageComponentSettingsDataCapsule","fedopsLogger","fedops","appName","AccountPreferencesMergeStrategy","storage","AccountPreferencesStrategy","migrateItem","key","_localData$views","_data$views","localData","getItem","catch","interactionStarted","data","setItem","views","list","removeItem","interactionEnded","exports"],"sources":["../../../src/services/createAccountComponentSettings.ts"],"sourcesContent":["import { CreateComponentSettings } from '../model';\nimport {\n  BaseStorage,\n  BaseStorageOptions,\n  DataCapsule,\n} from '@wix/fe-essentials/data-capsule';\nimport {\n  AccountPreferencesStrategy,\n  WixStorageStrategyOptions,\n} from './AccountPreferencesStrategy';\nimport { AccountPreferencesMergeStrategy } from './AccountPreferencesMergeStrategy';\n\nfunction isDataCapsuleStorage(storageStrategy: {}): storageStrategy is {\n  storageStrategy: BaseStorage<WixStorageStrategyOptions>;\n} {\n  return 'storageStrategy' in storageStrategy;\n}\n\nexport const createAccountComponentSettings: CreateComponentSettings = ({\n  httpClient,\n  environment,\n  createEssentials,\n}) => {\n  return (options) => {\n    const scope = environment.componentId || environment.artifactId;\n\n    const { dataCapsule: _dataCapsule } = createEssentials({\n      dataCapsule: {\n        storageStrategy: 'userPreferences',\n        namespace: [scope, options.namespace].join('.'),\n      },\n    });\n\n    const {\n      dataCapsule: oldLocalStorageComponentSettingsDataCapsule,\n      fedopsLogger,\n    } = createEssentials({\n      dataCapsule: {\n        namespace: options.namespace,\n        scope,\n      } as { namespace: string; scope: string },\n      fedops: {\n        appName: 'cairo',\n      },\n    });\n\n    const dataCapsule = _dataCapsule as unknown as Omit<\n      DataCapsule,\n      'storageStrategy'\n    > & {\n      storageStrategy: BaseStorage<BaseStorageOptions>;\n    };\n\n    if (isDataCapsuleStorage(dataCapsule.storageStrategy)) {\n      dataCapsule.storageStrategy = new AccountPreferencesMergeStrategy({\n        storage: new AccountPreferencesStrategy({\n          httpClient,\n        }),\n      });\n    }\n\n    (_dataCapsule as { migrateItem?: (key: string) => unknown }).migrateItem =\n      async (key: string) => {\n        const localData = await oldLocalStorageComponentSettingsDataCapsule\n          .getItem(key)\n          .catch(() => null);\n\n        if (!localData) {\n          return;\n        }\n\n        fedopsLogger?.interactionStarted(\n          'account-component-settings-local-storage-migration',\n        );\n\n        const data = await dataCapsule.getItem(key).catch(() => null);\n\n        await dataCapsule.setItem(key, {\n          views: {\n            list: {\n              ...localData?.views?.list,\n              ...data?.views?.list,\n            },\n          },\n        });\n\n        await oldLocalStorageComponentSettingsDataCapsule.removeItem(key);\n\n        fedopsLogger?.interactionEnded(\n          'account-component-settings-local-storage-migration',\n        );\n      };\n\n    return _dataCapsule;\n  };\n};\n"],"mappings":";;;;AAMA,IAAAA,2BAAA,GAAAC,OAAA;AAIA,IAAAC,gCAAA,GAAAD,OAAA;AAEA,SAASE,oBAAoBA,CAACC,eAAmB,EAE/C;EACA,OAAO,iBAAiB,IAAIA,eAAe;AAC7C;AAEO,MAAMC,8BAAuD,GAAGA,CAAC;EACtEC,UAAU;EACVC,WAAW;EACXC;AACF,CAAC,KAAK;EACJ,OAAQC,OAAO,IAAK;IAClB,MAAMC,KAAK,GAAGH,WAAW,CAACI,WAAW,IAAIJ,WAAW,CAACK,UAAU;IAE/D,MAAM;MAAEC,WAAW,EAAEC;IAAa,CAAC,GAAGN,gBAAgB,CAAC;MACrDK,WAAW,EAAE;QACXT,eAAe,EAAE,iBAAiB;QAClCW,SAAS,EAAE,CAACL,KAAK,EAAED,OAAO,CAACM,SAAS,CAAC,CAACC,IAAI,CAAC,GAAG;MAChD;IACF,CAAC,CAAC;IAEF,MAAM;MACJH,WAAW,EAAEI,2CAA2C;MACxDC;IACF,CAAC,GAAGV,gBAAgB,CAAC;MACnBK,WAAW,EAAE;QACXE,SAAS,EAAEN,OAAO,CAACM,SAAS;QAC5BL;MACF,CAAyC;MACzCS,MAAM,EAAE;QACNC,OAAO,EAAE;MACX;IACF,CAAC,CAAC;IAEF,MAAMP,WAAW,GAAGC,YAKnB;IAED,IAAIX,oBAAoB,CAACU,WAAW,CAACT,eAAe,CAAC,EAAE;MACrDS,WAAW,CAACT,eAAe,GAAG,IAAIiB,gEAA+B,CAAC;QAChEC,OAAO,EAAE,IAAIC,sDAA0B,CAAC;UACtCjB;QACF,CAAC;MACH,CAAC,CAAC;IACJ;IAECQ,YAAY,CAAgDU,WAAW,GACtE,MAAOC,GAAW,IAAK;MAAA,IAAAC,gBAAA,EAAAC,WAAA;MACrB,MAAMC,SAAS,GAAG,MAAMX,2CAA2C,CAChEY,OAAO,CAACJ,GAAG,CAAC,CACZK,KAAK,CAAC,MAAM,IAAI,CAAC;MAEpB,IAAI,CAACF,SAAS,EAAE;QACd;MACF;MAEAV,YAAY,YAAZA,YAAY,CAAEa,kBAAkB,CAC9B,oDACF,CAAC;MAED,MAAMC,IAAI,GAAG,MAAMnB,WAAW,CAACgB,OAAO,CAACJ,GAAG,CAAC,CAACK,KAAK,CAAC,MAAM,IAAI,CAAC;MAE7D,MAAMjB,WAAW,CAACoB,OAAO,CAACR,GAAG,EAAE;QAC7BS,KAAK,EAAE;UACLC,IAAI,EAAE;YACJ,IAAGP,SAAS,aAAAF,gBAAA,GAATE,SAAS,CAAEM,KAAK,qBAAhBR,gBAAA,CAAkBS,IAAI;YACzB,IAAGH,IAAI,aAAAL,WAAA,GAAJK,IAAI,CAAEE,KAAK,qBAAXP,WAAA,CAAaQ,IAAI;UACtB;QACF;MACF,CAAC,CAAC;MAEF,MAAMlB,2CAA2C,CAACmB,UAAU,CAACX,GAAG,CAAC;MAEjEP,YAAY,YAAZA,YAAY,CAAEmB,gBAAgB,CAC5B,oDACF,CAAC;IACH,CAAC;IAEH,OAAOvB,YAAY;EACrB,CAAC;AACH,CAAC;AAACwB,OAAA,CAAAjC,8BAAA,GAAAA,8BAAA","ignoreList":[]}