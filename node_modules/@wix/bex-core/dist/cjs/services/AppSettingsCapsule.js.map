{"version":3,"names":["_http","require","_core","queryName","AppSettingsCapsule","constructor","params","_defineProperty2","default","httpClient","context","queryCache","queryClient","QueryClient","_buildAppSettingsPayload","payload","componentId","_getQueryKey","getItem","key","_data$settings","data","fetchQuery","queryFn","request","getGlobalSettings","host","queryKey","staleTime","settings","namespace","setItem","value","findAll","forEach","q","invalidate","setGlobalSettings","removeItem","exports"],"sources":["../../../src/services/AppSettingsCapsule.ts"],"sourcesContent":["import { WixPatternsEssentials, DataCapsule } from '../model';\nimport {\n  getGlobalSettings,\n  setGlobalSettings,\n} from '@wix/bex-utils/@wix/ambassador-app-settings-v1-settings/http';\nimport { Host } from '@wix/bex-utils/@wix/ambassador-app-settings-v1-settings/types';\nimport { QueryCache, QueryClient } from 'react-query/core';\n\nconst queryName = 'app-settings-capsule';\n\nexport interface AppSettingsCapsuleParams {\n  readonly httpClient: WixPatternsEssentials['httpClient'];\n  readonly context: {\n    namespace: string;\n    componentId: string;\n    host: Host;\n  };\n  queryCache: QueryCache;\n}\n\nexport class AppSettingsCapsule implements DataCapsule {\n  readonly httpClient;\n  readonly context;\n  readonly queryClient;\n  readonly queryCache;\n\n  constructor(params: AppSettingsCapsuleParams) {\n    this.httpClient = params.httpClient;\n    this.context = params.context;\n    this.queryCache = params.queryCache;\n    this.queryClient = new QueryClient({\n      queryCache: this.queryCache,\n    });\n  }\n\n  _buildAppSettingsPayload<P>(payload: P) {\n    const {\n      context: { componentId },\n    } = this;\n\n    return {\n      ...payload,\n      ...(componentId && { componentId }),\n    };\n  }\n\n  _getQueryKey() {\n    return [queryName, this.context];\n  }\n\n  async getItem<T>(key: string) {\n    const { context, httpClient, queryClient } = this;\n    const { data } = await queryClient.fetchQuery({\n      queryFn: () =>\n        httpClient.request(\n          getGlobalSettings({\n            host: context.host,\n          }),\n        ),\n      queryKey: this._getQueryKey(),\n      staleTime: 120000,\n    });\n    return data.settings?.[context.componentId]?.[context.namespace]?.[\n      key\n    ] as unknown as T;\n  }\n\n  async setItem<T>(key: string, value: T) {\n    const { httpClient, queryCache, context } = this;\n\n    queryCache\n      .findAll({ queryKey: this._getQueryKey() })\n      .forEach((q) => q.invalidate());\n\n    await httpClient.request(\n      setGlobalSettings({\n        host: context.host,\n        settings: {\n          [context.componentId]: {\n            [context.namespace]: {\n              [key]: value,\n            },\n          },\n        },\n      }),\n    );\n  }\n\n  async removeItem(key: string): Promise<void> {\n    await this.setItem(key, null);\n  }\n}\n"],"mappings":";;;;;;AACA,IAAAA,KAAA,GAAAC,OAAA;AAKA,IAAAC,KAAA,GAAAD,OAAA;AAEA,MAAME,SAAS,GAAG,sBAAsB;AAYjC,MAAMC,kBAAkB,CAAwB;EAMrDC,WAAWA,CAACC,MAAgC,EAAE;IAAA,IAAAC,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAC5C,IAAI,CAACC,UAAU,GAAGH,MAAM,CAACG,UAAU;IACnC,IAAI,CAACC,OAAO,GAAGJ,MAAM,CAACI,OAAO;IAC7B,IAAI,CAACC,UAAU,GAAGL,MAAM,CAACK,UAAU;IACnC,IAAI,CAACC,WAAW,GAAG,IAAIC,iBAAW,CAAC;MACjCF,UAAU,EAAE,IAAI,CAACA;IACnB,CAAC,CAAC;EACJ;EAEAG,wBAAwBA,CAAIC,OAAU,EAAE;IACtC,MAAM;MACJL,OAAO,EAAE;QAAEM;MAAY;IACzB,CAAC,GAAG,IAAI;IAER,OAAO;MACL,GAAGD,OAAO;MACV,IAAIC,WAAW,IAAI;QAAEA;MAAY,CAAC;IACpC,CAAC;EACH;EAEAC,YAAYA,CAAA,EAAG;IACb,OAAO,CAACd,SAAS,EAAE,IAAI,CAACO,OAAO,CAAC;EAClC;EAEA,MAAMQ,OAAOA,CAAIC,GAAW,EAAE;IAAA,IAAAC,cAAA;IAC5B,MAAM;MAAEV,OAAO;MAAED,UAAU;MAAEG;IAAY,CAAC,GAAG,IAAI;IACjD,MAAM;MAAES;IAAK,CAAC,GAAG,MAAMT,WAAW,CAACU,UAAU,CAAC;MAC5CC,OAAO,EAAEA,CAAA,KACPd,UAAU,CAACe,OAAO,CAChB,IAAAC,uBAAiB,EAAC;QAChBC,IAAI,EAAEhB,OAAO,CAACgB;MAChB,CAAC,CACH,CAAC;MACHC,QAAQ,EAAE,IAAI,CAACV,YAAY,CAAC,CAAC;MAC7BW,SAAS,EAAE;IACb,CAAC,CAAC;IACF,QAAAR,cAAA,GAAOC,IAAI,CAACQ,QAAQ,cAAAT,cAAA,GAAbA,cAAA,CAAgBV,OAAO,CAACM,WAAW,CAAC,cAAAI,cAAA,GAApCA,cAAA,CAAuCV,OAAO,CAACoB,SAAS,CAAC,qBAAzDV,cAAA,CACLD,GAAG,CACJ;EACH;EAEA,MAAMY,OAAOA,CAAIZ,GAAW,EAAEa,KAAQ,EAAE;IACtC,MAAM;MAAEvB,UAAU;MAAEE,UAAU;MAAED;IAAQ,CAAC,GAAG,IAAI;IAEhDC,UAAU,CACPsB,OAAO,CAAC;MAAEN,QAAQ,EAAE,IAAI,CAACV,YAAY,CAAC;IAAE,CAAC,CAAC,CAC1CiB,OAAO,CAAEC,CAAC,IAAKA,CAAC,CAACC,UAAU,CAAC,CAAC,CAAC;IAEjC,MAAM3B,UAAU,CAACe,OAAO,CACtB,IAAAa,uBAAiB,EAAC;MAChBX,IAAI,EAAEhB,OAAO,CAACgB,IAAI;MAClBG,QAAQ,EAAE;QACR,CAACnB,OAAO,CAACM,WAAW,GAAG;UACrB,CAACN,OAAO,CAACoB,SAAS,GAAG;YACnB,CAACX,GAAG,GAAGa;UACT;QACF;MACF;IACF,CAAC,CACH,CAAC;EACH;EAEA,MAAMM,UAAUA,CAACnB,GAAW,EAAiB;IAC3C,MAAM,IAAI,CAACY,OAAO,CAACZ,GAAG,EAAE,IAAI,CAAC;EAC/B;AACF;AAACoB,OAAA,CAAAnC,kBAAA,GAAAA,kBAAA","ignoreList":[]}