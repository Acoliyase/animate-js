{"version":3,"names":["_types","require","_http","_updateDataExtensionSchemaErrors","_createDataExtensionSchemaErrors","DataExtensionSchemaService","toSchemaType","type","format","maxLength","items","Error","toCustomType","field","hasOwnProperty","_field$items","toCustomField","schema","key","_schema$jsonSchema","property","jsonSchema","properties","title","id","constructor","params","_defineProperty2","default","httpClient","translate","errorHandler","addCustomField","_params$schema","_params$schema2","_params$schema3","userFieldsNamespace","form","name","readApps","readUsers","writeApps","writeUsers","containsPii","fqdn","permissions","read","write","filterable","namespace","enabled","_updateDataExtensionSchema","_createDataExtensionSchema","archiveCustomField","_params$schema4","_params$schema5","fetchSchemas","res","withErrorHandler","request","listDataExtensionSchemas","namespaces","fields","RequestedField","ARCHIVED","errorCodesMap","data","createDataExtensionSchema","dataExtensionSchema","createDataExtensionSchemaErrors","then","updateDataExtensionSchema","updateDataExtensionSchemaErrors","exports"],"sources":["../../../../src/services/DataExtensionService/dataExtensionService.ts"],"sourcesContent":["import {\n  DataExtensionSchema,\n  RequestedField,\n} from '@wix/bex-utils/@wix/ambassador-data-extensions-v1-data-extension-schema/types';\nimport {\n  createDataExtensionSchema,\n  listDataExtensionSchemas,\n  updateDataExtensionSchema,\n} from '@wix/bex-utils/@wix/ambassador-data-extensions-v1-data-extension-schema/http';\nimport { CustomFieldForm, WixPatternsContainer } from '../../state';\nimport { PatternsErrorHandler, WixPatternsEssentials } from '../../model';\nimport { updateDataExtensionSchemaErrors } from './updateDataExtensionSchemaErrors';\nimport { createDataExtensionSchemaErrors } from './createDataExtensionSchemaErrors';\n\nexport interface DataExtensionSchemaServiceParams {\n  readonly httpClient: WixPatternsEssentials['httpClient'];\n  readonly translate: WixPatternsContainer['translate'];\n  readonly errorHandler: PatternsErrorHandler;\n}\n\n// server types\nexport type DataExtensionType =\n  | 'string'\n  | 'number'\n  | 'integer'\n  | 'boolean'\n  | 'array'\n  | 'object';\n\nexport type DataExtensionPermission =\n  | 'apps'\n  | 'owning-app'\n  | 'users'\n  | 'users-of-users';\n\ninterface DataExtensionFieldItems\n  extends Partial<Omit<DataExtensionField, 'type' | 'maxLength'>> {\n  type: Omit<DataExtensionType, 'array'>;\n  maxLength: number;\n}\nexport interface DataExtensionField {\n  id: string;\n  type?: DataExtensionType;\n  format?: 'date-time' | 'date' | 'single-line' | 'uri' | string;\n  title?: string;\n  maxLength?: number;\n  enum?: string[];\n  'x-wix-archived'?: boolean;\n  'x-wix-filterable'?: boolean;\n  'x-wix-created-date': string;\n  'x-wix-object-type'?: string;\n  'x-wix-permissions': {\n    read: DataExtensionPermission[];\n    write: DataExtensionPermission[];\n  };\n  properties?: Record<string, any>;\n  items?: DataExtensionFieldItems;\n  'x-wix-pii'?: { enabled: boolean };\n}\n\n// client types\nexport type CustomFieldType =\n  | 'shortText'\n  | 'longText'\n  | 'url'\n  | 'date'\n  | 'dateTime'\n  | 'integer'\n  | 'decimal'\n  | 'checkbox'\n  | 'dropdown'\n  | 'files'\n  | 'multiSelect';\n\nexport type CustomFieldOrigin =\n  | 'Custom columns panel'\n  | 'Custom fields panel'\n  | 'Custom fields widget'\n  | 'external';\n\nexport interface ExtendedFieldsDataMap {\n  [key: string]: any;\n}\n\nexport interface ExtendedFields {\n  _type?: 'ExtendedFields';\n  /**\n   * Data Extensions extended fields\n   * Key: Namespace\n   * Value: extended fields data in Struct format\n   */\n  namespaces?: {\n    _user_fields?: ExtendedFieldsDataMap | undefined;\n    [key: string]: ExtendedFieldsDataMap | undefined;\n  };\n}\n\nexport type CustomFieldOwner = 'user' | 'app';\n\nexport interface CustomField {\n  id: string;\n  type: CustomFieldType;\n  label?: string;\n  maxLength?: number;\n  options?: string[];\n  editable: boolean;\n  filterable?: boolean;\n  owner: CustomFieldOwner;\n  properties?: Record<string, string>;\n  namespace: string;\n  permissions?: {\n    read?: DataExtensionPermission[];\n    write?: DataExtensionPermission[];\n  };\n}\n\nexport interface AddFieldParams {\n  schema?: DataExtensionSchema;\n  fqdn: string;\n  form: CustomFieldForm;\n  filterable?: boolean;\n}\n\nexport interface ArchiveFieldParams {\n  schema?: DataExtensionSchema;\n  fqdn: string;\n  id: string;\n}\n\nexport class DataExtensionSchemaService {\n  readonly httpClient: WixPatternsEssentials['httpClient'];\n  readonly translate: WixPatternsContainer['translate'];\n  readonly errorHandler;\n\n  readonly userFieldsNamespace = '_user_fields';\n\n  static toSchemaType(type?: CustomFieldType) {\n    switch (type) {\n      case 'shortText':\n        return {\n          type: 'string',\n          format: 'single-line',\n          maxLength: 120,\n        };\n      case 'longText':\n        return {\n          type: 'string',\n          maxLength: 200,\n        };\n      case 'url':\n        return {\n          type: 'string',\n          format: 'uri',\n          maxLength: 256,\n        };\n      case 'date':\n        return {\n          type: 'string',\n          format: 'date',\n        };\n      case 'dateTime':\n        return {\n          type: 'string',\n          format: 'date-time',\n        };\n      case 'integer':\n        return {\n          type: 'integer',\n        };\n      case 'decimal':\n        return {\n          type: 'number',\n        };\n      case 'checkbox':\n        return {\n          type: 'boolean',\n        };\n      case 'dropdown':\n        return {\n          type: 'array',\n          items: {\n            type: 'string',\n          },\n        };\n      default:\n        throw new Error(`Unexpected type: ${type}`);\n    }\n  }\n\n  static toCustomType(field: DataExtensionField): CustomFieldType | undefined {\n    switch (field.type) {\n      case 'string':\n        if (field.hasOwnProperty('enum')) {\n          return 'dropdown';\n        }\n        switch (field.format) {\n          case 'date-time':\n            return 'dateTime';\n          case 'uri':\n            return 'url';\n          case 'date':\n            return 'date';\n          case 'single-line':\n            return 'shortText';\n          default:\n            return 'longText';\n        }\n      case 'number':\n        return 'decimal';\n      case 'integer':\n        return 'integer';\n      case 'boolean':\n        return 'checkbox';\n      case 'array': {\n        if (field.items?.['x-wix-object-type'] === 'FILE/V1') {\n          return 'files';\n        }\n        return 'multiSelect';\n      }\n      case 'object': {\n        if (field['x-wix-object-type'] === 'FILE/V1') {\n          return 'files';\n        }\n        return 'dropdown';\n      }\n      default:\n        return;\n    }\n  }\n\n  static toCustomField(\n    schema: DataExtensionSchema,\n    key: string,\n  ): DataExtensionField | undefined {\n    const property: DataExtensionField = schema.jsonSchema?.properties?.[key];\n\n    if (!property || typeof property !== 'object') {\n      return;\n    }\n\n    if (\n      typeof property.title !== 'string' ||\n      typeof property.type !== 'string' ||\n      typeof property['x-wix-permissions'] !== 'object'\n    ) {\n      return;\n    }\n\n    return { ...property, id: key };\n  }\n\n  constructor(params: DataExtensionSchemaServiceParams) {\n    this.httpClient = params.httpClient;\n    this.translate = params.translate;\n    this.errorHandler = params.errorHandler;\n  }\n  addCustomField(params: AddFieldParams) {\n    const { userFieldsNamespace } = this;\n    const {\n      form: {\n        key,\n        name,\n        readApps,\n        readUsers,\n        writeApps,\n        writeUsers,\n        containsPii,\n      },\n      fqdn,\n    } = params;\n    const type = DataExtensionSchemaService.toSchemaType(params.form.type);\n\n    const permissions = {\n      read: [\n        'users',\n        ...(readUsers ? ['users-of-users'] : []),\n        ...(readApps ? ['apps'] : []),\n      ],\n      write: [\n        'users',\n        ...(writeUsers ? ['users-of-users'] : []),\n        ...(writeApps ? ['apps'] : []),\n      ],\n    };\n\n    const filterable = params.filterable ? { 'x-wix-filterable': true } : {};\n\n    const schema: DataExtensionSchema = {\n      fqdn,\n      namespace: userFieldsNamespace,\n      ...params.schema,\n      jsonSchema: {\n        properties: {\n          ...params.schema?.jsonSchema?.properties,\n          [key]: {\n            ...params.schema?.jsonSchema?.properties[key],\n            title: name,\n            ...(containsPii ? { 'x-wix-pii': { enabled: true } } : {}),\n            ...type,\n            'x-wix-permissions': permissions,\n            ...filterable,\n          },\n        },\n      },\n    };\n\n    return params.schema?.id\n      ? this._updateDataExtensionSchema(schema)\n      : this._createDataExtensionSchema(schema);\n  }\n\n  archiveCustomField(params: ArchiveFieldParams) {\n    const { userFieldsNamespace } = this;\n    const { id, fqdn } = params;\n\n    const schema: DataExtensionSchema = {\n      fqdn,\n      namespace: userFieldsNamespace,\n      ...params.schema,\n      jsonSchema: {\n        properties: {\n          ...params.schema?.jsonSchema?.properties,\n          [id]: {\n            ...params.schema?.jsonSchema?.properties[id],\n            'x-wix-archived': true,\n          },\n        },\n      },\n    };\n    return this._updateDataExtensionSchema(schema);\n  }\n\n  async fetchSchemas(fqdn: string) {\n    const { httpClient, errorHandler } = this;\n\n    const res = await errorHandler.withErrorHandler(\n      () =>\n        httpClient.request(\n          listDataExtensionSchemas({\n            fqdn,\n            namespaces: [],\n            fields: [RequestedField.ARCHIVED],\n          }),\n        ),\n      { errorCodesMap: {} },\n    );\n\n    return res.data;\n  }\n\n  private async _createDataExtensionSchema(schema: DataExtensionSchema) {\n    const { httpClient, errorHandler } = this;\n\n    return errorHandler\n      .withErrorHandler(\n        () =>\n          httpClient.request(\n            createDataExtensionSchema({ dataExtensionSchema: schema }),\n          ),\n        {\n          errorCodesMap: createDataExtensionSchemaErrors({\n            translate: this.translate,\n          }),\n        },\n      )\n      .then((res) => res.data);\n  }\n\n  private async _updateDataExtensionSchema(schema: DataExtensionSchema) {\n    const { httpClient, errorHandler } = this;\n    return errorHandler\n      .withErrorHandler(\n        () =>\n          httpClient.request(\n            updateDataExtensionSchema({ dataExtensionSchema: schema }),\n          ),\n        {\n          errorCodesMap: updateDataExtensionSchemaErrors({\n            translate: this.translate,\n          }),\n        },\n      )\n      .then((res) => res.data);\n  }\n}\n"],"mappings":"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","ignoreList":[]}