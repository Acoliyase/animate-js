{"version":3,"names":["_isHttpError","require","AccountPreferencesStrategy","constructor","params","_defineProperty2","default","httpClient","extendScope","scope","getAllItems","options","url","accountPrefHttpPath","namespace","filter","x","join","data","request","method","getItem","key","e","_e$response","isHttpError","response","status","Error","removeItem","payload","setItem","value","blob","expiration","ttlInDays","Math","ceil","exports"],"sources":["../../../src/services/AccountPreferencesStrategy.ts"],"sourcesContent":["import type {\n  BaseStorage,\n  BaseStorageOptions,\n} from '@wix/fe-essentials/data-capsule';\nimport { isHttpError } from '../util/isHttpError';\nimport { WixPatternsEssentials } from '../model';\n\nexport interface WixStorageStrategyOptions extends BaseStorageOptions {\n  expiration: number;\n}\n\nexport interface AccountPreferencesStrategyParams {\n  readonly httpClient: WixPatternsEssentials['httpClient'];\n}\n\nexport class AccountPreferencesStrategy\n  implements BaseStorage<WixStorageStrategyOptions>\n{\n  private readonly httpClient;\n\n  readonly accountPrefHttpPath =\n    '/_api/app-settings-service/v1/accountPreferences';\n\n  constructor(params: AccountPreferencesStrategyParams) {\n    this.httpClient = params.httpClient;\n  }\n\n  extendScope(scope: Required<WixStorageStrategyOptions>['scope']) {\n    return scope;\n  }\n\n  async getAllItems<T>(options: WixStorageStrategyOptions): Promise<T> {\n    const url = [\n      this.accountPrefHttpPath,\n      'getVolatilePrefs',\n      options.namespace,\n    ]\n      .filter((x) => x)\n      .join('/');\n\n    const { data } = await this.httpClient.request<T>({\n      url,\n      method: 'GET',\n    });\n    return data;\n  }\n\n  async getItem<T>(\n    key: string,\n    options: WixStorageStrategyOptions,\n  ): Promise<T> {\n    const url = [\n      this.accountPrefHttpPath,\n      'getVolatilePrefForKey',\n      options.namespace,\n      key,\n    ]\n      .filter((x) => x)\n      .join('/');\n\n    try {\n      const { data } = await this.httpClient.request<Record<string, T>>({\n        url,\n        method: 'GET',\n      });\n      return data[key];\n    } catch (e) {\n      if (isHttpError(e) && e.response?.status === 404) {\n        throw new Error('Key was not found in capsule');\n      }\n      throw e;\n    }\n  }\n\n  async removeItem(key: string, options: WixStorageStrategyOptions) {\n    const payload = {\n      namespace: options.namespace,\n      key,\n    };\n\n    const url = [this.accountPrefHttpPath, 'delete'].filter((x) => x).join('/');\n\n    await this.httpClient.request({ url, data: payload, method: 'POST' });\n  }\n\n  async setItem<T>(key: string, value: T, options: WixStorageStrategyOptions) {\n    const payload: any = {\n      namespace: options.namespace,\n      key,\n      blob: value,\n    };\n\n    if (options.expiration) {\n      payload.ttlInDays = Math.ceil(options.expiration / (60 * 60 * 24));\n    }\n\n    const url = [this.accountPrefHttpPath, 'set'].filter((x) => x).join('/');\n\n    await this.httpClient.request({ url, data: payload, method: 'POST' });\n  }\n}\n"],"mappings":"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","ignoreList":[]}