{"version":3,"names":["_merge","_interopRequireDefault","require","DataCapsuleMergeStrategy","constructor","params","_defineProperty2","default","storage","extendScope","scope","setItem","key","value","options","data","getItem","catch","undefined","merge","removeItem","getAllItems","exports"],"sources":["../../../src/services/DataCapsuleMergeStrategy.ts"],"sourcesContent":["import type {\n  BaseStorage,\n  BaseStorageOptions,\n} from '@wix/fe-essentials/data-capsule';\nimport { Scope } from '@wix/data-capsule/dist/types/base-storage';\nimport merge from 'lodash/merge';\n\nexport interface DataCapsuleMergeStrategyParams {\n  readonly storage: BaseStorage<BaseStorageOptions>;\n}\n\n// This \"merge\" layer allows to mimic the automatic \"merge\" behavior of app-settings also in user-preferences storage strategy.\n// https://github.com/wix-private/app-settings/blob/64eef870a0958a117a8325511f57df9d73857359/app-settings-service/src/services/mysql-storage.ts#L273\nexport class DataCapsuleMergeStrategy\n  implements BaseStorage<BaseStorageOptions>\n{\n  private readonly storage;\n\n  constructor(params: DataCapsuleMergeStrategyParams) {\n    this.storage = params.storage;\n  }\n\n  extendScope(scope: Scope) {\n    return scope;\n  }\n\n  async setItem<T>(\n    key: string,\n    value: T,\n    options: BaseStorageOptions,\n  ): Promise<void> {\n    const { storage } = this;\n    const data = await this.getItem(key, options).catch(() => undefined);\n    return storage.setItem(key, merge(data, value), options);\n  }\n\n  async removeItem(key: string, options: BaseStorageOptions) {\n    const { storage } = this;\n    const data = await this.getItem(key, options).catch(() => undefined);\n    return storage.setItem(key, merge(data, { [key]: null }), options);\n  }\n\n  async getItem<T = any>(key: string, options: BaseStorageOptions): Promise<T> {\n    return this.storage.getItem(key, options);\n  }\n\n  async getAllItems<T = any>(options: BaseStorageOptions): Promise<T> {\n    return this.storage.getAllItems(options);\n  }\n}\n"],"mappings":";;;;;;AAKA,IAAAA,MAAA,GAAAC,sBAAA,CAAAC,OAAA;AAMA;AACA;AACO,MAAMC,wBAAwB,CAErC;EAGEC,WAAWA,CAACC,MAAsC,EAAE;IAAA,IAAAC,gBAAA,CAAAC,OAAA;IAClD,IAAI,CAACC,OAAO,GAAGH,MAAM,CAACG,OAAO;EAC/B;EAEAC,WAAWA,CAACC,KAAY,EAAE;IACxB,OAAOA,KAAK;EACd;EAEA,MAAMC,OAAOA,CACXC,GAAW,EACXC,KAAQ,EACRC,OAA2B,EACZ;IACf,MAAM;MAAEN;IAAQ,CAAC,GAAG,IAAI;IACxB,MAAMO,IAAI,GAAG,MAAM,IAAI,CAACC,OAAO,CAACJ,GAAG,EAAEE,OAAO,CAAC,CAACG,KAAK,CAAC,MAAMC,SAAS,CAAC;IACpE,OAAOV,OAAO,CAACG,OAAO,CAACC,GAAG,EAAE,IAAAO,cAAK,EAACJ,IAAI,EAAEF,KAAK,CAAC,EAAEC,OAAO,CAAC;EAC1D;EAEA,MAAMM,UAAUA,CAACR,GAAW,EAAEE,OAA2B,EAAE;IACzD,MAAM;MAAEN;IAAQ,CAAC,GAAG,IAAI;IACxB,MAAMO,IAAI,GAAG,MAAM,IAAI,CAACC,OAAO,CAACJ,GAAG,EAAEE,OAAO,CAAC,CAACG,KAAK,CAAC,MAAMC,SAAS,CAAC;IACpE,OAAOV,OAAO,CAACG,OAAO,CAACC,GAAG,EAAE,IAAAO,cAAK,EAACJ,IAAI,EAAE;MAAE,CAACH,GAAG,GAAG;IAAK,CAAC,CAAC,EAAEE,OAAO,CAAC;EACpE;EAEA,MAAME,OAAOA,CAAUJ,GAAW,EAAEE,OAA2B,EAAc;IAC3E,OAAO,IAAI,CAACN,OAAO,CAACQ,OAAO,CAACJ,GAAG,EAAEE,OAAO,CAAC;EAC3C;EAEA,MAAMO,WAAWA,CAAUP,OAA2B,EAAc;IAClE,OAAO,IAAI,CAACN,OAAO,CAACa,WAAW,CAACP,OAAO,CAAC;EAC1C;AACF;AAACQ,OAAA,CAAAnB,wBAAA,GAAAA,wBAAA","ignoreList":[]}