{"version":3,"names":["_mobx","require","_events","OptimisticPatch","constructor","params","_defineProperty2","default","Date","now","EventEmitter","events","queryCache","queryNames","patches","isStale","listeners","length","remove","forEach","queryName","findAll","queryKey","q","invalidate","emit","patch","item","selector","actionType","keepPosition","move","collectionSnapshot","patchedItems","observable","map","deep","originalItems","originalTotal","makeObservable","patchedItemsEntries","computed","ref","onEventuallyUpdated","action","Array","from","entries","exports"],"sources":["../../../src/state/CollectionOptimisticPatch.ts"],"sourcesContent":["import {\n  action,\n  computed,\n  IObservableArray,\n  makeObservable,\n  observable,\n} from 'mobx';\nimport { EventEmitter } from 'events';\nimport { TypedEmitter } from '../util';\nimport { ActionMove } from '../model';\nimport { QueryCache } from 'react-query/core';\n\ninterface OptimisticPatchEvents<T> {\n  scheduleRemoval: (patch: OptimisticPatch<T>) => unknown;\n}\n\nexport type OptimisticPatchActionType =\n  | 'move'\n  | 'createMany'\n  | 'updateMany'\n  | 'updateAll'\n  | 'updateAllConst'\n  | 'deleteMany'\n  | 'deleteAll';\n\nexport interface OptimisticPatchParams<T> {\n  readonly patch?: (\n    item: T,\n    patch: OptimisticPatch<T>,\n  ) => Partial<T> | undefined;\n  readonly selector: (item: T, patch: OptimisticPatch<T>) => boolean;\n  readonly actionType: OptimisticPatchActionType;\n  readonly patchedItems: Map<string, T>;\n  readonly originalItems: Map<string, T>;\n  readonly originalTotal: number;\n  readonly keepPosition?: boolean;\n  readonly queryNames: string[];\n  readonly queryCache: QueryCache;\n  readonly patches: IObservableArray<OptimisticPatch<T>>;\n  readonly move?: ActionMove<T>;\n  readonly collectionSnapshot?: { [key: string]: string | number | undefined };\n}\n\nexport class OptimisticPatch<T> {\n  readonly patch;\n  readonly selector;\n  readonly actionType;\n  readonly patchedItems;\n  readonly originalItems;\n  readonly originalTotal;\n  readonly keepPosition;\n  readonly queryNames;\n  readonly queryCache;\n  readonly patches;\n  readonly move;\n  readonly createdAt = Date.now();\n  readonly collectionSnapshot;\n\n  isStale: boolean = false;\n\n  readonly events = new EventEmitter() as TypedEmitter<\n    OptimisticPatchEvents<T>\n  >;\n\n  constructor(params: OptimisticPatchParams<T>) {\n    this.patch = (item: T) => params.patch?.(item, this);\n    this.selector = (item: T) => params.selector(item, this);\n    this.actionType = params.actionType;\n    this.keepPosition = params.keepPosition;\n    this.queryNames = params.queryNames;\n    this.queryCache = params.queryCache;\n    this.patches = params.patches;\n    this.move = params.move;\n    this.collectionSnapshot = params.collectionSnapshot;\n\n    this.patchedItems = observable.map<string, T>(params.patchedItems, {\n      deep: false,\n    });\n\n    this.originalItems = observable.map<string, T>(params.originalItems, {\n      deep: false,\n    });\n\n    this.originalTotal = params.originalTotal;\n\n    makeObservable(this, {\n      patchedItemsEntries: computed,\n      isStale: observable.ref,\n      onEventuallyUpdated: action,\n    });\n  }\n\n  get patchedItemsEntries() {\n    return Array.from(this.patchedItems.entries());\n  }\n\n  onEventuallyUpdated = () => {\n    const { events, queryCache, queryNames, patches } = this;\n    this.isStale = true;\n    if (!events.listeners('scheduleRemoval').length) {\n      patches.remove(this);\n      queryNames.forEach((queryName) => {\n        queryCache\n          .findAll({ queryKey: [queryName] })\n          .forEach((q) => q.invalidate());\n      });\n    } else {\n      events.emit('scheduleRemoval', this);\n    }\n  };\n}\n"],"mappings":"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","ignoreList":[]}