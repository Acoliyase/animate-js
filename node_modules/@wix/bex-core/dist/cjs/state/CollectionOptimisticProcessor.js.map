{"version":3,"names":["_mobx","require","_QueryResultSimulationDefault","_CollectionOptimisticHelpers","_optimisticSimulation","_orderByOrders","_orderByMoves","CollectionOptimisticProcessor","constructor","params","_defineProperty2","default","collection","processorHelpers","CollectionOptimisticProcessorHelpers","optimistic","resultSimulationDefault","QueryResultSimulationDefault","predicate","orderBy","makeObservable","reprocess","action","bound","beforeAddNewPages","beforeSetTotal","_register","emitter","on","events","removeSelectionIfExists","itemKey","bulkSelect","result","originQuery","state","patches","itemPredicate","filterItem","filterPageByPatches","select","filter","item","pages","currentItemsMap","query","_orderByMode","orderByIteratee","limit","length","orders","finalPages","itemToMerge","prepareItemsToMergeIntoPage","all","size","map","page","index","pageWithPatchedItems","mergePatchedItems","orderByMoves","pageIndex","currentFiltersKeyHash","filtersKeyHash","toMerge","orderByOrders","total","processedTotal","reduce","prev","actionType","patchedItemsEntries","originalItems","originalTotal","key","originalItem","get","patchedItemsTotal","acc","value","Math","max","exports"],"sources":["../../../src/state/CollectionOptimisticProcessor.ts"],"sourcesContent":["import {\n  ComputedQuery,\n  ComputedQueryFull,\n  FiltersMap,\n  KeyedItem,\n} from '../model';\nimport { CollectionState } from './CollectionState';\nimport { action, makeObservable } from 'mobx';\nimport { Order, QueryResultSimulation } from './QueryResultSimulation';\nimport { QueryResultSimulationDefault } from './QueryResultSimulationDefault';\nimport { TypedEmitter } from '../util';\nimport { CollectionOptimisticProcessorHelpers } from './CollectionOptimisticHelpers';\nimport { CollectionOptimisticActionsState } from './CollectionOptimisticActionsState';\nimport {\n  filterPageByPatches,\n  mergePatchedItems,\n  prepareItemsToMergeIntoPage,\n} from './optimistic-simulation';\nimport { orderByOrders } from './optimistic-simulation/orderByOrders';\nimport { orderByMoves } from './optimistic-simulation/orderByMoves';\nimport { QueryState } from './QueryState';\n\ninterface Optimistic<T, F extends FiltersMap> {\n  _orderByMode: 'orders' | 'moves';\n  readonly state: CollectionOptimisticActionsState<T>;\n  readonly events: TypedEmitter<{\n    reprocess: () => void;\n    updated: () => void;\n  }>;\n  readonly query: QueryState<F>;\n}\n\nexport interface CollectionOptimisticProcessorParams<T, F extends FiltersMap>\n  extends Partial<QueryResultSimulation<T, F>> {\n  readonly collection: CollectionState<T, F>;\n  readonly optimistic: Optimistic<T, F>;\n}\n\nexport class CollectionOptimisticProcessor<T, F extends FiltersMap> {\n  readonly collection: CollectionState<T, F>;\n  readonly processorHelpers: CollectionOptimisticProcessorHelpers<T, F>;\n  readonly optimistic: Optimistic<T, F>;\n\n  readonly resultSimulationDefault: QueryResultSimulation<T, F>;\n  readonly predicate: (computedQuery: ComputedQuery<F>) => (item: T) => boolean;\n  readonly orderBy: (computedQuery: ComputedQuery<F>) => Order<T>[];\n\n  constructor(params: CollectionOptimisticProcessorParams<T, F>) {\n    this.collection = params.collection;\n    this.processorHelpers = new CollectionOptimisticProcessorHelpers(\n      this.collection,\n    );\n    this.optimistic = params.optimistic;\n\n    this.resultSimulationDefault = new QueryResultSimulationDefault({\n      collection: this.collection,\n    });\n    this.predicate = params.predicate ?? this.resultSimulationDefault.predicate;\n    this.orderBy = params.orderBy ?? this.resultSimulationDefault.orderBy;\n\n    makeObservable(this, {\n      reprocess: action.bound,\n      beforeAddNewPages: action.bound,\n      beforeSetTotal: action.bound,\n    });\n\n    this._register();\n  }\n\n  _register() {\n    this.collection.emitter.on('beforeAddNewPages', this.beforeAddNewPages);\n    this.collection.emitter.on('beforeSetTotal', this.beforeSetTotal);\n    this.optimistic.events.on('reprocess', this.reprocess);\n  }\n\n  reprocess() {\n    this.removeSelectionIfExists();\n    this.processorHelpers.reprocess();\n  }\n\n  removeSelectionIfExists() {\n    const {\n      collection: {\n        itemKey,\n        bulkSelect,\n        result: { originQuery },\n      },\n      optimistic: {\n        state: { patches },\n      },\n      predicate,\n    } = this;\n\n    const itemPredicate = predicate(originQuery);\n\n    const filterItem = filterPageByPatches(patches, { itemPredicate, itemKey });\n    bulkSelect.select.filter(({ item }) => filterItem(item));\n  }\n\n  beforeAddNewPages({\n    pages,\n    currentItemsMap,\n    originQuery,\n  }: {\n    pages: T[][];\n    currentItemsMap: Map<string, KeyedItem<T>>;\n    originQuery: ComputedQueryFull<F>;\n  }) {\n    const {\n      optimistic: { state, query, _orderByMode },\n      collection,\n      predicate,\n      orderBy: orderByIteratee,\n    } = this;\n\n    const { itemKey } = collection;\n\n    const { patches } = state;\n\n    const { limit } = originQuery;\n\n    if (!patches.length) {\n      return pages;\n    }\n\n    const itemPredicate = predicate(originQuery);\n    const orders =\n      _orderByMode === 'orders' ? orderByIteratee(originQuery) : [];\n\n    let finalPages = pages;\n\n    const itemToMerge = prepareItemsToMergeIntoPage(patches, {\n      itemPredicate,\n      currentItemsMap,\n    });\n\n    finalPages =\n      !itemToMerge.all.size && _orderByMode === 'orders'\n        ? finalPages\n        : finalPages.map((page, index) => {\n            const pageWithPatchedItems = itemToMerge.all.size\n              ? mergePatchedItems(itemToMerge, {\n                  page,\n                  limit,\n                  itemKey,\n                  orders,\n                  itemPredicate,\n                })\n              : page.map((item) => ({ item }));\n\n            return _orderByMode === 'moves'\n              ? orderByMoves({\n                  pageWithPatchedItems,\n                  pageIndex: index,\n                  patches,\n                  currentFiltersKeyHash: query.filtersKeyHash,\n                  itemKey,\n                  toMerge: itemToMerge,\n                  itemPredicate,\n                  limit,\n                })\n              : orderByOrders(pageWithPatchedItems, itemToMerge, {\n                  orders,\n                  itemKey,\n                  limit,\n                });\n          });\n\n    finalPages = finalPages.map((page) => {\n      return page.filter(\n        filterPageByPatches(patches, { itemPredicate, itemKey }),\n      );\n    });\n\n    return finalPages;\n  }\n\n  beforeSetTotal({\n    total,\n    originQuery,\n  }: {\n    total: number;\n    originQuery: ComputedQuery<F>;\n  }) {\n    const {\n      optimistic: { state },\n      predicate,\n    } = this;\n\n    const { patches } = state;\n\n    if (!patches.length) {\n      return total;\n    }\n\n    const itemPredicate = predicate(originQuery);\n\n    const processedTotal = patches.reduce(\n      (\n        prev,\n        { actionType, patchedItemsEntries, originalItems, originalTotal },\n      ) => {\n        if (actionType === 'updateAllConst' || actionType === 'deleteAll') {\n          const [[key, item] = []] = patchedItemsEntries;\n\n          if (key == null || item == null) {\n            return prev;\n          }\n\n          const originalItem = originalItems.get(key);\n\n          if (\n            itemPredicate(item) &&\n            (originalItem == null || !itemPredicate(originalItem))\n          ) {\n            return prev + originalTotal;\n          }\n\n          if (\n            // if action=deleteAll treat the item as filtered out, no need to check predicate\n            (actionType === 'deleteAll' || !itemPredicate(item)) &&\n            originalItem != null &&\n            itemPredicate(originalItem)\n          ) {\n            return prev - originalTotal;\n          }\n\n          return prev;\n        }\n\n        const patchedItemsTotal = patchedItemsEntries.reduce(\n          (acc, [key, item]) => {\n            const originalItem = originalItems.get(key);\n            const value = (() => {\n              switch (actionType) {\n                case 'deleteMany':\n                  if (originalItem != null && itemPredicate(originalItem)) {\n                    return -1;\n                  }\n\n                  return 0;\n                case 'updateMany':\n                case 'updateAll':\n                case 'createMany':\n                  if (\n                    itemPredicate(item) &&\n                    (originalItem == null || !itemPredicate(originalItem))\n                  ) {\n                    return 1;\n                  }\n\n                  if (\n                    !itemPredicate(item) &&\n                    originalItem != null &&\n                    itemPredicate(originalItem)\n                  ) {\n                    return -1;\n                  }\n                  return 0;\n              }\n\n              return 0;\n            })();\n            return acc + value;\n          },\n          0,\n        );\n\n        return prev + patchedItemsTotal;\n      },\n      total,\n    );\n\n    return Math.max(processedTotal, 0);\n  }\n}\n"],"mappings":"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","ignoreList":[]}