{"version":3,"names":["_PromisesSequence","require","_events","CollectionOptimisticSequenceExecutor","constructor","params","_defineProperty2","default","PromisesSequence","EventEmitter","showToast","translate","errorMonitor","onRollback","removeAndShowToast","toastConfig","removeToast","remove","sequence","seq","t","submit","onEventuallyUpdated","enqueue","err","console","error","captureException","errorToast","type","timeout","action","uiType","text","removeToastOnClick","onClick","_this$removeToast","_errorToast$action","call","currentToast","Promise","resolve","setTimeout","then","exports"],"sources":["../../../src/state/CollectionOptimisticSequenceExecutor.ts"],"sourcesContent":["import { ShowToast, ToastConfig } from '../model';\nimport { ErrorMonitor, Translate } from '../services';\nimport { PromisesSequence } from './PromisesSequence';\nimport { EventEmitter } from 'events';\nimport { TypedEmitter } from '../util';\n\nexport interface ExecuteParams<R> {\n  submit: () => Promise<R> | undefined;\n  onEventuallyUpdated?: () => unknown;\n}\n\nexport interface CollectionOptimisticSequenceExecutorParams {\n  readonly showToast: ShowToast;\n  readonly translate: Translate;\n  readonly errorMonitor: ErrorMonitor;\n  readonly onRollback: (err: unknown) =>\n    | (Omit<ToastConfig, 'action'> & {\n        action?: Partial<ToastConfig['action']>;\n      })\n    | undefined;\n}\n\nexport class CollectionOptimisticSequenceExecutor {\n  readonly showToast;\n  readonly translate;\n  readonly errorMonitor;\n  readonly onRollback;\n\n  readonly seq = new PromisesSequence();\n\n  removeToast: (() => void) | null = null;\n\n  readonly events = new EventEmitter() as TypedEmitter<{\n    windowClosedDuringSequence: () => unknown;\n  }>;\n\n  constructor(params: CollectionOptimisticSequenceExecutorParams) {\n    this.showToast = params.showToast;\n    this.translate = params.translate;\n    this.errorMonitor = params.errorMonitor;\n    this.onRollback = params.onRollback;\n  }\n\n  removeAndShowToast(toastConfig: ToastConfig) {\n    const { removeToast, showToast } = this;\n    removeToast?.();\n    this.removeToast = showToast(toastConfig).remove;\n  }\n\n  async sequence<R>(params: ExecuteParams<R>) {\n    const { seq, errorMonitor, translate: t, onRollback } = this;\n    const { submit, onEventuallyUpdated } = params;\n\n    try {\n      await seq.enqueue(async () => {\n        await submit();\n        onEventuallyUpdated?.();\n      });\n    } catch (err) {\n      console.error(err);\n      errorMonitor.captureException(err);\n\n      const errorToast = onRollback(err);\n\n      if (errorToast) {\n        this.removeAndShowToast({\n          ...errorToast,\n          type: 'ERROR',\n          timeout: 'NONE',\n          action: {\n            uiType: 'LINK',\n            text: t('cairo.toast.retry'),\n            removeToastOnClick: true,\n            ...errorToast.action,\n            onClick: () => {\n              this.removeToast?.();\n              this.removeToast = null;\n              errorToast.action?.onClick?.();\n            },\n          },\n        });\n\n        const currentToast = this.removeToast;\n        new Promise((resolve) => setTimeout(resolve, 12000)).then(() => {\n          if (currentToast === this.removeToast) {\n            currentToast?.();\n          }\n        });\n      }\n    }\n  }\n}\n"],"mappings":";;;;;;AAEA,IAAAA,iBAAA,GAAAC,OAAA;AACA,IAAAC,OAAA,GAAAD,OAAA;AAmBO,MAAME,oCAAoC,CAAC;EAchDC,WAAWA,CAACC,MAAkD,EAAE;IAAA,IAAAC,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA,eARjD,IAAIC,kCAAgB,CAAC,CAAC;IAAA,IAAAF,gBAAA,CAAAC,OAAA,uBAEF,IAAI;IAAA,IAAAD,gBAAA,CAAAC,OAAA,kBAErB,IAAIE,oBAAY,CAAC,CAAC;IAKlC,IAAI,CAACC,SAAS,GAAGL,MAAM,CAACK,SAAS;IACjC,IAAI,CAACC,SAAS,GAAGN,MAAM,CAACM,SAAS;IACjC,IAAI,CAACC,YAAY,GAAGP,MAAM,CAACO,YAAY;IACvC,IAAI,CAACC,UAAU,GAAGR,MAAM,CAACQ,UAAU;EACrC;EAEAC,kBAAkBA,CAACC,WAAwB,EAAE;IAC3C,MAAM;MAAEC,WAAW;MAAEN;IAAU,CAAC,GAAG,IAAI;IACvCM,WAAW,YAAXA,WAAW,CAAG,CAAC;IACf,IAAI,CAACA,WAAW,GAAGN,SAAS,CAACK,WAAW,CAAC,CAACE,MAAM;EAClD;EAEA,MAAMC,QAAQA,CAAIb,MAAwB,EAAE;IAC1C,MAAM;MAAEc,GAAG;MAAEP,YAAY;MAAED,SAAS,EAAES,CAAC;MAAEP;IAAW,CAAC,GAAG,IAAI;IAC5D,MAAM;MAAEQ,MAAM;MAAEC;IAAoB,CAAC,GAAGjB,MAAM;IAE9C,IAAI;MACF,MAAMc,GAAG,CAACI,OAAO,CAAC,YAAY;QAC5B,MAAMF,MAAM,CAAC,CAAC;QACdC,mBAAmB,YAAnBA,mBAAmB,CAAG,CAAC;MACzB,CAAC,CAAC;IACJ,CAAC,CAAC,OAAOE,GAAG,EAAE;MACZC,OAAO,CAACC,KAAK,CAACF,GAAG,CAAC;MAClBZ,YAAY,CAACe,gBAAgB,CAACH,GAAG,CAAC;MAElC,MAAMI,UAAU,GAAGf,UAAU,CAACW,GAAG,CAAC;MAElC,IAAII,UAAU,EAAE;QACd,IAAI,CAACd,kBAAkB,CAAC;UACtB,GAAGc,UAAU;UACbC,IAAI,EAAE,OAAO;UACbC,OAAO,EAAE,MAAM;UACfC,MAAM,EAAE;YACNC,MAAM,EAAE,MAAM;YACdC,IAAI,EAAEb,CAAC,CAAC,mBAAmB,CAAC;YAC5Bc,kBAAkB,EAAE,IAAI;YACxB,GAAGN,UAAU,CAACG,MAAM;YACpBI,OAAO,EAAEA,CAAA,KAAM;cAAA,IAAAC,iBAAA,EAAAC,kBAAA;cACb,CAAAD,iBAAA,OAAI,CAACpB,WAAW,aAAhBoB,iBAAA,CAAAE,IAAA,KAAmB,CAAC;cACpB,IAAI,CAACtB,WAAW,GAAG,IAAI;cACvB,CAAAqB,kBAAA,GAAAT,UAAU,CAACG,MAAM,aAAjBM,kBAAA,CAAmBF,OAAO,YAA1BE,kBAAA,CAAmBF,OAAO,CAAG,CAAC;YAChC;UACF;QACF,CAAC,CAAC;QAEF,MAAMI,YAAY,GAAG,IAAI,CAACvB,WAAW;QACrC,IAAIwB,OAAO,CAAEC,OAAO,IAAKC,UAAU,CAACD,OAAO,EAAE,KAAK,CAAC,CAAC,CAACE,IAAI,CAAC,MAAM;UAC9D,IAAIJ,YAAY,KAAK,IAAI,CAACvB,WAAW,EAAE;YACrCuB,YAAY,YAAZA,YAAY,CAAG,CAAC;UAClB;QACF,CAAC,CAAC;MACJ;IACF;EACF;AACF;AAACK,OAAA,CAAAzC,oCAAA,GAAAA,oCAAA","ignoreList":[]}