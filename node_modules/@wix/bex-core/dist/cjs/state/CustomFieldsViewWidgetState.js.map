{"version":3,"names":["_TaskState","require","_DataExtensionState","_services","_v","_AppsState","_mobx","CustomFieldsViewWidgetState","constructor","params","_defineProperty2","default","TaskState","performance","now","container","fqdn","url","theme","route","extensionPoint","reportBi","createBILogger","componentType","dataExtension","DataExtensionState","userFieldsNamespace","dataExtensionService","apps","AppsState","loadStart","makeObservable","isLoading","computed","init","initTask","runOnce","_dataExtension$initTa","_apps$initTask$status","Promise","all","status","promise","catch","onInitError","bind","loadEnd","loadingTime","Math","round","startTime","err","cairoError","WixPatternsError","errorCode","originalException","internalMonitor","reportError","error","cairoErrorInLoadingAComponent","errorType","name","retry","cairoTryAgainClicked","filteredListSize","availableUserCustomFields","length","actionName","loaction","isIdle","isError","getExtendedFieldsToDisplayForNamespace","namespace","extendedFields","_this$dataExtension$a","isUserNamespace","_extendedFields$names","userCustomFields","fields","namespaces","filter","field","fieldValue","id","isEmpty","undefined","appSchema","appSchemas","find","schema","appFields","getAvailableCustomFieldsForApp","getAppName","_this$dataExtension$a2","appNames","appDefId","exports"],"sources":["../../../src/state/CustomFieldsViewWidgetState.ts"],"sourcesContent":["import { WixPatternsContainer } from './WixPatternsContainer';\nimport { Fqdn } from '../model';\nimport { TaskState } from './TaskState';\nimport { DataExtensionState } from './DataExtensionState';\nimport { ExtendedFields, WixPatternsError } from '../services';\nimport {\n  cairoErrorInLoadingAComponent,\n  cairoTryAgainClicked,\n  loadEnd,\n  loadStart,\n} from '@wix/bex-utils/@wix/bi-logger-os-data/v2';\nimport { AppsState } from './AppsState';\nimport { computed, makeObservable } from 'mobx';\n\nexport interface CustomFieldsViewWidgetStateParams {\n  readonly container: WixPatternsContainer;\n  readonly fqdn: Fqdn;\n  readonly url: string;\n  readonly route?: string;\n  readonly theme?: 'inline' | 'card';\n  readonly extensionPoint?: string;\n}\nexport class CustomFieldsViewWidgetState {\n  readonly container: WixPatternsContainer;\n  readonly dataExtension;\n  readonly apps;\n  readonly initTask = new TaskState();\n  readonly reportBi;\n  readonly startTime = performance.now();\n  readonly url;\n  readonly route;\n  readonly theme;\n  readonly userFieldsNamespace;\n\n  constructor(params: CustomFieldsViewWidgetStateParams) {\n    const { container, fqdn, url, theme, route, extensionPoint } = params;\n    this.container = container;\n    this.url = url;\n    this.route = route;\n    this.theme = theme;\n\n    this.reportBi = container.createBILogger({\n      componentType: 'CustomFieldsViewWidget',\n      ...fqdn,\n    });\n\n    this.dataExtension = new DataExtensionState({\n      container,\n      fqdn,\n      extensionPoint,\n    });\n\n    this.userFieldsNamespace =\n      this.dataExtension.dataExtensionService.userFieldsNamespace;\n\n    this.apps = new AppsState({\n      container,\n      dataExtension: this.dataExtension,\n    });\n\n    this.reportBi(\n      loadStart({\n        url: this.url,\n        theme,\n      }),\n    );\n\n    makeObservable(this, {\n      isLoading: computed,\n    });\n  }\n\n  init() {\n    const { initTask, apps, dataExtension } = this;\n\n    dataExtension.init();\n    apps.init();\n\n    initTask.runOnce(async () => {\n      dataExtension.initTask.runOnce();\n      apps.initTask.runOnce();\n\n      await Promise.all([\n        dataExtension.initTask.status.promise?.catch(\n          this.onInitError.bind(this),\n        ),\n        apps.initTask.status.promise?.catch(() => null),\n      ]);\n\n      this.reportBi(\n        loadEnd({\n          url: this.url,\n          route: this.route,\n          loadingTime: Math.round(performance.now() - this.startTime),\n          theme: this.theme,\n        }),\n      );\n    });\n  }\n\n  onInitError(err: Error) {\n    const cairoError = new WixPatternsError({\n      errorCode: 'InitCustomFieldsDataExtensionFailed',\n      originalException: err,\n    });\n\n    this.container.internalMonitor.reportError({\n      error: cairoError,\n    });\n\n    this.reportBi(\n      cairoErrorInLoadingAComponent({\n        errorType: cairoError.name,\n      }),\n    );\n\n    throw cairoError;\n  }\n\n  retry() {\n    this.reportBi(\n      cairoTryAgainClicked({\n        filteredListSize: this.dataExtension.availableUserCustomFields.length,\n        actionName: 'Load custom fields',\n        loaction: 'View only widget',\n      }),\n    );\n\n    this.initTask.runOnce();\n  }\n\n  get isLoading() {\n    const { status } = this.initTask;\n    return status.isIdle || status.isLoading;\n  }\n\n  get isError() {\n    return this.initTask.status.isError;\n  }\n\n  getExtendedFieldsToDisplayForNamespace(\n    namespace: string,\n    extendedFields?: ExtendedFields,\n  ) {\n    const isUserNamespace = namespace === this.userFieldsNamespace;\n\n    if (isUserNamespace) {\n      const userCustomFields = this.dataExtension.availableUserCustomFields;\n      const fields =\n        extendedFields?.namespaces?.[\n          namespace as keyof typeof extendedFields.namespaces\n        ] ?? {};\n      return userCustomFields.filter((field) => {\n        const fieldValue = fields[field.id];\n        const isEmpty = fieldValue === null || fieldValue === undefined;\n        return !isEmpty;\n      });\n    }\n\n    const appSchema = this.dataExtension.appSchemas?.find(\n      (schema) => schema.namespace === namespace,\n    );\n    const appFields = appSchema\n      ? this.dataExtension.getAvailableCustomFieldsForApp(appSchema)\n      : [];\n\n    return appFields;\n  }\n\n  getAppName(namespace: string) {\n    const appSchema = this.dataExtension.appSchemas?.find(\n      (schema) => schema.namespace === namespace,\n    );\n\n    return this.apps.appNames[appSchema?.appDefId || ''];\n  }\n}\n"],"mappings":"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","ignoreList":[]}