{"version":3,"names":["_util","require","CollectionOptimisticExecutor","constructor","params","_defineProperty2","default","showToast","translate","errorMonitor","lodash","container","executePending","bind","scheduleExecution","batchWait","throttle","leading","trailing","removeAndShowToast","toastConfig","removeToast","remove","rollback","actions","onRollback","_actions","filter","action","indexOf","getSuccessToast","successToast","showUndoToast","showUndoSuccessToast","onUndo","t","resolveUndoTimeoutPromise","state","undoToast","timeoutPromises","Promise","_resolve","resolve","setTimeout","removeNavigationListener","addEventListener","events","title","text","uiType","onClick","status","type","priority","biName","message","removeToastOnClick","undefined","_execute","successToastState","submit","errorToast","errorToastFn","onTryAgain","onError","eventuallyUpdated","onEventuallyUpdated","undoResult","race","submitPromise","updateServerAfterPromise","all","then","result","err","console","error","captureException","onRetryClick","_this$removeToast","call","execute","retry","requestId","isHttpError","details","exports"],"sources":["../../../src/state/CollectionOptimisticExecutor.ts"],"sourcesContent":["import { ShowToast, ToastConfig } from '../model';\nimport {\n  ErrorMonitor,\n  ModalLayoutProps,\n  PartialLodash,\n  Translate,\n} from '../services';\nimport { addEventListener, isHttpError, TypedEmitter } from '../util';\n\nexport type EventuallyUpdated = 'submit' | number | Promise<unknown>;\n\nexport interface ExecuteParams<A, R> {\n  showUndoToast?: boolean;\n  showUndoSuccessToast?: boolean;\n  submit: (items: A[]) => Promise<R> | undefined;\n  eventuallyUpdated?: EventuallyUpdated;\n  onEventuallyUpdated?: () => unknown;\n  errorToast?: (\n    err: unknown,\n    params: { retry: () => void },\n  ) => ToastConfig | string;\n  onTryAgain?: () => void;\n  onError?: (err: unknown) => void;\n  onUndo?: () => void;\n  successToast?: ToastConfig | string;\n  onRollback: () => void;\n}\n\ninterface ExecutionBaseParams<A, R> {\n  successToastState: SuccessToastState;\n  submit: (actions: A[]) => Promise<R> | undefined;\n  eventuallyUpdated?: EventuallyUpdated;\n  onEventuallyUpdated?: () => unknown;\n  errorToast?: (\n    err: unknown,\n    params: { retry: () => void },\n  ) => ToastConfig | string;\n\n  onTryAgain?: () => void;\n  onError?: (err: unknown) => void;\n  successToast?: ToastConfig | string;\n  onRollback: () => void;\n}\n\ninterface ExecutionParams<A, R> extends ExecutionBaseParams<A, R> {\n  actions: A[];\n}\n\ninterface ScheduleExecutionParams<A, R> extends ExecutionBaseParams<A, R> {}\n\ninterface SuccessToastState {\n  undoToast?: UndoToastState;\n}\n\ninterface UndoToastState {\n  timeoutPromises: Promise<{ status?: 'undone' } | undefined>[];\n  removeNavigationListener: () => void;\n}\n\nexport interface CollectionOptimisticExecutorParams {\n  readonly showToast: ShowToast;\n  readonly translate: Translate;\n  readonly errorMonitor: ErrorMonitor;\n  readonly batchWait: number;\n  readonly lodash: PartialLodash;\n  readonly container: {\n    events: TypedEmitter<{\n      navigation: () => ModalLayoutProps | null | undefined;\n    }>;\n  };\n}\n\nexport class CollectionOptimisticExecutor<A> {\n  readonly showToast;\n  readonly translate;\n  readonly errorMonitor;\n  readonly lodash;\n  readonly container;\n\n  removeToast: (() => void) | null = null;\n\n  _actions: A[] = [];\n\n  scheduleExecution: <R>(params: ScheduleExecutionParams<A, R>) => unknown;\n\n  constructor(params: CollectionOptimisticExecutorParams) {\n    this.showToast = params.showToast;\n    this.translate = params.translate;\n    this.errorMonitor = params.errorMonitor;\n    this.lodash = params.lodash;\n    this.container = params.container;\n\n    this.executePending = this.executePending.bind(this);\n\n    this.scheduleExecution = params.batchWait\n      ? this.lodash.throttle(this.executePending, params.batchWait, {\n          leading: false,\n          trailing: true,\n        })\n      : this.executePending;\n  }\n\n  removeAndShowToast(toastConfig: ToastConfig) {\n    const { removeToast, showToast } = this;\n    removeToast?.();\n    this.removeToast = showToast(toastConfig).remove;\n  }\n\n  rollback(actions: A[], onRollback: () => void) {\n    this._actions = this._actions.filter(\n      (action) => actions.indexOf(action) === -1,\n    );\n    onRollback();\n  }\n\n  getSuccessToast(\n    actions: A[],\n    {\n      onRollback,\n      successToast,\n      showUndoToast,\n      showUndoSuccessToast,\n      onUndo,\n    }: {\n      successToast?: ToastConfig | string;\n      showUndoToast?: boolean;\n      showUndoSuccessToast?: boolean;\n      onRollback: () => unknown;\n      onUndo?: () => unknown;\n    },\n  ) {\n    const { container, showToast, translate: t } = this;\n\n    let resolveUndoTimeoutPromise:\n      | ((value: { status: 'undone' }) => void)\n      | null = null;\n\n    const state: SuccessToastState = {};\n\n    if (showUndoToast) {\n      state.undoToast = {\n        timeoutPromises: [\n          new Promise<{ status: 'undone' }>((_resolve) => {\n            resolveUndoTimeoutPromise = _resolve;\n          }),\n          new Promise<{ status?: undefined } | undefined>((resolve) =>\n            setTimeout(resolve, 6000),\n          ),\n        ],\n        removeNavigationListener: addEventListener(\n          container.events,\n          'navigation',\n          () => ({\n            title: t('cairo.dragAndDrop.leaveSite.modal.title'),\n          }),\n        ),\n      };\n    }\n\n    if (successToast) {\n      this.removeAndShowToast({\n        action: showUndoToast\n          ? {\n              text: t('cairo.toast.undo'),\n              uiType: 'LINK',\n              onClick: () => {\n                resolveUndoTimeoutPromise?.({ status: 'undone' });\n                this.rollback(actions, onRollback);\n                onUndo?.();\n                if (showUndoSuccessToast) {\n                  showToast({\n                    type: 'STANDARD',\n                    priority: 'LOW',\n                    biName: `cairo-undone`,\n                    message: t('cairo.toast.undone'),\n                  });\n                }\n              },\n              removeToastOnClick: true,\n            }\n          : undefined,\n        ...(typeof successToast === 'string'\n          ? { message: successToast, biName: `cairo-undo` }\n          : successToast),\n        type: 'SUCCESS',\n      });\n    }\n\n    return state;\n  }\n\n  async _execute<R>(params: ExecutionParams<A, R>) {\n    const {\n      successToastState,\n      submit,\n      errorToast: errorToastFn,\n      onTryAgain,\n      onError,\n      onRollback,\n      eventuallyUpdated,\n      onEventuallyUpdated,\n      actions,\n    } = params;\n    const { errorMonitor, translate: t } = this;\n\n    const { undoToast } = successToastState;\n\n    try {\n      if (undoToast) {\n        const undoResult = await Promise.race(undoToast.timeoutPromises);\n        undoToast.removeNavigationListener();\n        if (undoResult?.status === 'undone') {\n          return undoResult;\n        }\n      }\n\n      const submitPromise = await submit(actions);\n\n      const updateServerAfterPromise =\n        typeof eventuallyUpdated === 'number'\n          ? await Promise.all([\n              submitPromise,\n              new Promise((resolve) => setTimeout(resolve, eventuallyUpdated)),\n            ]).then(() => submitPromise)\n          : submitPromise;\n\n      const result = await updateServerAfterPromise;\n      await onEventuallyUpdated?.();\n\n      return {\n        result,\n        status: 'success',\n      };\n    } catch (err) {\n      console.error(err);\n      errorMonitor.captureException(err);\n      this.rollback(actions, onRollback);\n      onError?.(err);\n\n      if (errorToastFn) {\n        const onRetryClick = () => {\n          onTryAgain?.();\n          this.removeToast?.();\n\n          this.execute(actions, params);\n        };\n\n        const errorToast = errorToastFn(err, { retry: onRetryClick });\n\n        const requestId = isHttpError(err) ? err.requestId : undefined;\n\n        const toastConfig: ToastConfig = {\n          action: {\n            uiType: 'LINK',\n            text: t('cairo.toast.retry'),\n            onClick: onRetryClick,\n            removeToastOnClick: true,\n          },\n          ...(typeof errorToast === 'string'\n            ? { message: errorToast, biName: `cairo-error-toast` }\n            : errorToast),\n          type: 'ERROR',\n          details: requestId ? { requestId } : undefined,\n        };\n\n        if (toastConfig.action) {\n          toastConfig.action.uiType = 'LINK';\n          toastConfig.action.removeToastOnClick = true;\n        }\n\n        this.removeAndShowToast(toastConfig);\n      }\n\n      return { status: 'error', err };\n    }\n  }\n\n  async executePending<R>(params: ScheduleExecutionParams<A, R>) {\n    const { _actions: actions } = this;\n\n    this._actions = [];\n\n    return this._execute({\n      ...params,\n      actions,\n    });\n  }\n\n  execute<R>(actions: A[], params: ExecuteParams<A, R>) {\n    const {\n      showUndoToast,\n      showUndoSuccessToast,\n      successToast,\n      onRollback,\n      onUndo,\n    } = params;\n\n    this._actions = [...this._actions, ...actions];\n\n    const successToastState = this.getSuccessToast(actions, {\n      onRollback,\n      successToast,\n      showUndoToast,\n      showUndoSuccessToast,\n      onUndo,\n    });\n\n    this.scheduleExecution({\n      ...params,\n      successToastState,\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}