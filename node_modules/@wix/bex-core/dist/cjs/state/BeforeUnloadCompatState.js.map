{"version":3,"names":["BeforeUnloadCompatState","constructor","container","_defineProperty2","default","pause","onNavigationModal","translate","t","modalPropsList","_getBeforeUnloadListeners","length","resume","state","didCancel","confirmationsCount","onNavigationModalProps","Promise","resolve","modal","events","once","open","onConfirm","onClose","primaryButtonText","secondaryButtonText","forEach","onResume","listeners","map","l","filter","p","init","onNavigation","onBeforeUnload","onBeforeUnloadSubscription","event","preventDefault","remove","unloadDialog","e","returnValue","window","addEventListener","onNavigationSubscription","_onNavigation","removeEventListener","exports"],"sources":["../../../src/state/BeforeUnloadCompatState.ts"],"sourcesContent":["import { WixPatternsContainer } from './WixPatternsContainer';\nimport { ModalLayoutProps } from '../services';\nimport { OnNavigationCallback } from '../model';\n\nexport class BeforeUnloadCompatState {\n  readonly container: WixPatternsContainer;\n\n  constructor(container: WixPatternsContainer) {\n    this.container = container;\n  }\n\n  _onNavigation: OnNavigationCallback = async (pause) => {\n    const { onNavigationModal, translate: t } = this.container;\n    const modalPropsList = this._getBeforeUnloadListeners();\n\n    if (!modalPropsList.length) {\n      return;\n    }\n\n    const { resume } = pause();\n\n    const state = {\n      didCancel: false,\n      confirmationsCount: 0,\n    };\n\n    for (const onNavigationModalProps of modalPropsList) {\n      await new Promise<void>((resolve) => {\n        onNavigationModal.modal.events.once('close', () => resolve());\n        onNavigationModal.open({\n          ...onNavigationModalProps,\n          onConfirm: () => {\n            state.confirmationsCount++;\n            onNavigationModalProps?.onConfirm?.();\n          },\n          onClose: () => {\n            state.didCancel = true;\n          },\n          primaryButtonText: t('cairo.dragAndDrop.leaveSite.modal.leave.CTA'),\n          secondaryButtonText: t('cairo.cancel.button'),\n        });\n      });\n\n      // Skip rest of the modals when the user decides to cancel the navigation\n      if (state.didCancel) {\n        break;\n      }\n    }\n\n    // Resume navigation after all modals confirmed\n    if (state.confirmationsCount === modalPropsList.length) {\n      modalPropsList.forEach(({ onResume }) => onResume?.());\n      resume();\n    }\n  };\n\n  _getBeforeUnloadListeners() {\n    return this.container.events\n      .listeners('navigation')\n      .map((l) => l())\n      .filter((p): p is ModalLayoutProps => p != null);\n  }\n\n  init() {\n    const { onNavigation, onBeforeUnload } = this.container;\n\n    // In GizaProvider & BM that migrated to Giza, `onBeforeUnload` will be available (not possible to customize the modal)\n    if (onBeforeUnload) {\n      const onBeforeUnloadSubscription = onBeforeUnload((event) => {\n        if (!this._getBeforeUnloadListeners().length) {\n          return;\n        }\n\n        event.preventDefault();\n      });\n\n      return () => {\n        onBeforeUnloadSubscription.remove();\n      };\n    }\n\n    // In BM that didn't migrate to Giza, `onBeforeUnload` will be `undefined` due to `usePlatformApiCompat`\n    // `onNavigation` will be available (possible to customize the modal)\n    if (onNavigation) {\n      const unloadDialog = (e: BeforeUnloadEvent) => {\n        if (!this._getBeforeUnloadListeners().length) {\n          return;\n        }\n        e.preventDefault();\n        e.returnValue = '';\n      };\n\n      window.addEventListener('beforeunload', unloadDialog);\n      const onNavigationSubscription = onNavigation(this._onNavigation);\n\n      return () => {\n        window.removeEventListener('beforeunload', unloadDialog);\n        onNavigationSubscription.remove();\n      };\n    }\n\n    return;\n  }\n}\n"],"mappings":"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","ignoreList":[]}