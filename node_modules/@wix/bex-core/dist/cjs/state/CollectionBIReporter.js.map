{"version":3,"names":["_util","require","_v","_mobx","_events","withoutDefaults","withoutIrrelevant","CollectionBIReporter","constructor","params","_defineProperty2","default","EventEmitter","collection","reportBi","init","events","emitter","query","disposers","addEventListener","action","origin","cairoAllFiltersCleared","filterNames","activeFilters","map","filter","name","join","filteredListSize","result","total","numFiltersCleared","activeFiltersCount","prevSortedColumnId","sortedColumnId","prevSortedIds","Set","sort","value","field","prevSortOrder","_getSortOrder","prevSortingOrder","_getSortDirection","once","col","id","itemIndex","findIndex","cairoComponentSorted","newSortedColumn","newSortingOrder","prevSortedColumn","newSortOrder","isAddNewSort","has","prevNumSortingColumns","size","numSortingColumns","length","emit","startTime","performance","now","totalNewItems","loadMore","loadedItems","loadingTime","Math","round","searchTerm","search","cairoSearchResults","searchResultsCnt","asComputed","cairoFilterToggled","filterName","numFiltersActive","actionType","filterValue","forEach","d","columndId","find","direction","JSON","stringify","fieldName","order","exports"],"sources":["../../../src/state/CollectionBIReporter.ts"],"sourcesContent":["import { CollectionState } from './CollectionState';\nimport { addEventListener, TypedEmitter, withoutIrrelevant } from '../util';\nimport {\n  cairoComponentSorted,\n  cairoFilterToggled,\n  cairoAllFiltersCleared,\n  cairoSearchResults,\n  loadMore,\n} from '@wix/bex-utils/@wix/bi-logger-os-data/v2';\nimport { FiltersMap } from '../model';\nimport { ReportBI } from '../services';\nimport { action } from 'mobx';\nimport { EventEmitter } from 'events';\n\nconst withoutDefaults = withoutIrrelevant<\n  | 'currentTab'\n  | 'currentView'\n  | 'currentFilters'\n  | 'currentSortOrder'\n  | 'listSize'\n  | 'initialItems'\n>();\n\nexport interface CollectionBIReporterParams<T, F extends FiltersMap> {\n  readonly collection: CollectionState<T, F>;\n  readonly reportBi: ReportBI;\n}\n\nexport class CollectionBIReporter<T, F extends FiltersMap> {\n  readonly collection;\n  readonly reportBi;\n  readonly events = new EventEmitter() as TypedEmitter<{\n    sortStart: (params: { col: { id: string } }) => unknown;\n  }>;\n\n  sortedColumnId = '';\n\n  constructor(params: CollectionBIReporterParams<T, F>) {\n    this.collection = params.collection;\n    this.reportBi = params.reportBi;\n  }\n\n  init() {\n    const { collection, events } = this;\n    const { emitter, query } = collection;\n\n    const disposers = [\n      addEventListener(\n        emitter,\n        'beforeClearFilters',\n        action(({ origin }) => {\n          this.reportBi(\n            withoutDefaults(cairoAllFiltersCleared)({\n              filterNames: collection.query.activeFilters\n                .map((filter) => filter.name)\n                .join(','),\n              filteredListSize: collection.result.total,\n              numFiltersCleared: collection.query.activeFiltersCount,\n              origin,\n            }),\n          );\n        }),\n      ),\n\n      addEventListener(\n        emitter,\n        'beforeSortStart',\n        action(({ origin }) => {\n          const prevSortedColumnId = this.sortedColumnId;\n          const prevSortedIds = new Set(\n            query.sort.value.map(({ field }) => field),\n          );\n\n          const prevSortOrder = this._getSortOrder();\n          let prevSortingOrder = this._getSortDirection(prevSortedColumnId);\n\n          events.once('sortStart', ({ col }) => {\n            this.sortedColumnId = col.id;\n\n            if (prevSortedColumnId && col.id !== prevSortedColumnId) {\n              prevSortingOrder = this._getSortDirection(prevSortedColumnId);\n            } else if (!prevSortedColumnId) {\n              prevSortingOrder = '';\n            }\n\n            const itemIndex = this.collection.query.sort.value.findIndex(\n              ({ field }) => field === col.id,\n            );\n\n            this.reportBi(\n              withoutDefaults(cairoComponentSorted)({\n                newSortedColumn: col.id,\n                newSortingOrder: this._getSortDirection(col.id),\n                prevSortedColumn: prevSortedColumnId,\n                prevSortingOrder,\n                origin,\n                prevSortOrder,\n                newSortOrder: this._getSortOrder(),\n                itemIndex,\n                isAddNewSort: !prevSortedIds.has(col.id),\n                prevNumSortingColumns: prevSortedIds.size,\n                numSortingColumns: query.sort.value.length,\n              }),\n            );\n          });\n        }),\n      ),\n\n      addEventListener(emitter, 'sortStart', (params) => {\n        events.emit('sortStart', params);\n      }),\n\n      addEventListener(emitter, 'newPageStart', () => {\n        const startTime = performance.now();\n\n        return ({ totalNewItems }) => {\n          this.reportBi(\n            withoutDefaults(loadMore)({\n              loadedItems: totalNewItems,\n              loadingTime: Math.round(performance.now() - startTime),\n            }),\n          );\n        };\n      }),\n\n      addEventListener(emitter, 'searchStart', () => {\n        const startTime = performance.now();\n        const searchTerm = collection.query.search.value;\n        return () => {\n          this.reportBi(\n            withoutDefaults(cairoSearchResults)({\n              searchTerm,\n              searchResultsCnt: collection.result.asComputed.total,\n              loadingTime: Math.round(performance.now() - startTime),\n            }),\n          );\n        };\n      }),\n\n      addEventListener(\n        emitter,\n        'search',\n        action(() => {\n          this.reportBi(\n            withoutDefaults(cairoFilterToggled)({\n              filterName: 'search',\n              origin: 'toolbar',\n              numFiltersActive: collection.query.activeFiltersCount,\n              actionType: 'add',\n              filterValue: collection.query.search.value,\n              filteredListSize: collection.result.total,\n            }),\n          );\n        }),\n      ),\n    ];\n\n    return () => {\n      disposers.forEach((d) => d());\n    };\n  }\n\n  _getSortDirection(columndId?: string) {\n    const {\n      query: {\n        sort: { value },\n      },\n    } = this.collection;\n\n    const sort = value.find(({ field }) => field === columndId);\n\n    if (sort) {\n      return sort.direction;\n    }\n\n    return 'removed';\n  }\n\n  _getSortOrder() {\n    const {\n      query: { sort },\n    } = this.collection;\n\n    return JSON.stringify(\n      sort.value.map(({ field, direction }) => ({\n        fieldName: field,\n        order: direction,\n      })),\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}