{"version":3,"names":["_mobx","require","_CollectionState","_util","FetchTotalState","constructor","params","_defineProperty2","default","_collection","collection","errorMonitor","errorHandler","onlineState","history","translate","queryCache","lodash","queryName","itemKey","itemName","paginationMode","selectionConsistencyMode","filters","query","search","_totalsCollection","CollectionState","limit","fetchData","total","fetchTotal","items","id","makeObservable","computed","status","init","_collection$_optimist","disposers","_optimisticActions","initCollection","addEventListener","emitter","clearResultAndMoveToStart","refreshAllPages","refreshCurrentPage","forEach","disposer","result","lifecycleState","exports"],"sources":["../../../src/state/FetchTotalState.ts"],"sourcesContent":["import { computed, makeObservable } from 'mobx';\nimport { CollectionState } from './CollectionState';\nimport { addEventListener } from '../util';\nimport { QueryCache } from 'react-query';\nimport { ComputedQuery, FiltersMap, QueryStatusValue } from '../model';\n\nexport interface FetchTotalStateParams<T, F extends FiltersMap> {\n  readonly collection: CollectionState<T, F>;\n  readonly queryCache: QueryCache;\n  readonly fetchTotal: (query: ComputedQuery<F>) => Promise<number>;\n}\n\nexport class FetchTotalState<T, F extends FiltersMap> {\n  readonly _collection;\n  readonly _totalsCollection;\n\n  constructor(params: Readonly<FetchTotalStateParams<T, F>>) {\n    this._collection = params.collection;\n\n    const {\n      errorMonitor,\n      errorHandler,\n      onlineState,\n      history,\n      translate,\n      queryCache,\n      lodash,\n      queryName,\n      itemKey,\n      itemName,\n      paginationMode,\n      selectionConsistencyMode,\n      filters,\n      query: { search },\n    } = params.collection;\n\n    this._totalsCollection = new CollectionState<T, F>({\n      errorMonitor,\n      errorHandler,\n      onlineState,\n      history,\n      translate,\n      queryCache,\n      lodash,\n      queryName: `${queryName}.total`,\n      itemKey,\n      itemName,\n      limit: 1,\n      fetchData: async (query) => {\n        const total = await params.fetchTotal(query);\n        return { items: [], total };\n      },\n      paginationMode: paginationMode.id,\n      selectionConsistencyMode,\n      filters,\n      search,\n    });\n\n    makeObservable(this, {\n      total: computed,\n      status: computed,\n    });\n  }\n\n  init() {\n    const { _collection, _totalsCollection } = this;\n\n    const disposers = [\n      _totalsCollection.init(),\n      _collection._optimisticActions?.initCollection(_totalsCollection),\n      addEventListener(_collection.emitter, 'search', () => {\n        _totalsCollection.clearResultAndMoveToStart();\n      }),\n      addEventListener(\n        _collection.emitter,\n        'clearSearch',\n        _totalsCollection.clearResultAndMoveToStart,\n      ),\n      addEventListener(\n        _collection.emitter,\n        'refreshAllPages',\n        _totalsCollection.refreshAllPages,\n      ),\n      addEventListener(\n        _collection.emitter,\n        'refreshCurrentPage',\n        _totalsCollection.refreshCurrentPage,\n      ),\n    ];\n\n    return () => {\n      disposers.forEach((disposer) => disposer?.());\n    };\n  }\n\n  get total(): number {\n    return this._totalsCollection.result.total;\n  }\n\n  get status(): QueryStatusValue {\n    // While refreshing the status remains as success\n    return this._totalsCollection.lifecycleState === 'refresh'\n      ? 'loading'\n      : this._totalsCollection.result.status.status;\n  }\n}\n"],"mappings":";;;;;;AAAA,IAAAA,KAAA,GAAAC,OAAA;AACA,IAAAC,gBAAA,GAAAD,OAAA;AACA,IAAAE,KAAA,GAAAF,OAAA;AAUO,MAAMG,eAAe,CAA0B;EAIpDC,WAAWA,CAACC,MAA6C,EAAE;IAAA,IAAAC,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IACzD,IAAI,CAACC,WAAW,GAAGH,MAAM,CAACI,UAAU;IAEpC,MAAM;MACJC,YAAY;MACZC,YAAY;MACZC,WAAW;MACXC,OAAO;MACPC,SAAS;MACTC,UAAU;MACVC,MAAM;MACNC,SAAS;MACTC,OAAO;MACPC,QAAQ;MACRC,cAAc;MACdC,wBAAwB;MACxBC,OAAO;MACPC,KAAK,EAAE;QAAEC;MAAO;IAClB,CAAC,GAAGnB,MAAM,CAACI,UAAU;IAErB,IAAI,CAACgB,iBAAiB,GAAG,IAAIC,gCAAe,CAAO;MACjDhB,YAAY;MACZC,YAAY;MACZC,WAAW;MACXC,OAAO;MACPC,SAAS;MACTC,UAAU;MACVC,MAAM;MACNC,SAAS,EAAE,GAAGA,SAAS,QAAQ;MAC/BC,OAAO;MACPC,QAAQ;MACRQ,KAAK,EAAE,CAAC;MACRC,SAAS,EAAE,MAAOL,KAAK,IAAK;QAC1B,MAAMM,KAAK,GAAG,MAAMxB,MAAM,CAACyB,UAAU,CAACP,KAAK,CAAC;QAC5C,OAAO;UAAEQ,KAAK,EAAE,EAAE;UAAEF;QAAM,CAAC;MAC7B,CAAC;MACDT,cAAc,EAAEA,cAAc,CAACY,EAAE;MACjCX,wBAAwB;MACxBC,OAAO;MACPE;IACF,CAAC,CAAC;IAEF,IAAAS,oBAAc,EAAC,IAAI,EAAE;MACnBJ,KAAK,EAAEK,cAAQ;MACfC,MAAM,EAAED;IACV,CAAC,CAAC;EACJ;EAEAE,IAAIA,CAAA,EAAG;IAAA,IAAAC,qBAAA;IACL,MAAM;MAAE7B,WAAW;MAAEiB;IAAkB,CAAC,GAAG,IAAI;IAE/C,MAAMa,SAAS,GAAG,CAChBb,iBAAiB,CAACW,IAAI,CAAC,CAAC,GAAAC,qBAAA,GACxB7B,WAAW,CAAC+B,kBAAkB,qBAA9BF,qBAAA,CAAgCG,cAAc,CAACf,iBAAiB,CAAC,EACjE,IAAAgB,sBAAgB,EAACjC,WAAW,CAACkC,OAAO,EAAE,QAAQ,EAAE,MAAM;MACpDjB,iBAAiB,CAACkB,yBAAyB,CAAC,CAAC;IAC/C,CAAC,CAAC,EACF,IAAAF,sBAAgB,EACdjC,WAAW,CAACkC,OAAO,EACnB,aAAa,EACbjB,iBAAiB,CAACkB,yBACpB,CAAC,EACD,IAAAF,sBAAgB,EACdjC,WAAW,CAACkC,OAAO,EACnB,iBAAiB,EACjBjB,iBAAiB,CAACmB,eACpB,CAAC,EACD,IAAAH,sBAAgB,EACdjC,WAAW,CAACkC,OAAO,EACnB,oBAAoB,EACpBjB,iBAAiB,CAACoB,kBACpB,CAAC,CACF;IAED,OAAO,MAAM;MACXP,SAAS,CAACQ,OAAO,CAAEC,QAAQ,IAAKA,QAAQ,oBAARA,QAAQ,CAAG,CAAC,CAAC;IAC/C,CAAC;EACH;EAEA,IAAIlB,KAAKA,CAAA,EAAW;IAClB,OAAO,IAAI,CAACJ,iBAAiB,CAACuB,MAAM,CAACnB,KAAK;EAC5C;EAEA,IAAIM,MAAMA,CAAA,EAAqB;IAC7B;IACA,OAAO,IAAI,CAACV,iBAAiB,CAACwB,cAAc,KAAK,SAAS,GACtD,SAAS,GACT,IAAI,CAACxB,iBAAiB,CAACuB,MAAM,CAACb,MAAM,CAACA,MAAM;EACjD;AACF;AAACe,OAAA,CAAA/C,eAAA,GAAAA,eAAA","ignoreList":[]}