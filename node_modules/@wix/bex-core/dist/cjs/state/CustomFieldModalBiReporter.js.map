{"version":3,"names":["_util","require","_v","_mobx","_DataExtensionStateBIReporter","CustomFieldModalBiReporter","constructor","params","_defineProperty2","default","origin","customOrigin","reportBi","withoutDefaults","cairoDataExAddCustomField","actionName","cairoDataExCustomFieldAdvancesSettings","cairoLearnMore","endType","$","name","type","key","form","customFieldModalState","dataExtensionState","cairoDataExCustomFieldEndProcess","mode","fieldName","value","fieldType","numAdded","availableUserCustomFields","length","changedFields","getBiChangedFields","permissions","getBiPermissions","getFormValues","cairoDataExtensionUnsuccessfulUpdateInServer","errorType","reportTypeFormFieldChange","createReportFormFieldChange","fieldValue","reportNameFormFieldChange","reportKeyFormFieldChange","reportPermissionFormFieldChange","lodash","debounce","container","cairoChangesBeforeApply","feature","isClearButton","leading","trailing","prevValues","formSnapshot","undefined","nextValues","changes","push","readApps","readUsers","writeApps","writeUsers","join","biReporter","DataExtensionStateBIReporter","init","disposes","reaction","forEach","disposer","exports"],"sources":["../../../src/state/CustomFieldModalBiReporter.ts"],"sourcesContent":["import {\n  CustomFieldForm,\n  CustomFieldModalState,\n} from './CustomFieldModalState';\nimport { withoutDefaults } from '../util';\nimport {\n  cairoChangesBeforeApply,\n  cairoDataExAddCustomField,\n  cairoDataExCustomFieldAdvancesSettings,\n  cairoDataExCustomFieldEndProcess,\n  cairoDataExtensionUnsuccessfulUpdateInServer,\n  cairoLearnMore,\n} from '@wix/bex-utils/@wix/bi-logger-os-data/v2';\nimport { reaction } from 'mobx';\nimport { DataExtensionStateBIReporter } from './DataExtensionStateBIReporter';\nimport { CustomFieldOrigin } from '../services';\n\nexport interface CustomFieldModalBiReporterParams {\n  customFieldModalState: CustomFieldModalState;\n}\n\nexport class CustomFieldModalBiReporter {\n  customFieldModalState: CustomFieldModalState;\n  formSnapshot: CustomFieldForm | null = null;\n\n  reportTypeFormFieldChange;\n  reportNameFormFieldChange;\n  reportKeyFormFieldChange;\n  reportPermissionFormFieldChange;\n\n  constructor(params: CustomFieldModalBiReporterParams) {\n    this.customFieldModalState = params.customFieldModalState;\n\n    this.reportTypeFormFieldChange = this.createReportFormFieldChange({\n      fieldName: 'Type',\n      fieldValue: () => this.form.$.type.value,\n    });\n\n    this.reportNameFormFieldChange = this.createReportFormFieldChange({\n      fieldName: 'Name',\n      fieldValue: () => this.form.$.name.value,\n    });\n\n    this.reportKeyFormFieldChange = this.createReportFormFieldChange({\n      fieldName: 'Key',\n      fieldValue: () => this.form.$.key.value,\n    });\n\n    this.reportPermissionFormFieldChange = this.createReportFormFieldChange({\n      fieldName: 'Permission',\n      fieldValue: () => this.getBiPermissions(),\n    });\n  }\n\n  private get reportBi() {\n    return this.customFieldModalState.reportBi;\n  }\n\n  get form() {\n    return this.customFieldModalState.form;\n  }\n\n  get mode() {\n    return this.customFieldModalState.mode;\n  }\n\n  get origin() {\n    return this.mode === 'new'\n      ? 'Add Custom Field Modal'\n      : 'Edit Custom Field Modal';\n  }\n\n  private createReportFormFieldChange({\n    fieldName,\n    fieldValue,\n  }: {\n    fieldName: string;\n    fieldValue: () => string | undefined;\n  }) {\n    const {\n      lodash: { debounce },\n    } = this.customFieldModalState.dataExtensionState.container;\n\n    return debounce(\n      () =>\n        this.reportBi(\n          withoutDefaults(cairoChangesBeforeApply)({\n            feature:\n              this.mode === 'new' ? 'Add Custom Field' : 'Edit Custom Field',\n            fieldName,\n            fieldValue: fieldValue(),\n            isClearButton: false,\n          }),\n        ),\n      1500,\n      { leading: false, trailing: true },\n    );\n  }\n\n  reportAddCustomField = ({\n    origin,\n    customOrigin,\n  }: {\n    origin: CustomFieldOrigin;\n    customOrigin?: string;\n  }) => {\n    this.reportBi(\n      withoutDefaults(cairoDataExAddCustomField)({\n        origin,\n        customOrigin,\n      }),\n    );\n  };\n\n  reportAdvancedSettingsClick = (actionName: 'Open' | 'Close') => {\n    this.reportBi(\n      withoutDefaults(cairoDataExCustomFieldAdvancesSettings)({\n        origin: this.origin,\n        actionName,\n      }),\n    );\n  };\n\n  reportLearnMoreClick = () => {\n    this.reportBi(\n      withoutDefaults(cairoLearnMore)({\n        origin: this.origin,\n      }),\n    );\n  };\n\n  reportModalEndProcess = (params: { endType: 'Cancel' | 'Add Field' }) => {\n    const { endType } = params;\n    const {\n      $: { name, type, key },\n    } = this.form;\n    const {\n      customFieldModalState: { origin, customOrigin, dataExtensionState },\n    } = this;\n\n    this.reportBi(\n      withoutDefaults(cairoDataExCustomFieldEndProcess)({\n        actionName: this.mode === 'new' ? 'Add' : 'Edit',\n        endType,\n        fieldName: name.value,\n        fieldType: type.value,\n        key: key.value,\n        numAdded: dataExtensionState.availableUserCustomFields.length,\n        changedFields: this.getBiChangedFields(),\n        permissions: this.getBiPermissions(),\n        origin,\n        customOrigin,\n      }),\n    );\n  };\n\n  reportSubmitFailure = (params: { errorType: string | undefined }) => {\n    const { customFieldModalState } = this;\n\n    const { type, name, key } = customFieldModalState.getFormValues();\n\n    this.reportBi(\n      withoutDefaults(cairoDataExtensionUnsuccessfulUpdateInServer)({\n        actionName: this.mode === 'new' ? 'Add' : 'Edit',\n        errorType: params.errorType,\n        origin: customFieldModalState.origin,\n        permissions: this.getBiPermissions(),\n        fieldType: type,\n        fieldName: name,\n        key,\n      }),\n    );\n  };\n\n  getBiChangedFields() {\n    const prevValues = this.formSnapshot;\n\n    if (this.mode === 'new' || !prevValues) {\n      return undefined;\n    }\n\n    const nextValues = this.customFieldModalState.getFormValues();\n    const changes = [];\n\n    if (prevValues.name !== nextValues.name) {\n      changes.push('Name');\n    }\n\n    if (\n      prevValues.readApps !== nextValues.readApps ||\n      prevValues.readUsers !== nextValues.readUsers ||\n      prevValues.writeApps !== nextValues.writeApps ||\n      prevValues.writeUsers !== nextValues.writeUsers\n    ) {\n      changes.push('Permission');\n    }\n\n    if (changes.length !== 0) {\n      return changes.join(',');\n    }\n\n    return 'No changes';\n  }\n\n  getBiPermissions() {\n    const biReporter = new DataExtensionStateBIReporter({\n      reportBi: this.reportBi,\n    });\n    return biReporter.getBiPermissions(\n      this.customFieldModalState.getFormValues(),\n    );\n  }\n\n  init() {\n    const {\n      customFieldModalState: { form },\n    } = this;\n\n    const disposes = [\n      reaction(\n        () => form.$.name.value,\n        () => {\n          this.reportNameFormFieldChange();\n        },\n      ),\n      reaction(\n        () => form.$.type.value,\n        () => {\n          this.reportTypeFormFieldChange();\n        },\n      ),\n      reaction(\n        () => ({\n          readUsers: form.$.readUsers.value,\n          readApps: form.$.readApps.value,\n          writeUsers: form.$.writeUsers.value,\n          writeApps: form.$.writeApps.value,\n        }),\n        () => {\n          this.reportPermissionFormFieldChange();\n        },\n      ),\n    ];\n\n    return () => {\n      disposes.forEach((disposer) => {\n        disposer?.();\n      });\n    };\n  }\n}\n"],"mappings":";;;;;;AAIA,IAAAA,KAAA,GAAAC,OAAA;AACA,IAAAC,EAAA,GAAAD,OAAA;AAQA,IAAAE,KAAA,GAAAF,OAAA;AACA,IAAAG,6BAAA,GAAAH,OAAA;AAOO,MAAMI,0BAA0B,CAAC;EAStCC,WAAWA,CAACC,OAAwC,EAAE;IAAA,IAAAC,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA,wBAPf,IAAI;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA,gCA4EpB,CAAC;MACtBC,MAAM;MACNC;IAIF,CAAC,KAAK;MACJ,IAAI,CAACC,QAAQ,CACX,IAAAC,qBAAe,EAACC,4BAAyB,CAAC,CAAC;QACzCJ,MAAM;QACNC;MACF,CAAC,CACH,CAAC;IACH,CAAC;IAAA,IAAAH,gBAAA,CAAAC,OAAA,uCAE8BM,UAA4B,IAAK;MAC9D,IAAI,CAACH,QAAQ,CACX,IAAAC,qBAAe,EAACG,yCAAsC,CAAC,CAAC;QACtDN,MAAM,EAAE,IAAI,CAACA,MAAM;QACnBK;MACF,CAAC,CACH,CAAC;IACH,CAAC;IAAA,IAAAP,gBAAA,CAAAC,OAAA,gCAEsB,MAAM;MAC3B,IAAI,CAACG,QAAQ,CACX,IAAAC,qBAAe,EAACI,iBAAc,CAAC,CAAC;QAC9BP,MAAM,EAAE,IAAI,CAACA;MACf,CAAC,CACH,CAAC;IACH,CAAC;IAAA,IAAAF,gBAAA,CAAAC,OAAA,iCAEwBF,MAA2C,IAAK;MACvE,MAAM;QAAEW;MAAQ,CAAC,GAAGX,MAAM;MAC1B,MAAM;QACJY,CAAC,EAAE;UAAEC,IAAI;UAAEC,IAAI;UAAEC;QAAI;MACvB,CAAC,GAAG,IAAI,CAACC,IAAI;MACb,MAAM;QACJC,qBAAqB,EAAE;UAAEd,MAAM;UAAEC,YAAY;UAAEc;QAAmB;MACpE,CAAC,GAAG,IAAI;MAER,IAAI,CAACb,QAAQ,CACX,IAAAC,qBAAe,EAACa,mCAAgC,CAAC,CAAC;QAChDX,UAAU,EAAE,IAAI,CAACY,IAAI,KAAK,KAAK,GAAG,KAAK,GAAG,MAAM;QAChDT,OAAO;QACPU,SAAS,EAAER,IAAI,CAACS,KAAK;QACrBC,SAAS,EAAET,IAAI,CAACQ,KAAK;QACrBP,GAAG,EAAEA,GAAG,CAACO,KAAK;QACdE,QAAQ,EAAEN,kBAAkB,CAACO,yBAAyB,CAACC,MAAM;QAC7DC,aAAa,EAAE,IAAI,CAACC,kBAAkB,CAAC,CAAC;QACxCC,WAAW,EAAE,IAAI,CAACC,gBAAgB,CAAC,CAAC;QACpC3B,MAAM;QACNC;MACF,CAAC,CACH,CAAC;IACH,CAAC;IAAA,IAAAH,gBAAA,CAAAC,OAAA,+BAEsBF,MAAyC,IAAK;MACnE,MAAM;QAAEiB;MAAsB,CAAC,GAAG,IAAI;MAEtC,MAAM;QAAEH,IAAI;QAAED,IAAI;QAAEE;MAAI,CAAC,GAAGE,qBAAqB,CAACc,aAAa,CAAC,CAAC;MAEjE,IAAI,CAAC1B,QAAQ,CACX,IAAAC,qBAAe,EAAC0B,+CAA4C,CAAC,CAAC;QAC5DxB,UAAU,EAAE,IAAI,CAACY,IAAI,KAAK,KAAK,GAAG,KAAK,GAAG,MAAM;QAChDa,SAAS,EAAEjC,MAAM,CAACiC,SAAS;QAC3B9B,MAAM,EAAEc,qBAAqB,CAACd,MAAM;QACpC0B,WAAW,EAAE,IAAI,CAACC,gBAAgB,CAAC,CAAC;QACpCP,SAAS,EAAET,IAAI;QACfO,SAAS,EAAER,IAAI;QACfE;MACF,CAAC,CACH,CAAC;IACH,CAAC;IA7IC,IAAI,CAACE,qBAAqB,GAAGjB,OAAM,CAACiB,qBAAqB;IAEzD,IAAI,CAACiB,yBAAyB,GAAG,IAAI,CAACC,2BAA2B,CAAC;MAChEd,SAAS,EAAE,MAAM;MACjBe,UAAU,EAAEA,CAAA,KAAM,IAAI,CAACpB,IAAI,CAACJ,CAAC,CAACE,IAAI,CAACQ;IACrC,CAAC,CAAC;IAEF,IAAI,CAACe,yBAAyB,GAAG,IAAI,CAACF,2BAA2B,CAAC;MAChEd,SAAS,EAAE,MAAM;MACjBe,UAAU,EAAEA,CAAA,KAAM,IAAI,CAACpB,IAAI,CAACJ,CAAC,CAACC,IAAI,CAACS;IACrC,CAAC,CAAC;IAEF,IAAI,CAACgB,wBAAwB,GAAG,IAAI,CAACH,2BAA2B,CAAC;MAC/Dd,SAAS,EAAE,KAAK;MAChBe,UAAU,EAAEA,CAAA,KAAM,IAAI,CAACpB,IAAI,CAACJ,CAAC,CAACG,GAAG,CAACO;IACpC,CAAC,CAAC;IAEF,IAAI,CAACiB,+BAA+B,GAAG,IAAI,CAACJ,2BAA2B,CAAC;MACtEd,SAAS,EAAE,YAAY;MACvBe,UAAU,EAAEA,CAAA,KAAM,IAAI,CAACN,gBAAgB,CAAC;IAC1C,CAAC,CAAC;EACJ;EAEA,IAAYzB,QAAQA,CAAA,EAAG;IACrB,OAAO,IAAI,CAACY,qBAAqB,CAACZ,QAAQ;EAC5C;EAEA,IAAIW,IAAIA,CAAA,EAAG;IACT,OAAO,IAAI,CAACC,qBAAqB,CAACD,IAAI;EACxC;EAEA,IAAII,IAAIA,CAAA,EAAG;IACT,OAAO,IAAI,CAACH,qBAAqB,CAACG,IAAI;EACxC;EAEA,IAAIjB,MAAMA,CAAA,EAAG;IACX,OAAO,IAAI,CAACiB,IAAI,KAAK,KAAK,GACtB,wBAAwB,GACxB,yBAAyB;EAC/B;EAEQe,2BAA2BA,CAAC;IAClCd,SAAS;IACTe;EAIF,CAAC,EAAE;IACD,MAAM;MACJI,MAAM,EAAE;QAAEC;MAAS;IACrB,CAAC,GAAG,IAAI,CAACxB,qBAAqB,CAACC,kBAAkB,CAACwB,SAAS;IAE3D,OAAOD,QAAQ,CACb,MACE,IAAI,CAACpC,QAAQ,CACX,IAAAC,qBAAe,EAACqC,0BAAuB,CAAC,CAAC;MACvCC,OAAO,EACL,IAAI,CAACxB,IAAI,KAAK,KAAK,GAAG,kBAAkB,GAAG,mBAAmB;MAChEC,SAAS;MACTe,UAAU,EAAEA,UAAU,CAAC,CAAC;MACxBS,aAAa,EAAE;IACjB,CAAC,CACH,CAAC,EACH,IAAI,EACJ;MAAEC,OAAO,EAAE,KAAK;MAAEC,QAAQ,EAAE;IAAK,CACnC,CAAC;EACH;EA6EAnB,kBAAkBA,CAAA,EAAG;IACnB,MAAMoB,UAAU,GAAG,IAAI,CAACC,YAAY;IAEpC,IAAI,IAAI,CAAC7B,IAAI,KAAK,KAAK,IAAI,CAAC4B,UAAU,EAAE;MACtC,OAAOE,SAAS;IAClB;IAEA,MAAMC,UAAU,GAAG,IAAI,CAAClC,qBAAqB,CAACc,aAAa,CAAC,CAAC;IAC7D,MAAMqB,OAAO,GAAG,EAAE;IAElB,IAAIJ,UAAU,CAACnC,IAAI,KAAKsC,UAAU,CAACtC,IAAI,EAAE;MACvCuC,OAAO,CAACC,IAAI,CAAC,MAAM,CAAC;IACtB;IAEA,IACEL,UAAU,CAACM,QAAQ,KAAKH,UAAU,CAACG,QAAQ,IAC3CN,UAAU,CAACO,SAAS,KAAKJ,UAAU,CAACI,SAAS,IAC7CP,UAAU,CAACQ,SAAS,KAAKL,UAAU,CAACK,SAAS,IAC7CR,UAAU,CAACS,UAAU,KAAKN,UAAU,CAACM,UAAU,EAC/C;MACAL,OAAO,CAACC,IAAI,CAAC,YAAY,CAAC;IAC5B;IAEA,IAAID,OAAO,CAAC1B,MAAM,KAAK,CAAC,EAAE;MACxB,OAAO0B,OAAO,CAACM,IAAI,CAAC,GAAG,CAAC;IAC1B;IAEA,OAAO,YAAY;EACrB;EAEA5B,gBAAgBA,CAAA,EAAG;IACjB,MAAM6B,UAAU,GAAG,IAAIC,0DAA4B,CAAC;MAClDvD,QAAQ,EAAE,IAAI,CAACA;IACjB,CAAC,CAAC;IACF,OAAOsD,UAAU,CAAC7B,gBAAgB,CAChC,IAAI,CAACb,qBAAqB,CAACc,aAAa,CAAC,CAC3C,CAAC;EACH;EAEA8B,IAAIA,CAAA,EAAG;IACL,MAAM;MACJ5C,qBAAqB,EAAE;QAAED;MAAK;IAChC,CAAC,GAAG,IAAI;IAER,MAAM8C,QAAQ,GAAG,CACf,IAAAC,cAAQ,EACN,MAAM/C,IAAI,CAACJ,CAAC,CAACC,IAAI,CAACS,KAAK,EACvB,MAAM;MACJ,IAAI,CAACe,yBAAyB,CAAC,CAAC;IAClC,CACF,CAAC,EACD,IAAA0B,cAAQ,EACN,MAAM/C,IAAI,CAACJ,CAAC,CAACE,IAAI,CAACQ,KAAK,EACvB,MAAM;MACJ,IAAI,CAACY,yBAAyB,CAAC,CAAC;IAClC,CACF,CAAC,EACD,IAAA6B,cAAQ,EACN,OAAO;MACLR,SAAS,EAAEvC,IAAI,CAACJ,CAAC,CAAC2C,SAAS,CAACjC,KAAK;MACjCgC,QAAQ,EAAEtC,IAAI,CAACJ,CAAC,CAAC0C,QAAQ,CAAChC,KAAK;MAC/BmC,UAAU,EAAEzC,IAAI,CAACJ,CAAC,CAAC6C,UAAU,CAACnC,KAAK;MACnCkC,SAAS,EAAExC,IAAI,CAACJ,CAAC,CAAC4C,SAAS,CAAClC;IAC9B,CAAC,CAAC,EACF,MAAM;MACJ,IAAI,CAACiB,+BAA+B,CAAC,CAAC;IACxC,CACF,CAAC,CACF;IAED,OAAO,MAAM;MACXuB,QAAQ,CAACE,OAAO,CAAEC,QAAQ,IAAK;QAC7BA,QAAQ,YAARA,QAAQ,CAAG,CAAC;MACd,CAAC,CAAC;IACJ,CAAC;EACH;AACF;AAACC,OAAA,CAAApE,0BAAA,GAAAA,0BAAA","ignoreList":[]}