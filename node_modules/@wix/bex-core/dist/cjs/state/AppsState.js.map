{"version":3,"names":["_TaskState","require","_mobx","_http","AppsState","constructor","params","_defineProperty2","default","TaskState","container","dataExtension","makeObservable","apps","observable","ref","appNames","computed","init","initTask","runOnce","status","promise","appIds","appSchemas","map","schema","appDefId","filter","Boolean","_fetchApps","length","appRequests","_getAppsRequests","responses","Promise","allSettled","allApps","_aggregateAppsFromResponses","runInAction","sort","_sortByEnglishFirst","reduce","_extractAppNames","a","b","languageCode","acc","app","_app$basicInfo","appId","basicInfo","name","batchSize","numBatches","Math","ceil","batchRequests","i","batchAppIds","slice","request","errorHandler","withErrorHandler","httpClient","queryMarketListing","query","environment","language","errorCodesMap","push","forEach","response","data","marketListing","value","exports"],"sources":["../../../src/state/AppsState.ts"],"sourcesContent":["import { TaskState } from './TaskState';\nimport { computed, makeObservable, observable, runInAction } from 'mobx';\nimport { WixPatternsContainer } from './WixPatternsContainer';\nimport { queryMarketListing } from '@wix/bex-utils/@wix/ambassador-devcenter-app-market-listing-v1-market-listing/http';\nimport {\n  MarketListing,\n  QueryMarketListingResponse,\n} from '@wix/bex-utils/@wix/ambassador-devcenter-app-market-listing-v1-market-listing/types';\nimport { DataExtensionState } from './DataExtensionState';\n\nexport interface AppsStateParams {\n  container: WixPatternsContainer;\n  dataExtension: DataExtensionState;\n}\n\nexport class AppsState {\n  readonly initTask = new TaskState();\n  readonly container: WixPatternsContainer;\n  readonly dataExtension;\n\n  apps: MarketListing[] = [];\n\n  constructor(params: Readonly<AppsStateParams>) {\n    this.container = params.container;\n    this.dataExtension = params.dataExtension;\n\n    makeObservable(this, {\n      apps: observable.ref,\n      appNames: computed,\n    });\n  }\n\n  init() {\n    const { initTask, dataExtension } = this;\n\n    initTask.runOnce(async () => {\n      await dataExtension.initTask.status.promise;\n      const appIds = (dataExtension.appSchemas || [])\n        .map((schema) => schema.appDefId)\n        .filter(Boolean) as string[];\n\n      await this._fetchApps(appIds);\n    });\n\n    return () => {};\n  }\n\n  async _fetchApps(appIds: string[]) {\n    if (!appIds.length) {\n      return;\n    }\n\n    const appRequests = this._getAppsRequests(appIds);\n\n    // Don't care if one of the requests fails, we want to have as many apps as possible\n    const responses = await Promise.allSettled(appRequests);\n    const allApps = this._aggregateAppsFromResponses(responses);\n    runInAction(() => {\n      this.apps = allApps;\n    });\n  }\n\n  get appNames(): Record<string, string> {\n    // Prioritize English, allowing other languages to override it.\n    return this.apps\n      .sort(this._sortByEnglishFirst)\n      .reduce(this._extractAppNames, {});\n  }\n\n  private _sortByEnglishFirst(a: MarketListing, b: MarketListing): number {\n    if (a.languageCode === 'en' && b.languageCode !== 'en') {\n      return -1;\n    } else if (a.languageCode !== 'en' && b.languageCode === 'en') {\n      return 1;\n    } else {\n      return 0;\n    }\n  }\n\n  private _extractAppNames(\n    acc: Record<string, string>,\n    app: MarketListing,\n  ): Record<string, string> {\n    if (app.appId && app.basicInfo?.name) {\n      acc[app.appId] = app.basicInfo.name;\n    }\n    return acc;\n  }\n\n  private _getAppsRequests(appIds: string[]) {\n    // Call the API with batches of 50, since the limit is 100, and we get two languages per app (the requested one + english)\n    const batchSize = 50;\n    const numBatches = Math.ceil(appIds.length / batchSize);\n\n    const batchRequests = [];\n\n    for (let i = 0; i < numBatches; i++) {\n      const batchAppIds = appIds.slice(i * batchSize, (i + 1) * batchSize);\n      const request = this.container.errorHandler.withErrorHandler(\n        () =>\n          this.container.httpClient.request(\n            queryMarketListing({\n              query: {\n                filter: {\n                  appId: batchAppIds,\n                  languageCode: [this.container.environment.language, 'en'],\n                  status: 'APPROVED',\n                },\n              },\n            }),\n          ),\n        { errorCodesMap: {} },\n      );\n      batchRequests.push(request);\n    }\n\n    return batchRequests;\n  }\n\n  private _aggregateAppsFromResponses(\n    responses: PromiseSettledResult<{\n      data: QueryMarketListingResponse;\n      status: number;\n      statusText: string;\n      headers: Record<string, string | undefined>;\n    }>[],\n  ) {\n    const allApps: MarketListing[] = [];\n\n    responses.forEach((response) => {\n      if (response.status === 'fulfilled') {\n        const {\n          data: { marketListing: apps },\n        } = response.value;\n        if (apps) {\n          allApps.push(...apps);\n        }\n      }\n    });\n\n    return allApps;\n  }\n}\n"],"mappings":"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","ignoreList":[]}