{"version":3,"names":["mergePatchedItems","toMerge","page","itemKey","orders","itemPredicate","itemsToMerge","all","pageWithPatchedItemsMapTmp","Map","key","item","optimisticPatch","Array","from","entries","keepPosition","originalItems","originalItem","get","length","set","pageWithPatchedItemsMap","created","keys","has","delete","toInsert","orderByItem","values"],"sources":["../../../../src/state/optimistic-simulation/mergePatchedItems.ts"],"sourcesContent":["import { Order } from '../QueryResultSimulation';\nimport { OptimisticPatch } from '../CollectionOptimisticPatch';\n\nexport function mergePatchedItems<T>(\n  toMerge: {\n    all: Map<string, { item: T; optimisticPatch: OptimisticPatch<T> }>;\n    created: Map<string, { item: T; optimisticPatch: OptimisticPatch<T> }>;\n  },\n  {\n    page,\n    itemKey,\n    orders,\n    itemPredicate,\n  }: {\n    page: T[];\n    limit: number;\n    itemKey: (item: T) => string;\n    orders: Order<T>[];\n    itemPredicate: (item: T) => boolean;\n  },\n) {\n  const itemsToMerge = toMerge.all;\n\n  // merge items into page. replace if already exists in page. order by original if `keepPosition=true`\n  const pageWithPatchedItemsMapTmp = new Map<\n    string,\n    { item: T; orderByItem?: T }\n  >();\n\n  for (const [key, { item, optimisticPatch }] of Array.from(\n    itemsToMerge.entries(),\n  )) {\n    const { keepPosition, originalItems } = optimisticPatch;\n    const originalItem = originalItems.get(key);\n    // if `order` is empty (can't simulate ordering) and keepPosition=true and item didn't match current filtering before update\n    // skip on pushing the item into the page\n    if (\n      !orders.length &&\n      keepPosition &&\n      originalItem != null &&\n      itemPredicate(originalItem)\n    ) {\n      continue;\n    }\n\n    if (!itemPredicate(item)) {\n      continue;\n    }\n\n    pageWithPatchedItemsMapTmp.set(key, { item });\n  }\n\n  // place \"type=createMany\" items first\n  const pageWithPatchedItemsMap = new Map<\n    string,\n    { item: T; orderByItem?: T }\n  >();\n\n  for (const key of toMerge.created.keys()) {\n    if (pageWithPatchedItemsMapTmp.has(key)) {\n      pageWithPatchedItemsMap.set(key, {\n        item: pageWithPatchedItemsMapTmp.get(key)!.item,\n      });\n      pageWithPatchedItemsMapTmp.delete(key);\n    }\n  }\n\n  for (const [key, { item }] of Array.from(\n    pageWithPatchedItemsMapTmp.entries(),\n  )) {\n    pageWithPatchedItemsMap.set(key, { item });\n  }\n\n  for (const item of page) {\n    const key = itemKey(item);\n    const toInsert = itemsToMerge.get(key);\n\n    if (toInsert && toInsert.optimisticPatch.keepPosition) {\n      pageWithPatchedItemsMap.delete(key);\n      pageWithPatchedItemsMap.set(key, {\n        item: toInsert.item,\n        orderByItem: item,\n      });\n    } else if (!toInsert) {\n      pageWithPatchedItemsMap.set(key, { item });\n    }\n  }\n\n  return Array.from(pageWithPatchedItemsMap.values());\n}\n"],"mappings":";;;;AAGO,SAASA,iBAAiBA,CAC/BC,OAGC,EACD;EACEC,IAAI;EACJC,OAAO;EACPC,MAAM;EACNC;AAOF,CAAC,EACD;EACA,MAAMC,YAAY,GAAGL,OAAO,CAACM,GAAG;;EAEhC;EACA,MAAMC,0BAA0B,GAAG,IAAIC,GAAG,CAGxC,CAAC;EAEH,KAAK,MAAM,CAACC,GAAG,EAAE;IAAEC,IAAI;IAAEC;EAAgB,CAAC,CAAC,IAAIC,KAAK,CAACC,IAAI,CACvDR,YAAY,CAACS,OAAO,CAAC,CACvB,CAAC,EAAE;IACD,MAAM;MAAEC,YAAY;MAAEC;IAAc,CAAC,GAAGL,eAAe;IACvD,MAAMM,YAAY,GAAGD,aAAa,CAACE,GAAG,CAACT,GAAG,CAAC;IAC3C;IACA;IACA,IACE,CAACN,MAAM,CAACgB,MAAM,IACdJ,YAAY,IACZE,YAAY,IAAI,IAAI,IACpBb,aAAa,CAACa,YAAY,CAAC,EAC3B;MACA;IACF;IAEA,IAAI,CAACb,aAAa,CAACM,IAAI,CAAC,EAAE;MACxB;IACF;IAEAH,0BAA0B,CAACa,GAAG,CAACX,GAAG,EAAE;MAAEC;IAAK,CAAC,CAAC;EAC/C;;EAEA;EACA,MAAMW,uBAAuB,GAAG,IAAIb,GAAG,CAGrC,CAAC;EAEH,KAAK,MAAMC,GAAG,IAAIT,OAAO,CAACsB,OAAO,CAACC,IAAI,CAAC,CAAC,EAAE;IACxC,IAAIhB,0BAA0B,CAACiB,GAAG,CAACf,GAAG,CAAC,EAAE;MACvCY,uBAAuB,CAACD,GAAG,CAACX,GAAG,EAAE;QAC/BC,IAAI,EAAEH,0BAA0B,CAACW,GAAG,CAACT,GAAG,CAAC,CAAEC;MAC7C,CAAC,CAAC;MACFH,0BAA0B,CAACkB,MAAM,CAAChB,GAAG,CAAC;IACxC;EACF;EAEA,KAAK,MAAM,CAACA,GAAG,EAAE;IAAEC;EAAK,CAAC,CAAC,IAAIE,KAAK,CAACC,IAAI,CACtCN,0BAA0B,CAACO,OAAO,CAAC,CACrC,CAAC,EAAE;IACDO,uBAAuB,CAACD,GAAG,CAACX,GAAG,EAAE;MAAEC;IAAK,CAAC,CAAC;EAC5C;EAEA,KAAK,MAAMA,IAAI,IAAIT,IAAI,EAAE;IACvB,MAAMQ,GAAG,GAAGP,OAAO,CAACQ,IAAI,CAAC;IACzB,MAAMgB,QAAQ,GAAGrB,YAAY,CAACa,GAAG,CAACT,GAAG,CAAC;IAEtC,IAAIiB,QAAQ,IAAIA,QAAQ,CAACf,eAAe,CAACI,YAAY,EAAE;MACrDM,uBAAuB,CAACI,MAAM,CAAChB,GAAG,CAAC;MACnCY,uBAAuB,CAACD,GAAG,CAACX,GAAG,EAAE;QAC/BC,IAAI,EAAEgB,QAAQ,CAAChB,IAAI;QACnBiB,WAAW,EAAEjB;MACf,CAAC,CAAC;IACJ,CAAC,MAAM,IAAI,CAACgB,QAAQ,EAAE;MACpBL,uBAAuB,CAACD,GAAG,CAACX,GAAG,EAAE;QAAEC;MAAK,CAAC,CAAC;IAC5C;EACF;EAEA,OAAOE,KAAK,CAACC,IAAI,CAACQ,uBAAuB,CAACO,MAAM,CAAC,CAAC,CAAC;AACrD","ignoreList":[]}