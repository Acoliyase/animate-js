{"version":3,"names":["_http","require","_types","_InMemoryBackend","_events","_chance","_isHttpError","exportServiceMocks","whenRequest","chance","Chance","events","EventEmitter","buildExportAsyncJob","params","createDate","Date","updateDate","rest","id","guid","status","JobStatus","INITIALIZED","data","iterationsCount","processedItemsCount","be","InMemoryBackend","createOne","itemKey","item","total","simulateJobIterations","initialJob","job","maxIterationsCount","_job$data","_job$data$query","_job$data$query2","Promise","resolve","setTimeout","paging","query","cursorPaging","PROCESSING","limit","all","listeners","map","fn","update","completedJobOverrides","reduce","prev","current","FINISHED","beforeUpdateSignedUrlOverrides","f","signedUrl","e","FAILED","error","applicationError","code","message","mocks","createExportAsyncJob","reply","Error","push","isHttpError","response","persist","getExportAsyncJob","get","jobId","__applicationErrorsType"],"sources":["../../../src/testkit/exportServiceMocks.ts"],"sourcesContent":["import {\n  createExportAsyncJob,\n  getExportAsyncJob,\n} from '@wix/bex-utils/@wix/ambassador-fedinfra-exportservice-v1-export-async-job/http';\n\nimport {\n  ExportAsyncJob,\n  Status as JobStatus,\n} from '@wix/bex-utils/@wix/ambassador-fedinfra-exportservice-v1-export-async-job/types';\nimport { InMemoryBackend } from '../InMemoryBackend';\nimport { EventEmitter } from 'events';\nimport { Chance } from 'chance';\nimport { TypedEmitter } from '../util';\nimport { isHttpError } from '../util/isHttpError';\n\nexport function exportServiceMocks(\n  whenRequest: typeof import('@wix/http-client-testkit/client').whenRequest,\n) {\n  const chance = new Chance();\n\n  const events = new EventEmitter() as TypedEmitter<{\n    jobCompleted: (job: ExportAsyncJob) => void | Partial<ExportAsyncJob>;\n    beforeUpdateSignedUrl: (\n      job: ExportAsyncJob,\n    ) => Promise<undefined | Partial<ExportAsyncJob>>;\n\n    beforeGetJob: (job: ExportAsyncJob | undefined) => void | Promise<void>;\n    processing: (job: ExportAsyncJob) => void | Promise<void>;\n    beforeCreateJob: (job: ExportAsyncJob) => void | Promise<void>;\n    jobCreated: (job: ExportAsyncJob) => void | Promise<void>;\n  }>;\n\n  const buildExportAsyncJob = (params: ExportAsyncJob = {}): ExportAsyncJob => {\n    const {\n      createDate = new Date(),\n      updateDate = createDate,\n      ...rest\n    } = params;\n\n    return {\n      id: chance.guid(),\n      status: JobStatus.INITIALIZED,\n      ...rest,\n      data: {\n        iterationsCount: 0,\n        processedItemsCount: 0,\n        ...rest.data,\n      },\n      createDate,\n      updateDate,\n    };\n  };\n\n  const be = new InMemoryBackend<ExportAsyncJob, {}>({\n    createOne: () => buildExportAsyncJob(),\n    itemKey: (item) => item.id as string,\n    total: 0,\n  });\n\n  async function simulateJobIterations(initialJob: ExportAsyncJob) {\n    let job = initialJob;\n\n    try {\n      const maxIterationsCount = 4;\n\n      while (\n        job.data?.iterationsCount != null &&\n        job.data.iterationsCount < maxIterationsCount\n      ) {\n        await new Promise((resolve) => setTimeout(resolve, 100));\n        const paging = job.data.query?.paging ?? job.data.query?.cursorPaging;\n\n        job = {\n          ...job,\n          status: JobStatus.PROCESSING,\n          data: {\n            ...job.data,\n            iterationsCount: job.data.iterationsCount + 1,\n            processedItemsCount:\n              (job.data.processedItemsCount ?? 0) + (paging?.limit ?? 0),\n          },\n        };\n        await Promise.all(events.listeners('processing').map((fn) => fn(job)));\n        await be.update(job);\n      }\n\n      const completedJobOverrides = events.listeners('jobCompleted').reduce(\n        (prev, current) => ({\n          ...prev,\n          ...current(job),\n        }),\n        {} as ExportAsyncJob,\n      );\n\n      await be.update({\n        ...job,\n        status: JobStatus.FINISHED,\n        ...completedJobOverrides,\n        data: {\n          ...job.data,\n          ...completedJobOverrides.data,\n        },\n      });\n\n      const beforeUpdateSignedUrlOverrides = (\n        await Promise.all(\n          events\n            .listeners('beforeUpdateSignedUrl')\n            .map(async (f) => (await f(job)) ?? {}),\n        )\n      ).reduce(\n        (prev, current) => ({\n          ...prev,\n          ...current,\n        }),\n        {} as ExportAsyncJob,\n      );\n\n      await be.update({\n        ...job,\n        status: JobStatus.FINISHED,\n        ...beforeUpdateSignedUrlOverrides,\n        data: {\n          ...job.data,\n          signedUrl: '/export.csv',\n          ...beforeUpdateSignedUrlOverrides.data,\n        },\n      });\n    } catch (e) {\n      await be.update({\n        ...job,\n        status: JobStatus.FAILED,\n        data: {\n          ...job.data,\n          error: {\n            applicationError: {\n              code: (e as Error).message,\n            },\n            ...(e as {}),\n          },\n        },\n      });\n    }\n  }\n\n  return {\n    mocks: [\n      whenRequest(createExportAsyncJob)\n        .reply(async (data) => {\n          try {\n            const paging = data.query.paging ?? data.query.cursorPaging;\n\n            if (paging?.limit == null) {\n              throw new Error('ExportServiceMocks: paging.limit is required');\n            }\n\n            const job = buildExportAsyncJob({\n              data,\n            });\n\n            await Promise.all(\n              events.listeners('beforeCreateJob').map((fn) => fn(job)),\n            );\n\n            await be.push([job]);\n\n            await Promise.all(\n              events.listeners('jobCreated').map((fn) => fn(job)),\n            );\n\n            simulateJobIterations(job);\n\n            return {\n              status: 200,\n              data: {\n                job,\n              },\n            };\n          } catch (e) {\n            if (isHttpError(e) && e.response) {\n              return {\n                status: e.response.status,\n                data: e.response.data,\n              };\n            }\n\n            return {\n              status: 504,\n              data: {},\n            };\n          }\n        })\n        .persist(),\n\n      whenRequest(getExportAsyncJob)\n        .reply(200, async (data) => {\n          const job = be.get(data.jobId);\n          await Promise.all(\n            events.listeners('beforeGetJob').map((fn) => fn(job)),\n          );\n          return {\n            __applicationErrorsType: {},\n            job,\n          };\n        })\n        .persist(),\n    ] as import('@wix/http-client-testkit').AnyScenario[],\n    be,\n    events,\n  };\n}\n"],"mappings":"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","ignoreList":[]}