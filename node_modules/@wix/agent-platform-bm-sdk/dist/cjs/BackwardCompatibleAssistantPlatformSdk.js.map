{"version":3,"names":["ANY_EVENT_IDENTIFIER","BackwardCompatibleAssistantPlatformSdk","constructor","emitter","_defineProperty2","default","Map","emitEvent","appDefId","event","payload","appDefinitionId","name","conversationId","undefined","onEvent","listener","_this$activeListeners","wrappedListener","sideEffect","addEventListener","mapper","getListenerMap","set","activeListenersChange","call","offEvent","get","removeEventListener","delete","onAnyEvent","_this$activeListeners2","offAnyEvent","getActiveListeners","activeListeners","listeners","forEach","eventListeners","Array","from","keys","setActiveListenersObserver","has","exports"],"sources":["../../src/BackwardCompatibleAssistantPlatformSdk.tsx"],"sourcesContent":["import {\n  AnyListener,\n  AppDefId,\n  AssistantBmSdk,\n  Listener,\n} from './AssistantBmSdk';\nimport { SideEffectEmitter } from './SideEffectEmitter';\n\nconst ANY_EVENT_IDENTIFIER = '*';\n\nexport class BackwardCompatibleAssistantPlatformSdk implements AssistantBmSdk {\n  private readonly listeners = new Map<\n    AppDefId,\n    Map<string, Map<Listener | AnyListener, (payload: any) => void>>\n  >();\n  private activeListenersChange?: (appDefId: AppDefId, added: string[]) => void;\n\n  constructor(private readonly emitter: SideEffectEmitter) {}\n\n  emitEvent(appDefId: string, event: string, payload: any) {\n    this.emitter.emitEvent({\n      appDefinitionId: appDefId,\n      name: event,\n      payload,\n      conversationId: undefined,\n    });\n  }\n\n  onEvent(appDefId: string, event: string, listener: Listener) {\n    const wrappedListener = (sideEffect: any) => {\n      if (\n        sideEffect.appDefinitionId === appDefId &&\n        sideEffect.name === event\n      ) {\n        listener(sideEffect.payload);\n      }\n    };\n\n    this.emitter.addEventListener(wrappedListener);\n    const mapper = this.getListenerMap(appDefId, event);\n    mapper.set(listener, wrappedListener);\n    this.activeListenersChange?.(appDefId, [event]);\n  }\n\n  offEvent(appDefId: string, event: string, listener: Listener) {\n    const mapper = this.getListenerMap(appDefId, event);\n    const wrappedListener = mapper.get(listener);\n\n    if (wrappedListener) {\n      this.emitter.removeEventListener(wrappedListener);\n      mapper.delete(listener);\n    }\n  }\n\n  onAnyEvent(appDefId: string, listener: AnyListener) {\n    const wrappedListener = (sideEffect: any) => {\n      if (sideEffect.appDefinitionId === appDefId) {\n        listener(sideEffect.name, sideEffect.payload);\n      }\n    };\n\n    this.emitter.addEventListener(wrappedListener);\n    const mapper = this.getListenerMap(appDefId, ANY_EVENT_IDENTIFIER);\n    mapper.set(listener, wrappedListener);\n    this.activeListenersChange?.(appDefId, [ANY_EVENT_IDENTIFIER]);\n  }\n\n  offAnyEvent(appDefId: string, listener: AnyListener) {\n    const mapper = this.getListenerMap(appDefId, ANY_EVENT_IDENTIFIER);\n    const wrappedListener = mapper.get(listener);\n    if (wrappedListener) {\n      this.emitter.removeEventListener(wrappedListener);\n      mapper.delete(listener);\n    }\n  }\n\n  getActiveListeners(): { [appDefId: AppDefId]: string[] } {\n    const activeListeners: { [appDefId: AppDefId]: string[] } = {};\n    this.listeners.forEach((eventListeners, appDefId) => {\n      activeListeners[appDefId] = Array.from(eventListeners.keys());\n    });\n    return activeListeners;\n  }\n\n  setActiveListenersObserver(\n    listener: (appDefId: AppDefId, added: string[]) => void,\n  ): void {\n    this.activeListenersChange = listener;\n  }\n\n  private getListenerMap(appDefId: AppDefId, event: string) {\n    if (!this.listeners.has(appDefId)) {\n      this.listeners.set(\n        appDefId,\n        new Map<string, Map<Listener, (payload: any) => void>>(),\n      );\n    }\n    const eventListeners = this.listeners.get(appDefId)!;\n    if (!eventListeners.has(event)) {\n      eventListeners.set(event, new Map<Listener, (payload: any) => void>());\n    }\n\n    return eventListeners.get(event)!;\n  }\n}\n"],"mappings":"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","ignoreList":[]}