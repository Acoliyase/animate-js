// src/middleware/html-embeds.ts
import { scripts } from "@wix/headless-site-assets";

// src/utils/transformStreamUtils.ts
function injectAfterTransformStream(predicate, htmlToInject) {
  let hasInjected = false;
  return new TransformStream({
    transform: (chunk, controller) => {
      if (!hasInjected) {
        const index = predicate.exec(chunk);
        if (index) {
          const position = index.index + index[0].length;
          chunk = chunk.slice(0, position) + htmlToInject + chunk.slice(position);
          hasInjected = true;
        }
      }
      controller.enqueue(chunk);
    }
  });
}
function injectBeforeTransformStream(predicate, htmlToInject) {
  let hasInjected = false;
  return new TransformStream({
    transform: (chunk, controller) => {
      if (!hasInjected) {
        const index = chunk.indexOf(predicate);
        if (index > -1) {
          chunk = chunk.slice(0, index) + htmlToInject + chunk.slice(index);
          hasInjected = true;
        }
      }
      controller.enqueue(chunk);
    }
  });
}

// src/middleware/html-embeds.ts
var bodyEndTransformStream = (htmlToInject) => injectBeforeTransformStream("</body>", htmlToInject);
var headTransformStream = (htmlToInject) => injectBeforeTransformStream("</head>", htmlToInject);
var bodyStartTransformStream = (htmlToInject) => injectAfterTransformStream(/<body(?![^>]*\/>)[^>]*>/, htmlToInject);
var onRequest = async (context, next) => {
  const response = await next();
  const contentType = response.headers.get("Content-Type");
  if (contentType !== "text/html") {
    return response;
  }
  if (context.url.pathname.startsWith("/_wix")) {
    return response;
  }
  const { siteScripts } = await scripts.listSiteScripts();
  if (siteScripts == null) {
    throw new Error("Could not fetch site scripts");
  }
  const headInjection = siteScripts.filter((x) => x.position === "HEAD").map((x) => x.html).join("\n");
  const bodyStartInjection = siteScripts.filter((x) => x.position === "BODY_START").map((x) => x.html).join("\n");
  const bodyEndInjection = siteScripts.filter((x) => x.position === "BODY_END").map((x) => x.html).join("\n");
  return new Response(
    response.body?.pipeThrough(new TextDecoderStream()).pipeThrough(headTransformStream(headInjection)).pipeThrough(bodyStartTransformStream(bodyStartInjection)).pipeThrough(bodyEndTransformStream(bodyEndInjection)).pipeThrough(new TextEncoderStream()),
    response
  );
};
export {
  onRequest
};
