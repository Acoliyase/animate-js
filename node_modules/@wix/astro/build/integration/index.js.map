{"version":3,"sources":["../../src/index.ts","../../../astro-auth/src/index.ts","../../../astro-auth/src/plugins/patchAstroInlineScripts.ts","../../../astro-auth/src/plugins/setupContentCollectionContext.ts","../../../astro-html-embeds/src/index.ts","../../../astro-payment-links/src/index.ts","../../../astro-robots/src/index.ts","../../../astro-viewer-api/src/index.ts","../../../astro-viewer-api/src/integration.ts"],"sourcesContent":["import type { AstroIntegration } from 'astro';\nimport auth from '@wix/astro-auth';\nimport backend from '@wix/astro-backend-extensions';\nimport backoffice from '@wix/astro-backoffice-extensions';\nimport core from '@wix/astro-core';\nimport customElements from '@wix/astro-custom-elements-extensions';\nimport embeddedScripts from '@wix/astro-embedded-scripts-extensions';\nimport htmlEmbeds from '@wix/astro-html-embeds';\nimport paymentLinks from '@wix/astro-payment-links';\nimport robots from '@wix/astro-robots';\nimport siteComponents from '@wix/astro-site-components-extensions';\nimport sitePlugins from '@wix/astro-site-plugins-extensions';\nimport viewerApi from '@wix/astro-viewer-api';\n\ninterface WixAstroConfig {\n  auth?: boolean | { enable?: boolean };\n  htmlEmbeds?: boolean | { enable?: boolean };\n  robots?: boolean | { enable?: boolean };\n}\n\nfunction isEnabled(value?: boolean | { enable?: boolean }): boolean {\n  if (typeof value === 'boolean') {\n    return value;\n  }\n  return value?.enable ?? true;\n}\n\nconst createIntegration = (config?: WixAstroConfig): AstroIntegration => {\n  const enableAuthRoutes = isEnabled(config?.auth);\n  const enableHtmlEmbeds = isEnabled(config?.htmlEmbeds);\n  const enableRobots = isEnabled(config?.robots);\n\n  return {\n    name: '@wix/astro',\n    hooks: {\n      async 'astro:config:setup'({ updateConfig }) {\n        updateConfig({\n          integrations: [\n            core({\n              integrations: [\n                auth({ enableAuthRoutes }),\n                backend(),\n                backoffice(),\n                sitePlugins(),\n                customElements(),\n                ...(enableHtmlEmbeds ? [htmlEmbeds()] : []),\n                paymentLinks(),\n                embeddedScripts(),\n                siteComponents(),\n                ...(enableRobots ? [robots()] : []),\n                viewerApi(),\n              ],\n            }),\n          ],\n        });\n      },\n    },\n  };\n};\n\nexport default createIntegration;\n","import { fileURLToPath } from 'node:url';\nimport type { WixIntegration } from '@wix/astro-core';\nimport { normalizePath } from '@wix/fs-utils';\nimport { outdent } from 'outdent';\nimport { patchAstroInlineScripts } from './plugins/patchAstroInlineScripts.js';\nimport { setupContentCollectionContext } from './plugins/setupContentCollectionContext.js';\n\nconst setupContextUrl = new URL(\n  '../dependencies/astro-auth/browser-runtime/setup.js',\n  import.meta.url\n);\n\nconst createIntegration = ({\n  enableAuthRoutes,\n}: {\n  enableAuthRoutes: boolean;\n}): WixIntegration => {\n  return {\n    name: '@wix/astro/auth',\n    hooks: {\n      'astro:config:setup'({\n        addMiddleware,\n        config,\n        injectRoute,\n        injectScript,\n        updateConfig,\n      }) {\n        const srcDir = fileURLToPath(config.srcDir);\n\n        updateConfig({\n          vite: {\n            plugins: [\n              setupContentCollectionContext(srcDir),\n              patchAstroInlineScripts(),\n            ],\n          },\n        });\n\n        const setupContextCode = outdent`\n          import { WIX_CLIENT_ID } from 'astro:env/client';\n          import { setup } from '${normalizePath(setupContextUrl)}';\n\n          setup({ clientId: WIX_CLIENT_ID });\n        `;\n\n        // support client-side context calls\n        injectScript('before-hydration', setupContextCode);\n        injectScript('page', setupContextCode);\n\n        // support server side context calls\n        addMiddleware({\n          entrypoint: new URL(\n            '../dependencies/astro-auth/backend-runtime/middleware/auth.js',\n            import.meta.url\n          ),\n          order: 'pre',\n        });\n\n        // support built-in auth routes\n        if (enableAuthRoutes) {\n          injectRoute({\n            entrypoint: new URL(\n              '../dependencies/astro-auth/backend-runtime/routes/login.js',\n              import.meta.url\n            ),\n            pattern: '/api/auth/login',\n            prerender: false,\n          });\n\n          injectRoute({\n            entrypoint: new URL(\n              '../dependencies/astro-auth/backend-runtime/routes/logout.js',\n              import.meta.url\n            ),\n            pattern: '/api/auth/logout',\n            prerender: false,\n          });\n\n          injectRoute({\n            entrypoint: new URL(\n              '../dependencies/astro-auth/backend-runtime/routes/callback.js',\n              import.meta.url\n            ),\n            pattern: '/api/auth/callback',\n            prerender: false,\n          });\n\n          injectRoute({\n            entrypoint: new URL(\n              '../dependencies/astro-auth/backend-runtime/routes/logout-callback.js',\n              import.meta.url\n            ),\n            pattern: '/api/auth/logout-callback',\n            prerender: false,\n          });\n        }\n      },\n    },\n  };\n};\n\nexport default createIntegration;\n","import type { PluginOption } from 'vite';\nimport { outdent } from 'outdent';\n\nexport function patchAstroInlineScripts(): PluginOption {\n  return {\n    name: 'patch-astro-inline-scripts',\n    transform(code, id) {\n      const [_filename, rawQuery] = id.split(`?`, 2);\n      const query = Object.fromEntries(new URLSearchParams(rawQuery).entries());\n\n      if (\n        query.astro == null ||\n        query.type !== 'script' ||\n        query['lang.ts'] == null ||\n        code === ''\n      ) {\n        return null;\n      }\n\n      return outdent`\n        import 'astro:scripts/page.js';\n\n        ${code}\n      `;\n    },\n  };\n}\n","import { relative } from 'node:path';\nimport type { PluginOption } from 'vite';\nimport { normalizePath } from '@wix/fs-utils';\nimport { outdent } from 'outdent';\n\n// https://github.com/withastro/astro/blob/e0c4460c5b6cc0c19b705d81820809aef0544100/packages/astro/src/content/utils.ts#L748-L763\nconst contentCollectionFilePaths = [\n  'content.config.mjs',\n  'content.config.js',\n  'content.config.mts',\n  'content.config.ts',\n  'content/config.mjs',\n  'content/config.js',\n  'content/config.mts',\n  'content/config.ts',\n];\n\nconst setupContextualClientUrl = new URL(\n  '../dependencies/astro-auth/backend-runtime/runtime/backend/setupContextualClient.js',\n  import.meta.url\n);\n\nexport function setupContentCollectionContext(srcDir: string): PluginOption {\n  return {\n    name: 'setup-content-collection-context',\n    applyToEnvironment(environment) {\n      return environment.name === 'ssr';\n    },\n    transform(code, id) {\n      const relativeId = relative(srcDir, id);\n\n      const isContentCollectionFile =\n        contentCollectionFilePaths.includes(relativeId);\n\n      if (isContentCollectionFile) {\n        return outdent`\n          import '${normalizePath(setupContextualClientUrl)}';\n\n          ${code}\n        `;\n      }\n\n      return null;\n    },\n  };\n}\n","import type { WixIntegration } from '@wix/astro-core';\n\nconst createIntegration = (): WixIntegration => {\n  return {\n    name: '@wix/astro/html-embeds',\n    hooks: {\n      'astro:config:setup'({ addMiddleware }) {\n        addMiddleware({\n          entrypoint: new URL(\n            '../dependencies/astro-html-embeds/backend-runtime/html-embeds.js',\n            import.meta.url\n          ),\n          order: 'post',\n        });\n      },\n    },\n  };\n};\n\nexport default createIntegration;\n","import type { WixIntegration } from '@wix/astro-core';\n\nconst createIntegration = (): WixIntegration => {\n  return {\n    name: '@wix/astro/payment-links',\n    hooks: {\n      'astro:config:setup'({ injectRoute }) {\n        /*\n          1. A user generates a paylink -> https://mysite.com/_paylink/[id]\n          2. When accessing the paylink, our route redirects them to the Wix Payments link\n          3. Wix Payments then redirects the user to Wix Checkout,\n             which may resolve to either https://mysite.com/checkout/... or https://mysite.com/__ecom/checkout/...,\n             depending on the flow within Wix.\n        */\n\n        injectRoute({\n          entrypoint: new URL(\n            '../dependencies/astro-payment-links/backend-runtime/payment-link.js',\n            import.meta.url\n          ),\n          pattern: '/_paylink/[id]',\n          prerender: false,\n        });\n\n        injectRoute({\n          entrypoint: new URL(\n            '../dependencies/astro-payment-links/backend-runtime/payment-checkout.js',\n            import.meta.url\n          ),\n          pattern: '/checkout',\n          prerender: false,\n        });\n\n        injectRoute({\n          entrypoint: new URL(\n            '../dependencies/astro-payment-links/backend-runtime/payment-checkout.js',\n            import.meta.url\n          ),\n          pattern: '/__ecom/checkout',\n          prerender: false,\n        });\n      },\n    },\n  };\n};\n\nexport default createIntegration;\n","import type { WixIntegration } from '@wix/astro-core';\n\nconst createIntegration = (): WixIntegration => {\n  return {\n    name: '@wix/astro/robots',\n    hooks: {\n      'astro:config:setup'({ injectRoute }) {\n        injectRoute({\n          entrypoint: new URL(\n            '../dependencies/astro-robots/backend-runtime/robots.js',\n            import.meta.url\n          ),\n          pattern: '/robots.txt',\n          prerender: false,\n        });\n      },\n    },\n  };\n};\n\nexport default createIntegration;\n","export { createIntegration as default } from './integration.js';\n","import type { WixIntegration } from '@wix/astro-core';\n\nexport const createIntegration = (): WixIntegration => {\n  return {\n    name: '@wix/astro/viewer-api',\n    hooks: {\n      'astro:config:setup'({ injectRoute }) {\n        injectRoute({\n          entrypoint: new URL(\n            '../dependencies/astro-viewer-api/backend-runtime/api.js',\n            import.meta.url\n          ),\n          pattern: '/_api/[...path]',\n          prerender: false,\n        });\n      },\n    },\n  };\n};\n"],"mappings":"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","names":["createIntegration","createIntegration","src_default","createIntegration","src_default","createIntegration","src_default","createIntegration","createIntegration","src_default"]}