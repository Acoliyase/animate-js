{"version":3,"names":["_comlink","require","proxyCallbackMarker","proxyPromiseMarker","serializeAllMethodsIn","sdk","wrapMethodsWithProxy","originalMethod","args","proxies","argsNoProxies","extractProxies","originalResult","proxy","deserializeReturnValue","exports","deserializeAllMethodsIn","api","argsWithProxies","insertProxies","originalRun","serializeReturnValue","value","clonables","data","walker","val","isPromise","proxyId","uniqueId","promises","isFunction","callbacks","innerProxies","argsAsArray","exec","Array","isArray","map","i","isObject","mapObjectValues","dataWithoutProxies","hasOwnProperty","promiseId","callbackId","obj","callback","Proxy","get","target","prop","Error","Promise","mapEntries","key","Object","fromEntries","entries","counter"],"sources":["../../src/serialization.ts"],"sourcesContent":["import { proxy } from 'comlink';\n\nconst proxyCallbackMarker = '__proxyCallbackId__wixSDK__';\nconst proxyPromiseMarker = '__proxyPromiseId__wixSDK__';\ntype SerializedReturnValue = {\n  proxies: ProxiesCollector;\n  clonables: any;\n};\nexport type ProxiesCollector = {\n  callbacks: { [key: string]: Function };\n  promises: { [key: string]: Promise<any> };\n};\n\nexport const serializeAllMethodsIn = <T extends {}>(sdk: T) => {\n  return wrapMethodsWithProxy(sdk, (originalMethod) => {\n    return async (...args: any) => {\n      const [proxies, argsNoProxies] = extractProxies(args);\n      const originalResult = await originalMethod(\n        proxy(proxies),\n        argsNoProxies,\n      );\n      return deserializeReturnValue(originalResult);\n    };\n  });\n};\n\nexport const deserializeAllMethodsIn = <T extends {}>(api: T) => {\n  return wrapMethodsWithProxy(api, (originalMethod) => {\n    return (proxies: ProxiesCollector, args: any[]) => {\n      const argsWithProxies = insertProxies(proxies, args);\n      const originalRun = originalMethod(...argsWithProxies);\n      return serializeReturnValue(originalRun);\n    };\n  });\n};\n\nconst serializeReturnValue = async (\n  value: any,\n): Promise<SerializedReturnValue> => {\n  const [proxies, clonables] = extractProxies(await value);\n  return proxy({ proxies, clonables });\n};\n\nconst deserializeReturnValue = async (value: any) => {\n  return insertProxies(value?.proxies, await value?.clonables);\n};\n\nconst extractProxies = (data: any): [ProxiesCollector, any] => {\n  const walker = (proxies: ProxiesCollector, val: any): any => {\n    if (isPromise(val)) {\n      const proxyId = uniqueId();\n      proxies.promises[proxyId] = val;\n      return { [proxyPromiseMarker]: proxyId };\n    }\n\n    if (isFunction(val)) {\n      const proxyId = uniqueId();\n      proxies.callbacks[proxyId] = (\n        innerProxies: ProxiesCollector,\n        argsAsArray: any[],\n      ) => {\n        const argsWithProxies = insertProxies(innerProxies, argsAsArray);\n        const exec = val(...argsWithProxies);\n        return serializeReturnValue(exec);\n      };\n      return { [proxyCallbackMarker]: proxyId };\n    }\n\n    if (Array.isArray(val)) {\n      return val.map((i: any) => walker(proxies, i));\n    }\n    if (isObject(val)) {\n      return mapObjectValues(val, (i: any) => walker(proxies, i));\n    }\n\n    return val;\n  };\n\n  const proxies: ProxiesCollector = { promises: {}, callbacks: {} };\n  const dataWithoutProxies = walker(proxies, data);\n  return [proxies, dataWithoutProxies];\n};\n\nconst insertProxies = (proxies: ProxiesCollector, data: any): any => {\n  if (Array.isArray(data)) {\n    return data.map((i: any) => insertProxies(proxies, i));\n  }\n\n  if (isObject(data) && data.hasOwnProperty(proxyPromiseMarker)) {\n    const promiseId = (data as any)[proxyPromiseMarker];\n    return proxies.promises[promiseId];\n  }\n\n  if (isObject(data) && data.hasOwnProperty(proxyCallbackMarker)) {\n    const callbackId = (data as any)[proxyCallbackMarker];\n    // passing args in spread syntax to comlink proxy generates problem when transpiling to old JS version\n    // so pass it as array and handle it on the deserialization level:\n    return async (...args: any) => {\n      const [innerProxies, argsNoProxies] = extractProxies(args);\n      const exec = await proxies.callbacks[callbackId](\n        proxy(innerProxies),\n        argsNoProxies,\n      );\n      return deserializeReturnValue(exec);\n    };\n  }\n\n  if (isObject(data)) {\n    return mapObjectValues(data, (i: any) => insertProxies(proxies, i));\n  }\n\n  return data;\n};\n\nconst wrapMethodsWithProxy = <T extends Record<string, Function>>(\n  obj: T,\n  callback: (originalMethod: Function) => Function,\n) => {\n  return new Proxy<T>(obj, {\n    get(target: any, prop: any) {\n      if (!target[prop]) {\n        return () => {\n          throw new Error(\n            `Serialization error occurred while accessing ${prop} property of ${target}`,\n          );\n        };\n      }\n      return callback(target[prop]);\n    },\n  });\n};\n\nconst isPromise = (val: any): val is Promise<any> => val instanceof Promise;\nconst isObject = (val: any): val is object =>\n  val && typeof val === 'object' && !isPromise(val);\nconst isFunction = (val: any): val is Function => typeof val === 'function';\nconst mapObjectValues = (obj: object, callback: Function) => {\n  const mapEntries = ([key, value]: [string, any]) => [key, callback(value)];\n  return Object.fromEntries(Object.entries(obj).map(mapEntries));\n};\nconst uniqueId = (() => {\n  let counter = 0;\n  return () => ++counter;\n})();\n"],"mappings":"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","ignoreList":[]}