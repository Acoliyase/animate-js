{"version":3,"names":["proxy","proxyCallbackMarker","proxyPromiseMarker","serializeAllMethodsIn","sdk","wrapMethodsWithProxy","originalMethod","_len","arguments","length","args","Array","_key","proxies","argsNoProxies","extractProxies","originalResult","deserializeReturnValue","deserializeAllMethodsIn","api","argsWithProxies","insertProxies","originalRun","serializeReturnValue","value","clonables","data","walker","val","isPromise","proxyId","uniqueId","promises","isFunction","callbacks","innerProxies","argsAsArray","exec","isArray","map","i","isObject","mapObjectValues","dataWithoutProxies","hasOwnProperty","promiseId","callbackId","_len2","_key2","obj","callback","Proxy","get","target","prop","Error","Promise","mapEntries","_ref","key","Object","fromEntries","entries","counter"],"sources":["../../src/serialization.ts"],"sourcesContent":["import { proxy } from 'comlink';\n\nconst proxyCallbackMarker = '__proxyCallbackId__wixSDK__';\nconst proxyPromiseMarker = '__proxyPromiseId__wixSDK__';\ntype SerializedReturnValue = {\n  proxies: ProxiesCollector;\n  clonables: any;\n};\nexport type ProxiesCollector = {\n  callbacks: { [key: string]: Function };\n  promises: { [key: string]: Promise<any> };\n};\n\nexport const serializeAllMethodsIn = <T extends {}>(sdk: T) => {\n  return wrapMethodsWithProxy(sdk, (originalMethod) => {\n    return async (...args: any) => {\n      const [proxies, argsNoProxies] = extractProxies(args);\n      const originalResult = await originalMethod(\n        proxy(proxies),\n        argsNoProxies,\n      );\n      return deserializeReturnValue(originalResult);\n    };\n  });\n};\n\nexport const deserializeAllMethodsIn = <T extends {}>(api: T) => {\n  return wrapMethodsWithProxy(api, (originalMethod) => {\n    return (proxies: ProxiesCollector, args: any[]) => {\n      const argsWithProxies = insertProxies(proxies, args);\n      const originalRun = originalMethod(...argsWithProxies);\n      return serializeReturnValue(originalRun);\n    };\n  });\n};\n\nconst serializeReturnValue = async (\n  value: any,\n): Promise<SerializedReturnValue> => {\n  const [proxies, clonables] = extractProxies(await value);\n  return proxy({ proxies, clonables });\n};\n\nconst deserializeReturnValue = async (value: any) => {\n  return insertProxies(value?.proxies, await value?.clonables);\n};\n\nconst extractProxies = (data: any): [ProxiesCollector, any] => {\n  const walker = (proxies: ProxiesCollector, val: any): any => {\n    if (isPromise(val)) {\n      const proxyId = uniqueId();\n      proxies.promises[proxyId] = val;\n      return { [proxyPromiseMarker]: proxyId };\n    }\n\n    if (isFunction(val)) {\n      const proxyId = uniqueId();\n      proxies.callbacks[proxyId] = (\n        innerProxies: ProxiesCollector,\n        argsAsArray: any[],\n      ) => {\n        const argsWithProxies = insertProxies(innerProxies, argsAsArray);\n        const exec = val(...argsWithProxies);\n        return serializeReturnValue(exec);\n      };\n      return { [proxyCallbackMarker]: proxyId };\n    }\n\n    if (Array.isArray(val)) {\n      return val.map((i: any) => walker(proxies, i));\n    }\n    if (isObject(val)) {\n      return mapObjectValues(val, (i: any) => walker(proxies, i));\n    }\n\n    return val;\n  };\n\n  const proxies: ProxiesCollector = { promises: {}, callbacks: {} };\n  const dataWithoutProxies = walker(proxies, data);\n  return [proxies, dataWithoutProxies];\n};\n\nconst insertProxies = (proxies: ProxiesCollector, data: any): any => {\n  if (Array.isArray(data)) {\n    return data.map((i: any) => insertProxies(proxies, i));\n  }\n\n  if (isObject(data) && data.hasOwnProperty(proxyPromiseMarker)) {\n    const promiseId = (data as any)[proxyPromiseMarker];\n    return proxies.promises[promiseId];\n  }\n\n  if (isObject(data) && data.hasOwnProperty(proxyCallbackMarker)) {\n    const callbackId = (data as any)[proxyCallbackMarker];\n    // passing args in spread syntax to comlink proxy generates problem when transpiling to old JS version\n    // so pass it as array and handle it on the deserialization level:\n    return async (...args: any) => {\n      const [innerProxies, argsNoProxies] = extractProxies(args);\n      const exec = await proxies.callbacks[callbackId](\n        proxy(innerProxies),\n        argsNoProxies,\n      );\n      return deserializeReturnValue(exec);\n    };\n  }\n\n  if (isObject(data)) {\n    return mapObjectValues(data, (i: any) => insertProxies(proxies, i));\n  }\n\n  return data;\n};\n\nconst wrapMethodsWithProxy = <T extends Record<string, Function>>(\n  obj: T,\n  callback: (originalMethod: Function) => Function,\n) => {\n  return new Proxy<T>(obj, {\n    get(target: any, prop: any) {\n      if (!target[prop]) {\n        return () => {\n          throw new Error(\n            `Serialization error occurred while accessing ${prop} property of ${target}`,\n          );\n        };\n      }\n      return callback(target[prop]);\n    },\n  });\n};\n\nconst isPromise = (val: any): val is Promise<any> => val instanceof Promise;\nconst isObject = (val: any): val is object =>\n  val && typeof val === 'object' && !isPromise(val);\nconst isFunction = (val: any): val is Function => typeof val === 'function';\nconst mapObjectValues = (obj: object, callback: Function) => {\n  const mapEntries = ([key, value]: [string, any]) => [key, callback(value)];\n  return Object.fromEntries(Object.entries(obj).map(mapEntries));\n};\nconst uniqueId = (() => {\n  let counter = 0;\n  return () => ++counter;\n})();\n"],"mappings":"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","ignoreList":[]}