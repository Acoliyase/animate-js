!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("WixCommunicationChannel",[],t):"object"==typeof exports?exports.WixCommunicationChannel=t():e.WixCommunicationChannel=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{handshakeCode:()=>A,open:()=>z,serve:()=>L});const n=Symbol("Comlink.proxy"),r=Symbol("Comlink.endpoint"),a=Symbol("Comlink.releaseProxy"),o=Symbol("Comlink.thrown"),s=e=>"object"==typeof e&&null!==e||"function"==typeof e,i=new Map([["proxy",{canHandle:e=>s(e)&&e[n],serialize(e){const{port1:t,port2:n}=new MessageChannel;return c(e,t),[n,[n]]},deserialize:e=>(e.start(),u(e))}],["throw",{canHandle:e=>s(e)&&o in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function c(e,t=self){t.addEventListener("message",(function n(r){if(!r||!r.data)return;const{id:a,type:s,path:i}=Object.assign({path:[]},r.data),u=(r.data.argumentList||[]).map(g);let p;try{const t=i.slice(0,-1).reduce(((e,t)=>e[t]),e),n=i.reduce(((e,t)=>e[t]),e);switch(s){case 0:p=n;break;case 1:t[i.slice(-1)[0]]=g(r.data.value),p=!0;break;case 2:p=n.apply(t,u);break;case 3:p=d(new n(...u));break;case 4:{const{port1:t,port2:n}=new MessageChannel;c(e,n),p=function(e,t){return y.set(e,t),e}(t,[t])}break;case 5:p=void 0}}catch(e){p={value:e,[o]:0}}Promise.resolve(p).catch((e=>({value:e,[o]:0}))).then((e=>{const[r,o]=h(e);t.postMessage(Object.assign(Object.assign({},r),{id:a}),o),5===s&&(t.removeEventListener("message",n),l(t))}))})),t.start&&t.start()}function l(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function u(e,t){return f(e,[],t)}function p(e){if(e)throw new Error("Proxy has been released and is not useable")}function f(e,t=[],n=function(){}){let o=!1;const s=new Proxy(n,{get(n,r){if(p(o),r===a)return()=>b(e,{type:5,path:t.map((e=>e.toString()))}).then((()=>{l(e),o=!0}));if("then"===r){if(0===t.length)return{then:()=>s};const n=b(e,{type:0,path:t.map((e=>e.toString()))}).then(g);return n.then.bind(n)}return f(e,[...t,r])},set(n,r,a){p(o);const[s,i]=h(a);return b(e,{type:1,path:[...t,r].map((e=>e.toString())),value:s},i).then(g)},apply(n,a,s){p(o);const i=t[t.length-1];if(i===r)return b(e,{type:4}).then(g);if("bind"===i)return f(e,t.slice(0,-1));const[c,l]=m(s);return b(e,{type:2,path:t.map((e=>e.toString())),argumentList:c},l).then(g)},construct(n,r){p(o);const[a,s]=m(r);return b(e,{type:3,path:t.map((e=>e.toString())),argumentList:a},s).then(g)}});return s}function m(e){const t=e.map(h);return[t.map((e=>e[0])),(n=t.map((e=>e[1])),Array.prototype.concat.apply([],n))];var n}const y=new WeakMap;function d(e){return Object.assign(e,{[n]:!0})}function h(e){for(const[t,n]of i)if(n.canHandle(e)){const[r,a]=n.serialize(e);return[{type:3,name:t,value:r},a]}return[{type:0,value:e},y.get(e)||[]]}function g(e){switch(e.type){case 3:return i.get(e.name).deserialize(e.value);case 0:return e.value}}function b(e,t,n){return new Promise((r=>{const a=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function t(n){n.data&&n.data.id&&n.data.id===a&&(e.removeEventListener("message",t),r(n.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:a},t),n)}))}const v="__proxyCallbackId__wixSDK__",w="__proxyPromiseId__wixSDK__",x=async e=>{const[t,n]=S(await e);return d({proxies:t,clonables:n})},k=async e=>j(null==e?void 0:e.proxies,await(null==e?void 0:e.clonables)),S=e=>{const t=(e,n)=>{if(C(n)){const t=M();return e.promises[t]=n,{[w]:t}}if(O(n)){const t=M();return e.callbacks[t]=(e,t)=>{const r=j(e,t),a=n(...r);return x(a)},{[v]:t}}return Array.isArray(n)?n.map((n=>t(e,n))):E(n)?P(n,(n=>t(e,n))):n},n={promises:{},callbacks:{}};return[n,t(n,e)]},j=(e,t)=>{if(Array.isArray(t))return t.map((t=>j(e,t)));if(E(t)&&t.hasOwnProperty(w)){const n=t[w];return e.promises[n]}if(E(t)&&t.hasOwnProperty(v)){const n=t[v];return async function(){for(var t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];const[o,s]=S(r),i=await e.callbacks[n](d(o),s);return k(i)}}return E(t)?P(t,(t=>j(e,t))):t},_=(e,t)=>new Proxy(e,{get:(e,n)=>e[n]?t(e[n]):()=>{throw new Error(`Serialization error occurred while accessing ${n} property of ${e}`)}}),C=e=>e instanceof Promise,E=e=>e&&"object"==typeof e&&!C(e),O=e=>"function"==typeof e,P=(e,t)=>Object.fromEntries(Object.entries(e).map((e=>{let[n,r]=e;return[n,t(r)]}))),M=(()=>{let e=0;return()=>++e})(),A="wix-sdk-bo-hello-handshake",z=e=>{let{postMessage:t,origin:n}=e;const{port1:r,port2:o}=new MessageChannel;t({code:A,version:"1.0.0",port:o},n,[o]);const s=(i=u(r),_(i,(e=>async function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const[a,o]=S(n),s=await e(d(a),o);return k(s)})));var i;return{channel:s,close:()=>s[a]()}},L=e=>{let{api:t,port:n}=e;c((e=>_(e,(e=>(t,n)=>{const r=j(t,n),a=e(...r);return x(a)})))(t),n)};return t})()));
//# sourceMappingURL=main.umd.min.js.map