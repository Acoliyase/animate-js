{"version":3,"names":["_react","_interopRequireWildcard","require","_reactDom","_core","_sortable","_utilities","_sensors","_DroppableTableContextStCss","_TestWrappers","_DragAndDropContext","_TableRowDragOverlay","_TableRowHorizontalScrollDragOverlay","_restrictKeyboardToVerticalAxis","_jsxFileName","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","DroppableTableContext","props","children","items","className","style","onDragEnd","onDragStart","onDragCancel","isDragAndDropDisabled","horizontalScroll","renderRow","renderTableContainer","type","Table","tableProps","ref","cancelDrop","announcements","onDragOver","onDragMove","a11yContainer","keyboardCodes","consumers","restoreFocus","autoScrollOptions","closestCenterOnViewPort","useDragAndDropContext","activeIndex","setActiveIndex","React","useState","pointerSensor","useSensor","PointerSensor","activationConstraint","distance","keyboardSensor","KeyboardSensor","coordinateGetter","sortableKeyboardCoordinates","uniqueSortableId","useUniqueId","onDragStartHandler","useCallback","event","hasSortableData","active","data","current","sortable","index","onDragEndHandler","onDragCancelHandler","sensors","useSensors","process","env","NODE_ENV","calcClosestCenterOnViewPort","params","filteredDroppableContainers","droppableContainers","filter","item","node","itemRect","getBoundingClientRect","top","bottom","window","innerHeight","closestCenter","renderTableOverlay","child","createElement","__self","__source","fileName","lineNumber","columnNumber","rowNum","rowData","isDragOverlay","autoScroll","useMemo","activator","AutoScrollActivator","DraggableRect","acceleration","canScroll","element","Array","from","classList","some","includes","freeze","threshold","y","x","DragOverlayType","TableRowHorizontalScrollDragOverlay","TableRowDragOverlay","modifiers","restrictKeyboardToVerticalAxis","dndContext","DndContext","accessibility","container","screenReaderInstructions","draggable","collisionDetection","SortableContext","id","strategy","verticalListSortingStrategy","_extends2","st","classes","root","droppable","listAttributes","createPortal","document","body","TableTestWrapper","sortableId"],"sources":["../../../../src/drag-and-drop/table/DroppableTableContext.tsx"],"sourcesContent":["import React, { useCallback, useMemo, RefObject } from 'react';\nimport { createPortal } from 'react-dom';\nimport {\n  AutoScrollActivator,\n  closestCenter,\n  CollisionDetection,\n  DndContext,\n  DndContextProps,\n  DragCancelEvent,\n  DragEndEvent,\n  DragStartEvent,\n  useSensor,\n  useSensors,\n} from '@dnd-kit/core';\nimport {\n  hasSortableData,\n  SortableContext,\n  SortableContextProps,\n  sortableKeyboardCoordinates,\n  verticalListSortingStrategy,\n} from '@dnd-kit/sortable';\nimport { useUniqueId } from '@dnd-kit/utilities';\nimport type { TableProps } from '@wix/design-system';\nimport { KeyboardSensor, PointerSensor } from './sensors';\nimport { classes, st } from './DroppableTableContext.st.css.js';\nimport { TableTestWrapper } from './TestWrappers';\nimport { useDragAndDropContext } from './DragAndDropContext';\nimport { TableRowDragOverlay } from './TableRowDragOverlay';\nimport { TableRowHorizontalScrollDragOverlay } from './TableRowHorizontalScrollDragOverlay';\nimport { restrictKeyboardToVerticalAxis } from './restrictKeyboardToVerticalAxis';\nimport '../../styles.global.css';\n\ntype TableElementProps = TableProps<{\n  id: string | number;\n}> &\n  React.HTMLAttributes<HTMLTableElement> & {\n    ref?: RefObject<HTMLElement>;\n  };\n\ntype TableElement = React.FunctionComponentElement<TableElementProps>;\n\nexport interface DroppableTableContextProps {\n  children: TableElement;\n  items: SortableContextProps['items'];\n  onDragEnd?(event: DragEndEvent): unknown;\n  onDragStart?(event: DragStartEvent): unknown;\n  onDragCancel?(event: DragCancelEvent): unknown;\n  isDragAndDropDisabled?: boolean;\n  horizontalScroll?: boolean;\n  className?: string;\n  style?: React.CSSProperties;\n  renderRow?: (args: {\n    rowNum: number;\n    rowData: any;\n    isDragOverlay: boolean;\n  }) => React.ReactElement;\n  renderTableContainer?: (children?: React.ReactElement) => React.ReactElement;\n}\n\nexport function DroppableTableContext(props: DroppableTableContextProps) {\n  const {\n    children,\n    items,\n    className,\n    style,\n    onDragEnd,\n    onDragStart,\n    onDragCancel,\n    isDragAndDropDisabled,\n    horizontalScroll,\n    renderRow,\n    renderTableContainer,\n  } = props;\n  const { type: Table, props: tableProps, ref } = children;\n\n  const {\n    cancelDrop,\n    announcements,\n    onDragOver,\n    onDragMove,\n    a11yContainer,\n    keyboardCodes,\n    consumers,\n    restoreFocus,\n    autoScrollOptions,\n    closestCenterOnViewPort,\n  } = useDragAndDropContext();\n  const [activeIndex, setActiveIndex] = React.useState<number | null>(null);\n  const pointerSensor = useSensor(PointerSensor, {\n    activationConstraint: {\n      distance: 1,\n    },\n  });\n  const keyboardSensor = useSensor(KeyboardSensor, {\n    coordinateGetter: sortableKeyboardCoordinates,\n    keyboardCodes,\n  });\n  const uniqueSortableId = useUniqueId('Sortable');\n\n  const onDragStartHandler = useCallback(\n    (event: DragStartEvent) => {\n      if (hasSortableData(event.active)) {\n        setActiveIndex(event.active.data.current.sortable.index);\n      }\n      onDragStart?.(event);\n    },\n    [onDragStart],\n  );\n\n  const onDragEndHandler = useCallback(\n    (event: DragEndEvent) => {\n      setActiveIndex(null);\n      onDragEnd?.(event);\n    },\n    [onDragEnd],\n  );\n\n  const onDragCancelHandler = useCallback(\n    (event: DragCancelEvent) => {\n      setActiveIndex(null);\n      onDragCancel?.(event);\n    },\n    [onDragCancel],\n  );\n\n  const sensors = useSensors(\n    ...(process.env.NODE_ENV === 'test' ? [] : [pointerSensor, keyboardSensor]),\n  );\n\n  const calcClosestCenterOnViewPort: CollisionDetection = (params) => {\n    if (ref) {\n      const filteredDroppableContainers = params.droppableContainers.filter(\n        (item) => {\n          if (!item.node.current || !ref.current) {\n            return false;\n          }\n\n          const itemRect = item.node.current.getBoundingClientRect();\n\n          return itemRect.top >= 0 && itemRect.bottom <= window.innerHeight;\n        },\n      );\n\n      return closestCenter({\n        ...params,\n        droppableContainers: filteredDroppableContainers,\n      });\n    }\n    return closestCenter(params);\n  };\n\n  const renderTableOverlay = () => {\n    if (activeIndex === null) {\n      return null;\n    }\n\n    let child = (\n      <table className={className} style={style}>\n        <tbody>\n          {renderRow?.({\n            rowNum: activeIndex,\n            rowData: items[activeIndex],\n            isDragOverlay: true,\n          })}\n        </tbody>\n      </table>\n    );\n\n    if (renderTableContainer) {\n      child = renderTableContainer(child);\n    }\n\n    return child;\n  };\n\n  const autoScroll = useMemo<DndContextProps['autoScroll']>(\n    () => ({\n      activator: AutoScrollActivator.DraggableRect,\n      acceleration: 4,\n      canScroll: (element) => {\n        if (\n          Array.from(element.classList).some((className) =>\n            className.includes('tableBodyScrollContent'),\n          )\n        ) {\n          return false;\n        }\n\n        return true;\n      },\n      freeze: true,\n      threshold: {\n        y: 0.1,\n        x: 0,\n      },\n      ...autoScrollOptions,\n    }),\n    [],\n  );\n\n  const DragOverlayType = horizontalScroll\n    ? TableRowHorizontalScrollDragOverlay\n    : TableRowDragOverlay;\n\n  const modifiers = useMemo(\n    () => (horizontalScroll ? [restrictKeyboardToVerticalAxis] : []),\n    [horizontalScroll],\n  );\n\n  let dndContext = (\n    <DndContext\n      sensors={sensors}\n      accessibility={{\n        container: a11yContainer as Element | undefined,\n        announcements,\n        screenReaderInstructions: {\n          draggable: '',\n        },\n        restoreFocus,\n      }}\n      autoScroll={autoScroll}\n      collisionDetection={\n        closestCenterOnViewPort ? calcClosestCenterOnViewPort : closestCenter\n      }\n      onDragStart={onDragStartHandler}\n      onDragCancel={onDragCancelHandler}\n      onDragEnd={onDragEndHandler}\n      onDragOver={onDragOver}\n      onDragMove={onDragMove}\n      cancelDrop={cancelDrop}\n      modifiers={modifiers}\n    >\n      <SortableContext\n        id={uniqueSortableId}\n        items={items}\n        strategy={verticalListSortingStrategy}\n      >\n        <Table\n          {...tableProps}\n          ref={ref}\n          className={st(\n            classes.root,\n            {\n              droppable: !isDragAndDropDisabled,\n            },\n            tableProps.className,\n          )}\n          {...announcements?.listAttributes?.()}\n        />\n        {consumers}\n      </SortableContext>\n      {createPortal(\n        <DragOverlayType>{renderTableOverlay()}</DragOverlayType>,\n        a11yContainer ?? document.body,\n      )}\n    </DndContext>\n  );\n\n  if (process.env.NODE_ENV === 'test') {\n    dndContext = (\n      <TableTestWrapper sortableId={uniqueSortableId}>\n        {dndContext}\n      </TableTestWrapper>\n    );\n  }\n\n  return dndContext;\n}\n"],"mappings":"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","ignoreList":[]}