{"version":3,"names":["React","useCallback","useMemo","createPortal","AutoScrollActivator","closestCenter","DndContext","useSensor","useSensors","hasSortableData","SortableContext","sortableKeyboardCoordinates","verticalListSortingStrategy","useUniqueId","KeyboardSensor","PointerSensor","classes","st","TableTestWrapper","useDragAndDropContext","TableRowDragOverlay","TableRowHorizontalScrollDragOverlay","restrictKeyboardToVerticalAxis","DroppableTableContext","props","children","items","className","style","onDragEnd","onDragStart","onDragCancel","isDragAndDropDisabled","horizontalScroll","renderRow","renderTableContainer","type","Table","tableProps","ref","cancelDrop","announcements","onDragOver","onDragMove","a11yContainer","keyboardCodes","consumers","restoreFocus","autoScrollOptions","closestCenterOnViewPort","activeIndex","setActiveIndex","useState","pointerSensor","activationConstraint","distance","keyboardSensor","coordinateGetter","uniqueSortableId","onDragStartHandler","event","active","data","current","sortable","index","onDragEndHandler","onDragCancelHandler","sensors","process","env","NODE_ENV","calcClosestCenterOnViewPort","params","filteredDroppableContainers","droppableContainers","filter","item","node","itemRect","getBoundingClientRect","top","bottom","window","innerHeight","renderTableOverlay","child","createElement","rowNum","rowData","isDragOverlay","autoScroll","activator","DraggableRect","acceleration","canScroll","element","Array","from","classList","some","includes","freeze","threshold","y","x","DragOverlayType","modifiers","dndContext","accessibility","container","screenReaderInstructions","draggable","collisionDetection","id","strategy","_extends","root","droppable","listAttributes","document","body","sortableId"],"sources":["../../../../src/drag-and-drop/table/DroppableTableContext.tsx"],"sourcesContent":["import React, { useCallback, useMemo, RefObject } from 'react';\nimport { createPortal } from 'react-dom';\nimport {\n  AutoScrollActivator,\n  closestCenter,\n  CollisionDetection,\n  DndContext,\n  DndContextProps,\n  DragCancelEvent,\n  DragEndEvent,\n  DragStartEvent,\n  useSensor,\n  useSensors,\n} from '@dnd-kit/core';\nimport {\n  hasSortableData,\n  SortableContext,\n  SortableContextProps,\n  sortableKeyboardCoordinates,\n  verticalListSortingStrategy,\n} from '@dnd-kit/sortable';\nimport { useUniqueId } from '@dnd-kit/utilities';\nimport type { TableProps } from '@wix/design-system';\nimport { KeyboardSensor, PointerSensor } from './sensors';\nimport { classes, st } from './DroppableTableContext.st.css.js';\nimport { TableTestWrapper } from './TestWrappers';\nimport { useDragAndDropContext } from './DragAndDropContext';\nimport { TableRowDragOverlay } from './TableRowDragOverlay';\nimport { TableRowHorizontalScrollDragOverlay } from './TableRowHorizontalScrollDragOverlay';\nimport { restrictKeyboardToVerticalAxis } from './restrictKeyboardToVerticalAxis';\nimport '../../styles.global.css';\n\ntype TableElementProps = TableProps<{\n  id: string | number;\n}> &\n  React.HTMLAttributes<HTMLTableElement> & {\n    ref?: RefObject<HTMLElement>;\n  };\n\ntype TableElement = React.FunctionComponentElement<TableElementProps>;\n\nexport interface DroppableTableContextProps {\n  children: TableElement;\n  items: SortableContextProps['items'];\n  onDragEnd?(event: DragEndEvent): unknown;\n  onDragStart?(event: DragStartEvent): unknown;\n  onDragCancel?(event: DragCancelEvent): unknown;\n  isDragAndDropDisabled?: boolean;\n  horizontalScroll?: boolean;\n  className?: string;\n  style?: React.CSSProperties;\n  renderRow?: (args: {\n    rowNum: number;\n    rowData: any;\n    isDragOverlay: boolean;\n  }) => React.ReactElement;\n  renderTableContainer?: (children?: React.ReactElement) => React.ReactElement;\n}\n\nexport function DroppableTableContext(props: DroppableTableContextProps) {\n  const {\n    children,\n    items,\n    className,\n    style,\n    onDragEnd,\n    onDragStart,\n    onDragCancel,\n    isDragAndDropDisabled,\n    horizontalScroll,\n    renderRow,\n    renderTableContainer,\n  } = props;\n  const { type: Table, props: tableProps, ref } = children;\n\n  const {\n    cancelDrop,\n    announcements,\n    onDragOver,\n    onDragMove,\n    a11yContainer,\n    keyboardCodes,\n    consumers,\n    restoreFocus,\n    autoScrollOptions,\n    closestCenterOnViewPort,\n  } = useDragAndDropContext();\n  const [activeIndex, setActiveIndex] = React.useState<number | null>(null);\n  const pointerSensor = useSensor(PointerSensor, {\n    activationConstraint: {\n      distance: 1,\n    },\n  });\n  const keyboardSensor = useSensor(KeyboardSensor, {\n    coordinateGetter: sortableKeyboardCoordinates,\n    keyboardCodes,\n  });\n  const uniqueSortableId = useUniqueId('Sortable');\n\n  const onDragStartHandler = useCallback(\n    (event: DragStartEvent) => {\n      if (hasSortableData(event.active)) {\n        setActiveIndex(event.active.data.current.sortable.index);\n      }\n      onDragStart?.(event);\n    },\n    [onDragStart],\n  );\n\n  const onDragEndHandler = useCallback(\n    (event: DragEndEvent) => {\n      setActiveIndex(null);\n      onDragEnd?.(event);\n    },\n    [onDragEnd],\n  );\n\n  const onDragCancelHandler = useCallback(\n    (event: DragCancelEvent) => {\n      setActiveIndex(null);\n      onDragCancel?.(event);\n    },\n    [onDragCancel],\n  );\n\n  const sensors = useSensors(\n    ...(process.env.NODE_ENV === 'test' ? [] : [pointerSensor, keyboardSensor]),\n  );\n\n  const calcClosestCenterOnViewPort: CollisionDetection = (params) => {\n    if (ref) {\n      const filteredDroppableContainers = params.droppableContainers.filter(\n        (item) => {\n          if (!item.node.current || !ref.current) {\n            return false;\n          }\n\n          const itemRect = item.node.current.getBoundingClientRect();\n\n          return itemRect.top >= 0 && itemRect.bottom <= window.innerHeight;\n        },\n      );\n\n      return closestCenter({\n        ...params,\n        droppableContainers: filteredDroppableContainers,\n      });\n    }\n    return closestCenter(params);\n  };\n\n  const renderTableOverlay = () => {\n    if (activeIndex === null) {\n      return null;\n    }\n\n    let child = (\n      <table className={className} style={style}>\n        <tbody>\n          {renderRow?.({\n            rowNum: activeIndex,\n            rowData: items[activeIndex],\n            isDragOverlay: true,\n          })}\n        </tbody>\n      </table>\n    );\n\n    if (renderTableContainer) {\n      child = renderTableContainer(child);\n    }\n\n    return child;\n  };\n\n  const autoScroll = useMemo<DndContextProps['autoScroll']>(\n    () => ({\n      activator: AutoScrollActivator.DraggableRect,\n      acceleration: 4,\n      canScroll: (element) => {\n        if (\n          Array.from(element.classList).some((className) =>\n            className.includes('tableBodyScrollContent'),\n          )\n        ) {\n          return false;\n        }\n\n        return true;\n      },\n      freeze: true,\n      threshold: {\n        y: 0.1,\n        x: 0,\n      },\n      ...autoScrollOptions,\n    }),\n    [],\n  );\n\n  const DragOverlayType = horizontalScroll\n    ? TableRowHorizontalScrollDragOverlay\n    : TableRowDragOverlay;\n\n  const modifiers = useMemo(\n    () => (horizontalScroll ? [restrictKeyboardToVerticalAxis] : []),\n    [horizontalScroll],\n  );\n\n  let dndContext = (\n    <DndContext\n      sensors={sensors}\n      accessibility={{\n        container: a11yContainer as Element | undefined,\n        announcements,\n        screenReaderInstructions: {\n          draggable: '',\n        },\n        restoreFocus,\n      }}\n      autoScroll={autoScroll}\n      collisionDetection={\n        closestCenterOnViewPort ? calcClosestCenterOnViewPort : closestCenter\n      }\n      onDragStart={onDragStartHandler}\n      onDragCancel={onDragCancelHandler}\n      onDragEnd={onDragEndHandler}\n      onDragOver={onDragOver}\n      onDragMove={onDragMove}\n      cancelDrop={cancelDrop}\n      modifiers={modifiers}\n    >\n      <SortableContext\n        id={uniqueSortableId}\n        items={items}\n        strategy={verticalListSortingStrategy}\n      >\n        <Table\n          {...tableProps}\n          ref={ref}\n          className={st(\n            classes.root,\n            {\n              droppable: !isDragAndDropDisabled,\n            },\n            tableProps.className,\n          )}\n          {...announcements?.listAttributes?.()}\n        />\n        {consumers}\n      </SortableContext>\n      {createPortal(\n        <DragOverlayType>{renderTableOverlay()}</DragOverlayType>,\n        a11yContainer ?? document.body,\n      )}\n    </DndContext>\n  );\n\n  if (process.env.NODE_ENV === 'test') {\n    dndContext = (\n      <TableTestWrapper sortableId={uniqueSortableId}>\n        {dndContext}\n      </TableTestWrapper>\n    );\n  }\n\n  return dndContext;\n}\n"],"mappings":"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","ignoreList":[]}