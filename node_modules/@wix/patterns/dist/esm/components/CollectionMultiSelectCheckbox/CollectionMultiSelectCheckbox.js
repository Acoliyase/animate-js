import React, { useEffect, useState } from 'react';
import { CollectionFilterState, DropdownCollectionFilterState, } from '../../state';
import { TextOverflowState } from '@wix/bex-core';
import { useWixPatternsContainer } from '@wix/bex-core/react';
import { observer } from 'mobx-react-lite';
import { MultiSelectCheckboxFilterBase, } from '../MultiSelectCheckboxFilterBase';
import { InputOverflow } from '../InputOverflow';
import { useFilterToolbarState, useDropdownTranslationContext, } from '../../providers';
import { useCollectionFilterInitialFetchTiming, } from '../../hooks/useCollectionFilterInitialFetchTiming';
import { useFilterCollectionStates } from '../../hooks/useFilterCollectionStates';
import { useCollectionOptions } from '../../hooks/useCollectionOptions';
import { useDropdownPlaceholder } from '../../hooks/useDropdownPlaceholder';
function _CollectionMultiSelectCheckbox(props) {
    const { filter, collection, renderItem, onSelect, onClose, onOptionsShow, onDeselect, placeholder: placeholderProp, ...rest } = props;
    const container = useWixPatternsContainer();
    const toolbar = useFilterToolbarState();
    const { translate } = useDropdownTranslationContext();
    const [collectionFilter] = useState(() => new CollectionFilterState({
        collection,
        filter,
    }));
    const [dropdownCollectionFilterState] = useState(() => new DropdownCollectionFilterState({
        resetOnClose: false,
        collectionFilter,
        container,
        toolbar,
    }));
    const { dropdownSelect, init, inputState, shouldShowPlaceholder } = dropdownCollectionFilterState;
    const { disableEditing } = inputState;
    const { select: { selectedKeys, selectedValues }, } = dropdownSelect;
    const [textOverflowState] = useState(() => new TextOverflowState({
        observable: () => dropdownSelect.select.selectedValues,
    }));
    const { isOverflow } = textOverflowState;
    const { fetchedLastPage } = collection;
    const { fixedFooter, showInitialLoader } = useFilterCollectionStates({
        collection,
        fixedFooter: rest.fixedFooter,
    });
    const { skipInitialFetch, onFocus } = useCollectionFilterInitialFetchTiming(props);
    useEffect(() => init({ skipInitialFetch }), []);
    const { selectedValuesText, placeholder } = useDropdownPlaceholder({
        dropdownSelect,
        filter,
        shouldShowPlaceholder,
        isOverflow,
        placeholderProp,
    });
    const { options } = useCollectionOptions({
        collection,
        dropdownCollectionFilterState,
        renderItem,
        filter,
    });
    return (React.createElement(MultiSelectCheckboxFilterBase, { ...rest, fixedFooter: fixedFooter, infiniteScroll: true, filter: filter, dropdownSelect: dropdownSelect, options: options, selectedOptions: selectedKeys, hasMore: !showInitialLoader && !fetchedLastPage, loadMore: collection.fetchNextPageIfNeeded, onClose: () => {
            if (!dropdownSelect.hasPendingFilter) {
                dropdownSelect.closeAndChangeSelectedItems();
            }
            else {
                dropdownSelect.close();
            }
            inputState.onBlur();
            onClose?.();
        }, onSelect: (id, option) => {
            const { keyedItem } = option;
            dropdownSelect.set(keyedItem);
            onSelect?.(id, option);
        }, onDeselect: (id, option) => {
            const { keyedItem } = option;
            dropdownSelect.delete(keyedItem);
            onDeselect?.(id, option);
        }, value: collection.query.search.value, onFocus: () => {
            inputState.onFocus();
            onFocus();
        }, onBlur: () => {
            inputState.onBlur();
        }, onChange: (e) => {
            collection.search(e.target.value, { clearResult: true });
        }, onOptionsShow: () => {
            dropdownCollectionFilterState.onOptionsShow();
            inputState.onOptionsShow();
            onOptionsShow?.();
        }, onKeyDown: (e) => {
            if (e.nativeEvent.code === 'Tab') {
                inputState.onTabKeyDown();
            }
        }, onClickOutside: (e) => {
            props.onClickOutside?.(e);
            inputState.onClickOutside();
        }, onClear: () => {
            inputState.onBlur();
            collection.clearSearch();
        }, disableEditing: disableEditing, placeholder: placeholder, clearButton: !disableEditing, clearButtonTooltipContent: translate('clearButtonTooltip'), focusOnClearClick: true, inputElement: React.createElement(InputOverflow, { selected: selectedValues.length > 0, focused: inputState.isFocused, text: selectedValuesText, state: textOverflowState }) }));
}
export const CollectionMultiSelectCheckbox = observer(_CollectionMultiSelectCheckbox);
//# sourceMappingURL=CollectionMultiSelectCheckbox.js.map