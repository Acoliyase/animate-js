import { delay } from '../delay';
import { ExpectError } from '../errors/ExpectError';
import { TimeoutError } from '../errors/TimeoutError';
export const awaiter = async (fn, params) => {
    const startTime = Date.now();
    const { awaiterName, expect, message, id, originalFn } = params;
    const interval = params.interval ?? params.retryDelay ?? 30;
    const timeout = params.timeout ?? 1_000;
    let lastError = new Error();
    while (Date.now() - startTime < timeout) {
        try {
            const received = await fn();
            if ('expect' in params) {
                if (expect === received) {
                    return;
                }
                else {
                    throw new ExpectError({ expected: expect, received });
                }
            }
            return;
        }
        catch (e) {
            lastError = e instanceof Error ? e : new Error(String(e));
            await delay(interval);
        }
    }
    throw new TimeoutError({
        awaiterName,
        fn: originalFn ?? fn,
        cause: lastError,
        timeout,
        message,
        id,
    });
};
//# sourceMappingURL=awaiter.js.map