"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.awaiter = void 0;
const delay_1 = require("../delay");
const ExpectError_1 = require("../errors/ExpectError");
const TimeoutError_1 = require("../errors/TimeoutError");
const awaiter = async (fn, params) => {
    const startTime = Date.now();
    const { awaiterName, expect, message, id, originalFn } = params;
    const interval = params.interval ?? params.retryDelay ?? 30;
    const timeout = params.timeout ?? 1_000;
    let lastError = new Error();
    while (Date.now() - startTime < timeout) {
        try {
            const received = await fn();
            if ('expect' in params) {
                if (expect === received) {
                    return;
                }
                else {
                    throw new ExpectError_1.ExpectError({ expected: expect, received });
                }
            }
            return;
        }
        catch (e) {
            lastError = e instanceof Error ? e : new Error(String(e));
            await (0, delay_1.delay)(interval);
        }
    }
    throw new TimeoutError_1.TimeoutError({
        awaiterName,
        fn: originalFn ?? fn,
        cause: lastError,
        timeout,
        message,
        id,
    });
};
exports.awaiter = awaiter;
//# sourceMappingURL=awaiter.js.map