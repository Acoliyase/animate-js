{"version":3,"names":["_Expression","require","GroupStageImpl","constructor","_defineProperty2","default","by","expression","key","ids","push","sum","resultFieldName","addAccumulator","avg","min","max","count","NumericExpressionImpl","first","last","type","accumulators","build","group","groupIds","map","id","accumulator","exports"],"sources":["../../../../src/api/stages/GroupStage.ts"],"sourcesContent":["import { Expression, NumericExpressionImpl } from '../expressions/Expression'\nimport * as apiTypes from '../../types/data-item-types'\nimport { PipelineStage } from './stages'\n\n/**\n * @builder\n */\nexport interface GroupStage extends PipelineStage {\n  /**\n   * Specifies how to group items in the result.\n   *\n   * The `by()` method configures the aggregation pipeline to group items for which the specified `expression` resolves to the same value. The `key` and resolved `expression` determine the result item's unique `_id` property.\n   *\n   * > **Note**: When `by()` is not called or when it is called with no parameters, all items are placed in a single group.\n   *\n   * @param expression - Expression to determine the grouping value. Items with matching values are grouped together. Learn more about using [expressions in aggregation pipelines](https://dev.wix.com/docs/sdk/backend-modules/data/items/wix-data-aggregate-pipeline-expressions/introduction).\n   * @param key - Name of the field in the result that contains the grouping value.\n   * @returns GroupStage object.\n   */\n  by(expression: Expression, key: string): GroupStage\n  /**\n   * Calculates the sum of the specified expression across all items in the group.\n   *\n   * The `sum()` method refines the aggregation pipeline to calculate the sum of the specified expression across all items in the group.\n   *\n   * @public\n   * @documentationMaturity preview\n   * @param expression - Expression to calculate the group's total sum. Expression must resolve to a number. Learn more about using [expressions in aggregation pipelines](https://dev.wix.com/docs/sdk/backend-modules/data/items/wix-data-aggregate-pipeline-expressions/introduction).\n   * @param resultFieldName - Field to store the result in.\n   *\n   * Learn more about [field keys](https://support.wix.com/en/article/cms-formerly-content-manager-about-your-collection-fields#field-id-velo-by-wix-only).\n   * @returns GroupStage object.\n   */\n  sum(expression: Expression, resultFieldName: string): GroupStage\n  /**\n   * Calculates the average value across all items in the group based on the specified expression.\n   *\n   * The `avg()` method refines the aggregation pipeline to calculate the average value of the specified expression across all items in the group.\n   *\n   * @public\n   * @documentationMaturity preview\n   * @param expression - Expression to calculate the group's average value. The expression must resolve to a number. Learn more about using [expressions in aggregation pipelines](https://dev.wix.com/docs/sdk/backend-modules/data/items/wix-data-aggregate-pipeline-expressions/introduction).\n   * @param resultFieldName - Field to store the result in.\n   *\n   * Learn more about [field keys](https://support.wix.com/en/article/cms-formerly-content-manager-about-your-collection-fields#field-id-velo-by-wix-only).\n   * @returns GroupStage object.\n   */\n  avg(expression: Expression, resultFieldName: string): GroupStage\n  /**\n   * Finds the minimum value across all items in the group.\n   *\n   * The `min()` method refines the aggregation pipeline to find the minimum value of the specified field across all the items in the group.\n   *\n   * @public\n   * @documentationMaturity preview\n   * @param expression - Expression to find the group's minimum value. Expression must resolve to a comparable value, such as a number or string. Learn more about using [expressions in aggregation pipelines](https://dev.wix.com/docs/sdk/backend-modules/data/items/wix-data-aggregate-pipeline-expressions/introduction).\n   * @param resultFieldName - Field to store the result in.\n   *\n   * Learn more about [field keys](https://support.wix.com/en/article/cms-formerly-content-manager-about-your-collection-fields#field-id-velo-by-wix-only).\n   * @returns GroupStage object.\n   */\n  min(expression: Expression, resultFieldName: string): GroupStage\n  /**\n   * Finds the maximum value across all items in the group.\n   *\n   * The `max()` method refines the aggregation pipeline to find the maximum value of the specified field across all the items in the group.\n   *\n   * @public\n   * @documentationMaturity preview\n   * @param expression - Expression to find the group's maximum value. Expression must resolve to a comparable value, such as a number or string. Learn more about using [expressions in aggregation pipelines](https://dev.wix.com/docs/sdk/backend-modules/data/items/wix-data-aggregate-pipeline-expressions/introduction).\n   * @param resultFieldName - Field to store the result in.\n   *\n   * Learn more about [field keys](https://support.wix.com/en/article/cms-formerly-content-manager-about-your-collection-fields#field-id-velo-by-wix-only).\n   * @returns GroupStage object.\n   */\n  max(expression: Expression, resultFieldName: string): GroupStage\n  /**\n   * Counts the number of items in the group.\n   *\n   * The `count()` method refines the aggregation pipeline to count the number of items in the group.\n   *\n   * @public\n   * @documentationMaturity preview\n   * @param resultFieldName - Field to store the result in.\n   *\n   * Learn more about [field keys](https://support.wix.com/en/article/cms-formerly-content-manager-about-your-collection-fields#field-id-velo-by-wix-only).\n   * @returns GroupStage object.\n   */\n  count(resultFieldName: string): GroupStage\n  /**\n   * Finds the first item in the group.\n   *\n   * The `first()` method refines the aggregation pipeline to find the first item in the group.\n   *\n   * @public\n   * @documentationMaturity preview\n   * @param expression - Expression to find the first item in the group. Learn more about using [expressions in aggregation pipelines](https://dev.wix.com/docs/sdk/backend-modules/data/items/wix-data-aggregate-pipeline-expressions/introduction).\n   * @param resultFieldName - Field to store the result in.\n   *\n   * Learn more about [field keys](https://support.wix.com/en/article/cms-formerly-content-manager-about-your-collection-fields#field-id-velo-by-wix-only).\n   * @returns GroupStage object.\n   */\n  first(expression: Expression, resultFieldName: string): GroupStage\n  /**\n   * Finds the last item in the group.\n   *\n   * The `last()` method refines the aggregation pipeline to find the last item in the group.\n   *\n   * @public\n   * @documentationMaturity preview\n   * @param expression - Expression to find the last item in the group. Learn more about using [expressions in aggregation pipelines](https://dev.wix.com/docs/sdk/backend-modules/data/items/wix-data-aggregate-pipeline-expressions/introduction).\n   * @param resultFieldName - Field to store the result in.\n   *\n   * Learn more about [field keys](https://support.wix.com/en/article/cms-formerly-content-manager-about-your-collection-fields#field-id-velo-by-wix-only).\n   * @returns GroupStage object.\n   */\n  last(expression: Expression, resultFieldName: string): GroupStage\n  /**\n   * Collects values from all items in the group into an array.\n   *\n   * The `push()` method refines the aggregation pipeline to collect values from all items in the group into an array.\n   *\n   * @public\n   * @documentationMaturity preview\n   * @param expression - Expression to collect items into an array. Learn more about using [expressions in aggregation pipelines](https://dev.wix.com/docs/sdk/backend-modules/data/items/wix-data-aggregate-pipeline-expressions/introduction).\n   * @param resultFieldName - Field to store the result in.\n   *\n   * Learn more about [field keys](https://support.wix.com/en/article/cms-formerly-content-manager-about-your-collection-fields#field-id-velo-by-wix-only).\n   * @returns GroupStage object.\n   */\n  push(expression: Expression, resultFieldName: string): GroupStage\n}\n\nexport class GroupStageImpl implements GroupStage {\n  private ids: Id[] = []\n  private accumulators: Accumulator[] = []\n\n  by(expression: Expression, key: string): GroupStage {\n    this.ids.push({ expression, key })\n    return this\n  }\n\n  sum(expression: Expression, resultFieldName: string): GroupStage {\n    return this.addAccumulator(expression, 'sum', resultFieldName)\n  }\n\n  avg(expression: Expression, resultFieldName: string): GroupStage {\n    return this.addAccumulator(expression, 'avg', resultFieldName)\n  }\n\n  min(expression: Expression, resultFieldName: string): GroupStage {\n    return this.addAccumulator(expression, 'min', resultFieldName)\n  }\n\n  max(expression: Expression, resultFieldName: string): GroupStage {\n    return this.addAccumulator(expression, 'max', resultFieldName)\n  }\n\n  count(resultFieldName: string): GroupStage {\n    return this.addAccumulator(\n      new NumericExpressionImpl(1),\n      'sum',\n      resultFieldName\n    )\n  }\n\n  first(expression: Expression, resultFieldName: string): GroupStage {\n    return this.addAccumulator(expression, 'first', resultFieldName)\n  }\n\n  last(expression: Expression, resultFieldName: string): GroupStage {\n    return this.addAccumulator(expression, 'last', resultFieldName)\n  }\n\n  push(expression: Expression, resultFieldName: string): GroupStage {\n    return this.addAccumulator(expression, 'push', resultFieldName)\n  }\n\n  private addAccumulator(\n    expression: Expression,\n    type: AccumulatorType,\n    resultFieldName: string\n  ): GroupStage {\n    this.accumulators.push({ type, expression, resultFieldName })\n    return this\n  }\n\n  /**\n   * @internal\n   */\n  build(): apiTypes.Stage {\n    return {\n      group: {\n        groupIds: this.ids.map((id) => ({\n          expression: id.expression.build(),\n          key: id.key,\n        })),\n        accumulators: this.accumulators.map((accumulator) => ({\n          [accumulator.type]: {\n            expression: accumulator.expression.build(),\n          },\n          resultFieldName: accumulator.resultFieldName,\n        })),\n      },\n    }\n  }\n}\n\ntype AccumulatorType = 'avg' | 'min' | 'max' | 'sum' | 'first' | 'last' | 'push'\n\ninterface Id {\n  expression: Expression\n  key: string\n}\n\ninterface Accumulator {\n  type: AccumulatorType\n  expression: Expression\n  resultFieldName: string\n}\n"],"mappings":";;;;;;AAAA,IAAAA,WAAA,GAAAC,OAAA;AAIA;AACA;AACA;;AA+HO,MAAMC,cAAc,CAAuB;EAAAC,YAAA;IAAA,IAAAC,gBAAA,CAAAC,OAAA,eAC5B,EAAE;IAAA,IAAAD,gBAAA,CAAAC,OAAA,wBACgB,EAAE;EAAA;EAExCC,EAAEA,CAACC,UAAsB,EAAEC,GAAW,EAAc;IAClD,IAAI,CAACC,GAAG,CAACC,IAAI,CAAC;MAAEH,UAAU;MAAEC;IAAI,CAAC,CAAC;IAClC,OAAO,IAAI;EACb;EAEAG,GAAGA,CAACJ,UAAsB,EAAEK,eAAuB,EAAc;IAC/D,OAAO,IAAI,CAACC,cAAc,CAACN,UAAU,EAAE,KAAK,EAAEK,eAAe,CAAC;EAChE;EAEAE,GAAGA,CAACP,UAAsB,EAAEK,eAAuB,EAAc;IAC/D,OAAO,IAAI,CAACC,cAAc,CAACN,UAAU,EAAE,KAAK,EAAEK,eAAe,CAAC;EAChE;EAEAG,GAAGA,CAACR,UAAsB,EAAEK,eAAuB,EAAc;IAC/D,OAAO,IAAI,CAACC,cAAc,CAACN,UAAU,EAAE,KAAK,EAAEK,eAAe,CAAC;EAChE;EAEAI,GAAGA,CAACT,UAAsB,EAAEK,eAAuB,EAAc;IAC/D,OAAO,IAAI,CAACC,cAAc,CAACN,UAAU,EAAE,KAAK,EAAEK,eAAe,CAAC;EAChE;EAEAK,KAAKA,CAACL,eAAuB,EAAc;IACzC,OAAO,IAAI,CAACC,cAAc,CACxB,IAAIK,iCAAqB,CAAC,CAAC,CAAC,EAC5B,KAAK,EACLN,eACF,CAAC;EACH;EAEAO,KAAKA,CAACZ,UAAsB,EAAEK,eAAuB,EAAc;IACjE,OAAO,IAAI,CAACC,cAAc,CAACN,UAAU,EAAE,OAAO,EAAEK,eAAe,CAAC;EAClE;EAEAQ,IAAIA,CAACb,UAAsB,EAAEK,eAAuB,EAAc;IAChE,OAAO,IAAI,CAACC,cAAc,CAACN,UAAU,EAAE,MAAM,EAAEK,eAAe,CAAC;EACjE;EAEAF,IAAIA,CAACH,UAAsB,EAAEK,eAAuB,EAAc;IAChE,OAAO,IAAI,CAACC,cAAc,CAACN,UAAU,EAAE,MAAM,EAAEK,eAAe,CAAC;EACjE;EAEQC,cAAcA,CACpBN,UAAsB,EACtBc,IAAqB,EACrBT,eAAuB,EACX;IACZ,IAAI,CAACU,YAAY,CAACZ,IAAI,CAAC;MAAEW,IAAI;MAAEd,UAAU;MAAEK;IAAgB,CAAC,CAAC;IAC7D,OAAO,IAAI;EACb;;EAEA;AACF;AACA;EACEW,KAAKA,CAAA,EAAmB;IACtB,OAAO;MACLC,KAAK,EAAE;QACLC,QAAQ,EAAE,IAAI,CAAChB,GAAG,CAACiB,GAAG,CAAEC,EAAE,KAAM;UAC9BpB,UAAU,EAAEoB,EAAE,CAACpB,UAAU,CAACgB,KAAK,CAAC,CAAC;UACjCf,GAAG,EAAEmB,EAAE,CAACnB;QACV,CAAC,CAAC,CAAC;QACHc,YAAY,EAAE,IAAI,CAACA,YAAY,CAACI,GAAG,CAAEE,WAAW,KAAM;UACpD,CAACA,WAAW,CAACP,IAAI,GAAG;YAClBd,UAAU,EAAEqB,WAAW,CAACrB,UAAU,CAACgB,KAAK,CAAC;UAC3C,CAAC;UACDX,eAAe,EAAEgB,WAAW,CAAChB;QAC/B,CAAC,CAAC;MACJ;IACF,CAAC;EACH;AACF;AAACiB,OAAA,CAAA3B,cAAA,GAAAA,cAAA","ignoreList":[]}