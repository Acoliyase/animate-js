{"version":3,"names":["open","getMonitoringClientFunction","registerHeightReporter","isWixOrigin","registerBeforeUnloadHandler","getEssentialsFromQueryParams","createHost","config","searchString","fullUrl","URL","search","window","location","queryParams","URLSearchParams","origin","get","postMessage","parent","bind","Error","channel","close","closeMethods","autoHeightUpdate","undefined","element","autoHeightElement","document","documentElement","clearHeightReport","push","onBeforeUnload","clearBeforeUnloadHandler","siteInfo","parseSiteInfo","getSiteInfoSync","channelProxy","Proxy","target","prop","receiver","Reflect","monitoring","essentials","getMonitoringClient","hostContext","context","monitoringConfig","sentrySDK","Sentry","forEach","method","JSON","parse","decodeURIComponent","e","console","warn"],"sources":["../../src/hostPlatform.ts"],"sourcesContent":["import { open } from '@wix/communication-channel';\nimport { getMonitoringClientFunction } from '@wix/monitoring-browser-sdk-host';\nimport { CreateHost, ProviderAPI, OnBeforeUnload } from './types';\nimport { registerHeightReporter } from './helpers/registerHeightReporter';\nimport { isWixOrigin } from './helpers/isWixOrigin';\nimport { registerBeforeUnloadHandler } from './helpers/registerOnBeforeUnload';\nimport { getEssentialsFromQueryParams } from './helpers/essentials';\nimport { GetSiteInfo } from './types/getSiteInfo';\n\ndeclare global {\n  interface Window {\n    Sentry?: any;\n  }\n}\n\nexport const createHost: CreateHost = function (config = {}) {\n  // when full url is provided (worker case) use it and ignore own location search\n  const searchString =\n    (config.fullUrl && new URL(config.fullUrl).search) ||\n    (typeof window !== 'undefined' && window.location.search) ||\n    '';\n  const queryParams = new URLSearchParams(searchString);\n  const origin = config.origin || queryParams.get('origin') || '';\n  const postMessage =\n    config.postMessage || window.parent.postMessage.bind(window.parent);\n\n  if (!isWixOrigin(origin)) {\n    throw new Error(\n      `Wix Dashboard SDK: Unable to establish a connection with the Wix dashboard. Please ensure that you are running your app within the Wix dashboard.`,\n    );\n  }\n\n  const { channel, close } = open<ProviderAPI>({ postMessage, origin });\n  const closeMethods = [close];\n\n  if (config.autoHeightUpdate === undefined || config.autoHeightUpdate) {\n    const element = config.autoHeightElement || document.documentElement;\n    const clearHeightReport = registerHeightReporter(channel, element);\n    closeMethods.push(() => clearHeightReport());\n  }\n\n  const { onBeforeUnload, clearBeforeUnloadHandler } =\n    registerBeforeUnloadHandler(channel);\n  closeMethods.push(clearBeforeUnloadHandler);\n\n  const siteInfo = parseSiteInfo(queryParams.get('siteInfo') || '');\n  const getSiteInfoSync: GetSiteInfo = () => siteInfo;\n\n  const channelProxy = new Proxy(channel, {\n    get(target, prop, receiver) {\n      if (prop === 'onBeforeUnload') {\n        return onBeforeUnload;\n      }\n      if (prop === 'getSiteInfo') {\n        return getSiteInfoSync;\n      }\n      return Reflect.get(target, prop, receiver);\n    },\n  }) as typeof channel & {\n    onBeforeUnload: OnBeforeUnload;\n    getSiteInfo: GetSiteInfo; // keeping it sync\n  };\n\n  const { monitoring, ...essentials } =\n    getEssentialsFromQueryParams(queryParams) || {};\n\n  const getMonitoringClient = getMonitoringClientFunction({\n    hostContext: monitoring?.context,\n    monitoringConfig: monitoring?.config,\n    sentrySDK: typeof window !== 'undefined' ? window.Sentry : undefined,\n  });\n\n  return {\n    channel: channelProxy,\n    close: () => closeMethods.forEach((method) => method()),\n    getMonitoringClient,\n    essentials,\n  };\n};\n\nconst parseSiteInfo = (siteInfo: string) => {\n  try {\n    return JSON.parse(decodeURIComponent(siteInfo));\n  } catch (e) {\n    console.warn(\n      'Failed to parse \"siteInfo\" query parameter. Make sure to run the code inside a supported Wix App extension.',\n      e,\n    );\n    return {};\n  }\n};\n"],"mappings":"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","ignoreList":[]}