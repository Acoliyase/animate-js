{"version":3,"names":["registerBeforeUnloadHandler","channel","eventTarget","EventTarget","isInWorker","window","onIframeBeforeUnload","event","shouldUnloadWithoutConfirmation","dispatchEvent","CustomEvent","cancelable","preventDefault","returnValue","onBeforeUnloadHandle","onBeforeUnload","clearBeforeUnloadHandler","removeEventListener","then","remove","addEventListener","callback","exports"],"sources":["../../../src/helpers/registerOnBeforeUnload.ts"],"sourcesContent":["import { OpenedChannel } from '@wix/communication-channel';\nimport { ProviderAPI, OnBeforeUnload } from '../types';\n\nexport const registerBeforeUnloadHandler = (\n  channel: OpenedChannel<ProviderAPI>,\n) => {\n  const eventTarget = new EventTarget();\n  const isInWorker = typeof window === 'undefined';\n\n  const onIframeBeforeUnload = (event: BeforeUnloadEvent) => {\n    const shouldUnloadWithoutConfirmation = eventTarget.dispatchEvent(\n      new CustomEvent('beforeunload', {\n        cancelable: true,\n      }),\n    );\n\n    if (!shouldUnloadWithoutConfirmation) {\n      event.preventDefault();\n      event.returnValue = true; // Chrome requires returnValue to be set\n    }\n  };\n\n  const onBeforeUnloadHandle = channel.onBeforeUnload(onIframeBeforeUnload);\n\n  const clearBeforeUnloadHandler = () => {\n    if (!isInWorker) {\n      window.removeEventListener('beforeunload', onIframeBeforeUnload);\n    }\n    onBeforeUnloadHandle.then(({ remove }) => remove());\n  };\n  if (!isInWorker) {\n    window.addEventListener('beforeunload', onIframeBeforeUnload);\n    window.addEventListener('unload', clearBeforeUnloadHandler);\n  }\n\n  const onBeforeUnload: OnBeforeUnload = (callback) => {\n    eventTarget.addEventListener('beforeunload', callback);\n\n    const remove = () => {\n      eventTarget.removeEventListener('beforeunload', callback);\n    };\n\n    return { remove };\n  };\n\n  return { onBeforeUnload, clearBeforeUnloadHandler };\n};\n"],"mappings":";;;;AAGO,MAAMA,2BAA2B,GACtCC,OAAmC,IAChC;EACH,MAAMC,WAAW,GAAG,IAAIC,WAAW,CAAC,CAAC;EACrC,MAAMC,UAAU,GAAG,OAAOC,MAAM,KAAK,WAAW;EAEhD,MAAMC,oBAAoB,GAAIC,KAAwB,IAAK;IACzD,MAAMC,+BAA+B,GAAGN,WAAW,CAACO,aAAa,CAC/D,IAAIC,WAAW,CAAC,cAAc,EAAE;MAC9BC,UAAU,EAAE;IACd,CAAC,CACH,CAAC;IAED,IAAI,CAACH,+BAA+B,EAAE;MACpCD,KAAK,CAACK,cAAc,CAAC,CAAC;MACtBL,KAAK,CAACM,WAAW,GAAG,IAAI,CAAC,CAAC;IAC5B;EACF,CAAC;EAED,MAAMC,oBAAoB,GAAGb,OAAO,CAACc,cAAc,CAACT,oBAAoB,CAAC;EAEzE,MAAMU,wBAAwB,GAAGA,CAAA,KAAM;IACrC,IAAI,CAACZ,UAAU,EAAE;MACfC,MAAM,CAACY,mBAAmB,CAAC,cAAc,EAAEX,oBAAoB,CAAC;IAClE;IACAQ,oBAAoB,CAACI,IAAI,CAAC,CAAC;MAAEC;IAAO,CAAC,KAAKA,MAAM,CAAC,CAAC,CAAC;EACrD,CAAC;EACD,IAAI,CAACf,UAAU,EAAE;IACfC,MAAM,CAACe,gBAAgB,CAAC,cAAc,EAAEd,oBAAoB,CAAC;IAC7DD,MAAM,CAACe,gBAAgB,CAAC,QAAQ,EAAEJ,wBAAwB,CAAC;EAC7D;EAEA,MAAMD,cAA8B,GAAIM,QAAQ,IAAK;IACnDnB,WAAW,CAACkB,gBAAgB,CAAC,cAAc,EAAEC,QAAQ,CAAC;IAEtD,MAAMF,MAAM,GAAGA,CAAA,KAAM;MACnBjB,WAAW,CAACe,mBAAmB,CAAC,cAAc,EAAEI,QAAQ,CAAC;IAC3D,CAAC;IAED,OAAO;MAAEF;IAAO,CAAC;EACnB,CAAC;EAED,OAAO;IAAEJ,cAAc;IAAEC;EAAyB,CAAC;AACrD,CAAC;AAACM,OAAA,CAAAtB,2BAAA,GAAAA,2BAAA","ignoreList":[]}