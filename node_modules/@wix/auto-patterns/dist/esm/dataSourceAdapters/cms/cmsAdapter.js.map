{"version":3,"names":["collections","items","fetchCmsData","CmsFieldTypeToPatternsFieldType","Type","TEXT","DATE","DATETIME","NUMBER","BOOLEAN","URL","ADDRESS","OBJECT","RICH_TEXT","RICH_CONTENT","ARRAY","ARRAY_STRING","REFERENCE","IMAGE","fetchCmsSchema","collectionId","_schema$fields$find","schema","getDataCollection","transformedFields","fields","reduce","acc","field","_field$capabilities","_field$capabilities2","_field$typeMetadata","key","fieldType","type","baseField","id","displayName","validation","numberRange","min","undefined","max","stringLengthRange","minLength","maxLength","required","capabilities","supportedQueryOperators","queryOperators","sortable","typeMetadata","reference","referencedCollectionId","referenceField","referenceMetadata","nonReferenceType","nonReferenceField","schemaConfig","displayField","idField","imageField","find","actions","get","entityId","create","entity","insert","update","delete","remove","bulkDelete","entityIds","bulkRemove","query","options"],"sources":["../../../../src/dataSourceAdapters/cms/cmsAdapter.ts"],"sourcesContent":["import { Field, SchemaConfig, PatternsFieldType } from '../../types';\nimport { ComputedQuery } from '@wix/patterns';\nimport { collections, items } from '@wix/data';\nimport { fetchCmsData } from './fetchCmsData';\n\nexport const CmsFieldTypeToPatternsFieldType: Partial<\n  Record<collections.Type, PatternsFieldType>\n> = {\n  [collections.Type.TEXT]: 'SHORT_TEXT',\n  [collections.Type.DATE]: 'DATE',\n  [collections.Type.DATETIME]: 'DATETIME',\n  [collections.Type.NUMBER]: 'NUMBER',\n  [collections.Type.BOOLEAN]: 'BOOLEAN',\n  [collections.Type.URL]: 'URL',\n  [collections.Type.ADDRESS]: 'SHORT_TEXT',\n  [collections.Type.OBJECT]: 'LONG_TEXT',\n  [collections.Type.RICH_TEXT]: 'LONG_TEXT',\n  [collections.Type.RICH_CONTENT]: 'SHORT_TEXT',\n  [collections.Type.ARRAY]: 'ARRAY',\n  [collections.Type.ARRAY_STRING]: 'ARRAY',\n  [collections.Type.REFERENCE]: 'REFERENCE',\n  [collections.Type.IMAGE]: 'IMAGE',\n};\n\nexport async function fetchCmsSchema(\n  collectionId: string,\n): Promise<SchemaConfig> {\n  const schema = await collections.getDataCollection(collectionId);\n\n  const transformedFields = schema.fields.reduce<Record<string, Field>>(\n    (acc, field) => {\n      if (!field.key) {\n        return acc;\n      }\n\n      const fieldType = field.type\n        ? CmsFieldTypeToPatternsFieldType[field.type] || 'SHORT_TEXT'\n        : 'SHORT_TEXT';\n      const baseField = {\n        id: field.key,\n        displayName: field.displayName || '',\n        validation: {\n          numberRange: field.numberRange\n            ? {\n                min: field.numberRange.min ?? undefined,\n                max: field.numberRange.max ?? undefined,\n              }\n            : undefined,\n          stringLengthRange: field.stringLengthRange\n            ? {\n                minLength: field.stringLengthRange.minLength ?? undefined,\n                maxLength: field.stringLengthRange.maxLength ?? undefined,\n              }\n            : undefined,\n          required: field.required ?? false,\n        },\n        capabilities: {\n          supportedQueryOperators: field.capabilities?.queryOperators || [],\n          sortable: field.capabilities?.sortable || false,\n        },\n      };\n\n      if (\n        fieldType === 'REFERENCE' &&\n        field.typeMetadata?.reference?.referencedCollectionId\n      ) {\n        const referenceField: Field = {\n          ...baseField,\n          type: 'REFERENCE',\n          referenceMetadata: {\n            referencedCollectionId:\n              field.typeMetadata.reference.referencedCollectionId,\n          },\n        };\n        acc[field.key] = referenceField;\n      } else {\n        const nonReferenceType =\n          fieldType === 'REFERENCE' ? 'SHORT_TEXT' : fieldType;\n        const nonReferenceField: Field = {\n          ...baseField,\n          type: nonReferenceType,\n        };\n        acc[field.key] = nonReferenceField;\n      }\n\n      return acc;\n    },\n    {},\n  );\n\n  const schemaConfig: SchemaConfig = {\n    id: collectionId,\n    displayField: schema.displayField ?? '_id',\n    idField: '_id',\n    imageField: schema.fields.find((field) => field.type === 'IMAGE')?.key,\n    fields: transformedFields,\n    actions: {\n      get: (entityId: string) => {\n        return items.get(collectionId, entityId);\n      },\n      create: (entity) => {\n        return items.insert(collectionId, entity);\n      },\n      update: (entity) => {\n        return items.update(collectionId, entity);\n      },\n      delete: (entityId) => {\n        return items.remove(collectionId, entityId);\n      },\n      bulkDelete: (entityIds) => {\n        return items.bulkRemove(collectionId, entityIds);\n      },\n      find: async (\n        query: ComputedQuery<any>,\n        options: {\n          searchableFieldIds?: string[];\n          filterFieldMapping?: Record<string, { fieldId: string }>;\n        } = {},\n      ) => {\n        return fetchCmsData(collectionId, query, transformedFields, options);\n      },\n    },\n  };\n\n  return schemaConfig;\n}\n"],"mappings":"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","ignoreList":[]}