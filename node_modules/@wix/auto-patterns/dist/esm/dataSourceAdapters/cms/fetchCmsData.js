import { items } from '@wix/data';
import { addFiltersToDataQuery, addSearchToDataQuery } from './filterUtils';
import { addSortToDataQuery } from './sortUtils';
export async function fetchCmsData(collectionId, query, fields, options) {
  if (options === void 0) {
    options = {};
  }
  const {
    searchableFieldIds = [],
    filterFieldMapping
  } = options;
  let dataQuery = items.query(collectionId);
  dataQuery = addSearchToDataQuery({
    dataQuery,
    query,
    fields,
    searchableFieldIds
  });
  dataQuery = addFiltersToDataQuery({
    dataQuery,
    query,
    fields,
    filterFieldMapping
  });
  dataQuery = addSortToDataQuery({
    dataQuery,
    query,
    fields
  });
  const referenceFieldIds = Object.values(fields).filter(field => !!field && field.type === 'REFERENCE' && searchableFieldIds.includes(field.id)).map(field => field.id);
  if (referenceFieldIds.length > 0) {
    dataQuery = dataQuery.include(...referenceFieldIds);
  }
  const res = await dataQuery.skip(query.offset).limit(query.limit).find({
    returnTotalCount: true
  });
  return {
    items: res.items,
    total: res.totalCount ?? 0
  };
}
//# sourceMappingURL=fetchCmsData.js.map