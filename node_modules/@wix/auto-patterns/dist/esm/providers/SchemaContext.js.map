{"version":3,"names":["React","createContext","useContext","useEffect","useState","getSchema","useSchemaRegistry","usePatternsWizardOverridesContext","useWixPatternsContainer","SchemaContext","SchemaProvider","_ref","_collection$custom","collection","children","skeleton","collectionId","entityTypeSource","customDataSourceId","custom","id","undefined","getSchemaFromRegistry","addSchema","addSchemaToRegistry","schema","setSchema","isLoading","setIsLoading","overrides","httpClient","fetchSchemaForCollection","targetCollectionId","targetCustomDataSourceId","customDataSources","customSchemaProvider","Error","fetchReferencedSchemas","referencedSchema","referencedCollectionIds","Set","Object","values","fields","forEach","field","type","referenceMetadata","referencedCollectionId","add","size","fetchPromises","Array","from","map","refCollectionId","refSchema","error","console","Promise","all","cachedSchema","then","fetchedSchema","catch","finally","createElement","Provider","value","useSchema","context"],"sources":["../../../src/providers/SchemaContext.tsx"],"sourcesContent":["import React, {\n  createContext,\n  useContext,\n  useEffect,\n  useState,\n  ReactNode,\n} from 'react';\n\nimport { SchemaConfig, BaseCollectionConfig } from '../types';\nimport { getSchema } from '../dataSourceAdapters/factory';\nimport { useSchemaRegistry } from './SchemaRegistryContext';\nimport { usePatternsWizardOverridesContext } from './PatternsWizardOverridesContext';\nimport { useWixPatternsContainer } from '@wix/patterns';\n\nconst SchemaContext = createContext<SchemaConfig | null>(null);\n\ninterface SchemaProviderProps {\n  collection: BaseCollectionConfig;\n  children: ReactNode;\n  skeleton: JSX.Element;\n}\n\nexport const SchemaProvider = ({\n  collection,\n  children,\n  skeleton,\n}: SchemaProviderProps) => {\n  const { collectionId, entityTypeSource } = collection;\n  const customDataSourceId =\n    collection.entityTypeSource === 'custom' && 'custom' in collection\n      ? collection.custom?.id\n      : undefined;\n  const { getSchema: getSchemaFromRegistry, addSchema: addSchemaToRegistry } =\n    useSchemaRegistry();\n  const [schema, setSchema] = useState<SchemaConfig | null>(null);\n  const [isLoading, setIsLoading] = useState<boolean>(false);\n  const overrides = usePatternsWizardOverridesContext();\n  const { httpClient } = useWixPatternsContainer();\n\n  useEffect(() => {\n    const fetchSchemaForCollection = async (\n      targetCollectionId: string,\n      targetCustomDataSourceId?: string,\n    ): Promise<SchemaConfig> => {\n      if (\n        entityTypeSource === 'custom' &&\n        targetCustomDataSourceId &&\n        overrides?.customDataSources\n      ) {\n        const customSchemaProvider =\n          overrides.customDataSources[targetCustomDataSourceId];\n        if (customSchemaProvider) {\n          return customSchemaProvider(targetCollectionId, { httpClient });\n        }\n        throw new Error(\n          `Custom schema provider '${targetCustomDataSourceId}' not found`,\n        );\n      }\n\n      return getSchema(targetCollectionId, entityTypeSource);\n    };\n\n    const fetchReferencedSchemas = async (referencedSchema: SchemaConfig) => {\n      const referencedCollectionIds = new Set<string>();\n\n      Object.values(referencedSchema.fields).forEach((field) => {\n        if (field && field.type === 'REFERENCE' && field.referenceMetadata) {\n          const { referencedCollectionId } = field.referenceMetadata;\n          if (\n            referencedCollectionId &&\n            !getSchemaFromRegistry(referencedCollectionId)\n          ) {\n            referencedCollectionIds.add(referencedCollectionId);\n          }\n        }\n      });\n\n      if (referencedCollectionIds.size === 0) {\n        return;\n      }\n\n      const fetchPromises = Array.from(referencedCollectionIds).map(\n        async (refCollectionId) => {\n          try {\n            const refSchema = await fetchSchemaForCollection(refCollectionId);\n\n            addSchemaToRegistry(refCollectionId, refSchema);\n\n            await fetchReferencedSchemas(refSchema);\n          } catch (error) {\n            console.error(\n              `Error fetching referenced schema ${refCollectionId}:`,\n              error,\n            );\n          }\n        },\n      );\n\n      await Promise.all(fetchPromises);\n    };\n\n    const cachedSchema = getSchemaFromRegistry(collectionId);\n    if (cachedSchema) {\n      setSchema(cachedSchema);\n      return;\n    }\n    setIsLoading(true);\n    fetchSchemaForCollection(collectionId, customDataSourceId)\n      .then(async (fetchedSchema) => {\n        setSchema(fetchedSchema);\n        addSchemaToRegistry(collectionId, fetchedSchema);\n\n        await fetchReferencedSchemas(fetchedSchema);\n      })\n      .catch((error) => {\n        console.error('Error fetching schema config:', error);\n      })\n      .finally(() => {\n        setIsLoading(false);\n      });\n  }, [\n    collectionId,\n    entityTypeSource,\n    customDataSourceId,\n    addSchemaToRegistry,\n    getSchemaFromRegistry,\n    overrides,\n    httpClient,\n  ]);\n  if (!schema || isLoading) {\n    return skeleton;\n  }\n\n  return (\n    <SchemaContext.Provider value={schema}>{children}</SchemaContext.Provider>\n  );\n};\n\nexport const useSchema = (): SchemaConfig => {\n  const context = useContext(SchemaContext);\n  if (!context) {\n    throw new Error('useSchema must be used within a SchemaProvider');\n  }\n  return context;\n};\n"],"mappings":"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","ignoreList":[]}