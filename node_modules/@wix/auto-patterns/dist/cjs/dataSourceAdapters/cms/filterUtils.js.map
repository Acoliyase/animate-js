{"version":3,"names":["_data","require","_constants","FilterPropToMethod","from","to","isValidFilterProp","prop","getOperatorForFilter","undefined","isSupportedOperator","fields","filterProp","filterKey","field","operator","FilterPropToOperator","supportedOperators","capabilities","supportedQueryOperators","includes","addFiltersToDataQuery","dataQuery","query","filterFieldMapping","dataQueryWithFilters","filters","fieldKey","fieldId","filter","Array","isArray","_fields$fieldId","filterArray","type","some","item","id","BooleanFilters","checked","eq","falseFilter","items","undefinedFilter","and","or","hasSome","map","filterObj","value","TEXT_FIELD_TYPES","addSearchToDataQuery","searchableFieldIds","searchableFields","Object","keys","isFieldSearchable","search","length","searchFilter","forEach","currentFilter","contains"],"sources":["../../../../src/dataSourceAdapters/cms/filterUtils.ts"],"sourcesContent":["import { ComputedQuery } from '@wix/patterns';\nimport { items } from '@wix/data';\nimport { BooleanFilters, FilterProp, FilterPropToOperator } from '../constants';\nimport { SchemaConfig } from '../../types';\n\nexport type CmsOperatorMethod = 'ge' | 'le';\n\nconst FilterPropToMethod: Record<FilterProp, CmsOperatorMethod> = {\n  from: 'ge',\n  to: 'le',\n};\n\nfunction isValidFilterProp(prop: string): prop is FilterProp {\n  return prop in FilterPropToMethod;\n}\n\nfunction getOperatorForFilter(prop: string): CmsOperatorMethod | undefined {\n  if (isValidFilterProp(prop)) {\n    return FilterPropToMethod[prop];\n  }\n  return undefined;\n}\n\nconst isSupportedOperator = (\n  fields: SchemaConfig['fields'],\n  filterProp: string,\n  filterKey: string,\n) => {\n  const field = fields[filterKey];\n  if (!field) {\n    return false;\n  }\n\n  if (!isValidFilterProp(filterProp)) {\n    return false;\n  }\n\n  const operator = FilterPropToOperator[filterProp];\n  const supportedOperators = field.capabilities.supportedQueryOperators;\n  return supportedOperators.includes(operator);\n};\n\nexport function addFiltersToDataQuery({\n  dataQuery,\n  query,\n  fields,\n  filterFieldMapping,\n}: {\n  dataQuery: items.WixDataQuery;\n  query: ComputedQuery<any>;\n  fields: SchemaConfig['fields'];\n  filterFieldMapping?: Record<string, { fieldId: string }>;\n}) {\n  if (!filterFieldMapping) {\n    return dataQuery;\n  }\n\n  let dataQueryWithFilters = dataQuery;\n  const { filters } = query;\n  for (const fieldKey in filters) {\n    const fieldId = filterFieldMapping[fieldKey].fieldId;\n    const filter = filters[fieldKey];\n    if (filter) {\n      if (Array.isArray(filter)) {\n        const filterArray = filter as { [key: string]: any }[];\n        if (fields[fieldId]?.type === 'BOOLEAN') {\n          if (filterArray.some((item) => item.id === BooleanFilters.checked)) {\n            dataQueryWithFilters = dataQueryWithFilters.eq(fieldId, true);\n          } else {\n            const falseFilter = items.filter().eq(fieldId, false);\n            const undefinedFilter = items.filter().eq(fieldId, undefined);\n            dataQueryWithFilters = dataQueryWithFilters.and(\n              falseFilter.or(undefinedFilter),\n            );\n          }\n        } else {\n          dataQueryWithFilters = dataQueryWithFilters.hasSome(\n            fieldId,\n            filterArray.map((item) => item.id),\n          );\n        }\n      } else if (typeof filter === 'object') {\n        const filterObj = filter as Record<string, any>;\n\n        for (const filterProp in filterObj) {\n          const operator = getOperatorForFilter(filterProp);\n          if (\n            operator &&\n            typeof dataQuery[operator] === 'function' &&\n            isSupportedOperator(fields, filterProp, fieldId)\n          ) {\n            const value = filterObj[filterProp];\n            if (value !== undefined && value !== null) {\n              dataQueryWithFilters = dataQueryWithFilters[operator](\n                fieldId,\n                value,\n              );\n            }\n          }\n        }\n      }\n    }\n  }\n\n  return dataQueryWithFilters;\n}\n\nconst TEXT_FIELD_TYPES = ['LONG_TEXT', 'SHORT_TEXT'];\nexport function addSearchToDataQuery({\n  dataQuery,\n  query,\n  fields,\n  searchableFieldIds,\n}: {\n  dataQuery: items.WixDataQuery;\n  query: ComputedQuery<any>;\n  fields: SchemaConfig['fields'];\n  searchableFieldIds: string[];\n}) {\n  const searchableFields = Object.keys(fields).filter((fieldId) => {\n    const field = fields[fieldId];\n    const isFieldSearchable = searchableFieldIds.includes(fieldId);\n\n    return isFieldSearchable && field && TEXT_FIELD_TYPES.includes(field.type);\n  });\n\n  if (query.search && searchableFields.length > 0) {\n    let searchFilter: items.WixDataFilter | null = null;\n\n    searchableFields.forEach((field) => {\n      const currentFilter = items.filter().contains(field, query.search!);\n      searchFilter = searchFilter\n        ? searchFilter.or(currentFilter)\n        : currentFilter;\n    });\n\n    if (searchFilter) {\n      dataQuery = dataQuery.and(searchFilter);\n    }\n  }\n\n  return dataQuery;\n}\n"],"mappings":"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","ignoreList":[]}