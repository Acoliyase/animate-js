{"version":3,"names":["_react","_interopRequireWildcard","require","_factory","_SchemaRegistryContext","_PatternsWizardOverridesContext","_patterns","_jsxFileName","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","SchemaContext","createContext","SchemaProvider","collection","children","skeleton","_collection$custom","collectionId","entityTypeSource","customDataSourceId","custom","id","undefined","getSchema","getSchemaFromRegistry","addSchema","addSchemaToRegistry","useSchemaRegistry","schema","setSchema","useState","isLoading","setIsLoading","overrides","usePatternsWizardOverridesContext","httpClient","useWixPatternsContainer","useEffect","fetchSchemaForCollection","targetCollectionId","targetCustomDataSourceId","customDataSources","customSchemaProvider","Error","fetchReferencedSchemas","referencedSchema","referencedCollectionIds","Set","values","fields","forEach","field","type","referenceMetadata","referencedCollectionId","add","size","fetchPromises","Array","from","map","refCollectionId","refSchema","error","console","Promise","all","cachedSchema","then","fetchedSchema","catch","finally","createElement","Provider","value","__self","__source","fileName","lineNumber","columnNumber","exports","useSchema","context","useContext"],"sources":["../../../src/providers/SchemaContext.tsx"],"sourcesContent":["import React, {\n  createContext,\n  useContext,\n  useEffect,\n  useState,\n  ReactNode,\n} from 'react';\n\nimport { SchemaConfig, BaseCollectionConfig } from '../types';\nimport { getSchema } from '../dataSourceAdapters/factory';\nimport { useSchemaRegistry } from './SchemaRegistryContext';\nimport { usePatternsWizardOverridesContext } from './PatternsWizardOverridesContext';\nimport { useWixPatternsContainer } from '@wix/patterns';\n\nconst SchemaContext = createContext<SchemaConfig | null>(null);\n\ninterface SchemaProviderProps {\n  collection: BaseCollectionConfig;\n  children: ReactNode;\n  skeleton: JSX.Element;\n}\n\nexport const SchemaProvider = ({\n  collection,\n  children,\n  skeleton,\n}: SchemaProviderProps) => {\n  const { collectionId, entityTypeSource } = collection;\n  const customDataSourceId =\n    collection.entityTypeSource === 'custom' && 'custom' in collection\n      ? collection.custom?.id\n      : undefined;\n  const { getSchema: getSchemaFromRegistry, addSchema: addSchemaToRegistry } =\n    useSchemaRegistry();\n  const [schema, setSchema] = useState<SchemaConfig | null>(null);\n  const [isLoading, setIsLoading] = useState<boolean>(false);\n  const overrides = usePatternsWizardOverridesContext();\n  const { httpClient } = useWixPatternsContainer();\n\n  useEffect(() => {\n    const fetchSchemaForCollection = async (\n      targetCollectionId: string,\n      targetCustomDataSourceId?: string,\n    ): Promise<SchemaConfig> => {\n      if (\n        entityTypeSource === 'custom' &&\n        targetCustomDataSourceId &&\n        overrides?.customDataSources\n      ) {\n        const customSchemaProvider =\n          overrides.customDataSources[targetCustomDataSourceId];\n        if (customSchemaProvider) {\n          return customSchemaProvider(targetCollectionId, { httpClient });\n        }\n        throw new Error(\n          `Custom schema provider '${targetCustomDataSourceId}' not found`,\n        );\n      }\n\n      return getSchema(targetCollectionId, entityTypeSource);\n    };\n\n    const fetchReferencedSchemas = async (referencedSchema: SchemaConfig) => {\n      const referencedCollectionIds = new Set<string>();\n\n      Object.values(referencedSchema.fields).forEach((field) => {\n        if (field && field.type === 'REFERENCE' && field.referenceMetadata) {\n          const { referencedCollectionId } = field.referenceMetadata;\n          if (\n            referencedCollectionId &&\n            !getSchemaFromRegistry(referencedCollectionId)\n          ) {\n            referencedCollectionIds.add(referencedCollectionId);\n          }\n        }\n      });\n\n      if (referencedCollectionIds.size === 0) {\n        return;\n      }\n\n      const fetchPromises = Array.from(referencedCollectionIds).map(\n        async (refCollectionId) => {\n          try {\n            const refSchema = await fetchSchemaForCollection(refCollectionId);\n\n            addSchemaToRegistry(refCollectionId, refSchema);\n\n            await fetchReferencedSchemas(refSchema);\n          } catch (error) {\n            console.error(\n              `Error fetching referenced schema ${refCollectionId}:`,\n              error,\n            );\n          }\n        },\n      );\n\n      await Promise.all(fetchPromises);\n    };\n\n    const cachedSchema = getSchemaFromRegistry(collectionId);\n    if (cachedSchema) {\n      setSchema(cachedSchema);\n      return;\n    }\n    setIsLoading(true);\n    fetchSchemaForCollection(collectionId, customDataSourceId)\n      .then(async (fetchedSchema) => {\n        setSchema(fetchedSchema);\n        addSchemaToRegistry(collectionId, fetchedSchema);\n\n        await fetchReferencedSchemas(fetchedSchema);\n      })\n      .catch((error) => {\n        console.error('Error fetching schema config:', error);\n      })\n      .finally(() => {\n        setIsLoading(false);\n      });\n  }, [\n    collectionId,\n    entityTypeSource,\n    customDataSourceId,\n    addSchemaToRegistry,\n    getSchemaFromRegistry,\n    overrides,\n    httpClient,\n  ]);\n  if (!schema || isLoading) {\n    return skeleton;\n  }\n\n  return (\n    <SchemaContext.Provider value={schema}>{children}</SchemaContext.Provider>\n  );\n};\n\nexport const useSchema = (): SchemaConfig => {\n  const context = useContext(SchemaContext);\n  if (!context) {\n    throw new Error('useSchema must be used within a SchemaProvider');\n  }\n  return context;\n};\n"],"mappings":";;;;AAAA,IAAAA,MAAA,GAAAC,uBAAA,CAAAC,OAAA;AASA,IAAAC,QAAA,GAAAD,OAAA;AACA,IAAAE,sBAAA,GAAAF,OAAA;AACA,IAAAG,+BAAA,GAAAH,OAAA;AACA,IAAAI,SAAA,GAAAJ,OAAA;AAAwD,IAAAK,YAAA;AAAA,SAAAC,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAR,wBAAAQ,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAExD,MAAMW,aAAa,gBAAG,IAAAC,oBAAa,EAAsB,IAAI,CAAC;AAQvD,MAAMC,cAAc,GAAGA,CAAC;EAC7BC,UAAU;EACVC,QAAQ;EACRC;AACmB,CAAC,KAAK;EAAA,IAAAC,kBAAA;EACzB,MAAM;IAAEC,YAAY;IAAEC;EAAiB,CAAC,GAAGL,UAAU;EACrD,MAAMM,kBAAkB,GACtBN,UAAU,CAACK,gBAAgB,KAAK,QAAQ,IAAI,QAAQ,IAAIL,UAAU,IAAAG,kBAAA,GAC9DH,UAAU,CAACO,MAAM,qBAAjBJ,kBAAA,CAAmBK,EAAE,GACrBC,SAAS;EACf,MAAM;IAAEC,SAAS,EAAEC,qBAAqB;IAAEC,SAAS,EAAEC;EAAoB,CAAC,GACxE,IAAAC,wCAAiB,EAAC,CAAC;EACrB,MAAM,CAACC,MAAM,EAAEC,SAAS,CAAC,GAAG,IAAAC,eAAQ,EAAsB,IAAI,CAAC;EAC/D,MAAM,CAACC,SAAS,EAAEC,YAAY,CAAC,GAAG,IAAAF,eAAQ,EAAU,KAAK,CAAC;EAC1D,MAAMG,SAAS,GAAG,IAAAC,iEAAiC,EAAC,CAAC;EACrD,MAAM;IAAEC;EAAW,CAAC,GAAG,IAAAC,iCAAuB,EAAC,CAAC;EAEhD,IAAAC,gBAAS,EAAC,MAAM;IACd,MAAMC,wBAAwB,GAAG,MAAAA,CAC/BC,kBAA0B,EAC1BC,wBAAiC,KACP;MAC1B,IACEtB,gBAAgB,KAAK,QAAQ,IAC7BsB,wBAAwB,IACxBP,SAAS,YAATA,SAAS,CAAEQ,iBAAiB,EAC5B;QACA,MAAMC,oBAAoB,GACxBT,SAAS,CAACQ,iBAAiB,CAACD,wBAAwB,CAAC;QACvD,IAAIE,oBAAoB,EAAE;UACxB,OAAOA,oBAAoB,CAACH,kBAAkB,EAAE;YAAEJ;UAAW,CAAC,CAAC;QACjE;QACA,MAAM,IAAIQ,KAAK,CACb,2BAA2BH,wBAAwB,aACrD,CAAC;MACH;MAEA,OAAO,IAAAjB,kBAAS,EAACgB,kBAAkB,EAAErB,gBAAgB,CAAC;IACxD,CAAC;IAED,MAAM0B,sBAAsB,GAAG,MAAOC,gBAA8B,IAAK;MACvE,MAAMC,uBAAuB,GAAG,IAAIC,GAAG,CAAS,CAAC;MAEjD7C,MAAM,CAAC8C,MAAM,CAACH,gBAAgB,CAACI,MAAM,CAAC,CAACC,OAAO,CAAEC,KAAK,IAAK;QACxD,IAAIA,KAAK,IAAIA,KAAK,CAACC,IAAI,KAAK,WAAW,IAAID,KAAK,CAACE,iBAAiB,EAAE;UAClE,MAAM;YAAEC;UAAuB,CAAC,GAAGH,KAAK,CAACE,iBAAiB;UAC1D,IACEC,sBAAsB,IACtB,CAAC9B,qBAAqB,CAAC8B,sBAAsB,CAAC,EAC9C;YACAR,uBAAuB,CAACS,GAAG,CAACD,sBAAsB,CAAC;UACrD;QACF;MACF,CAAC,CAAC;MAEF,IAAIR,uBAAuB,CAACU,IAAI,KAAK,CAAC,EAAE;QACtC;MACF;MAEA,MAAMC,aAAa,GAAGC,KAAK,CAACC,IAAI,CAACb,uBAAuB,CAAC,CAACc,GAAG,CAC3D,MAAOC,eAAe,IAAK;QACzB,IAAI;UACF,MAAMC,SAAS,GAAG,MAAMxB,wBAAwB,CAACuB,eAAe,CAAC;UAEjEnC,mBAAmB,CAACmC,eAAe,EAAEC,SAAS,CAAC;UAE/C,MAAMlB,sBAAsB,CAACkB,SAAS,CAAC;QACzC,CAAC,CAAC,OAAOC,KAAK,EAAE;UACdC,OAAO,CAACD,KAAK,CACX,oCAAoCF,eAAe,GAAG,EACtDE,KACF,CAAC;QACH;MACF,CACF,CAAC;MAED,MAAME,OAAO,CAACC,GAAG,CAACT,aAAa,CAAC;IAClC,CAAC;IAED,MAAMU,YAAY,GAAG3C,qBAAqB,CAACP,YAAY,CAAC;IACxD,IAAIkD,YAAY,EAAE;MAChBtC,SAAS,CAACsC,YAAY,CAAC;MACvB;IACF;IACAnC,YAAY,CAAC,IAAI,CAAC;IAClBM,wBAAwB,CAACrB,YAAY,EAAEE,kBAAkB,CAAC,CACvDiD,IAAI,CAAC,MAAOC,aAAa,IAAK;MAC7BxC,SAAS,CAACwC,aAAa,CAAC;MACxB3C,mBAAmB,CAACT,YAAY,EAAEoD,aAAa,CAAC;MAEhD,MAAMzB,sBAAsB,CAACyB,aAAa,CAAC;IAC7C,CAAC,CAAC,CACDC,KAAK,CAAEP,KAAK,IAAK;MAChBC,OAAO,CAACD,KAAK,CAAC,+BAA+B,EAAEA,KAAK,CAAC;IACvD,CAAC,CAAC,CACDQ,OAAO,CAAC,MAAM;MACbvC,YAAY,CAAC,KAAK,CAAC;IACrB,CAAC,CAAC;EACN,CAAC,EAAE,CACDf,YAAY,EACZC,gBAAgB,EAChBC,kBAAkB,EAClBO,mBAAmB,EACnBF,qBAAqB,EACrBS,SAAS,EACTE,UAAU,CACX,CAAC;EACF,IAAI,CAACP,MAAM,IAAIG,SAAS,EAAE;IACxB,OAAOhB,QAAQ;EACjB;EAEA,oBACEjC,MAAA,CAAAc,OAAA,CAAA4E,aAAA,CAAC9D,aAAa,CAAC+D,QAAQ;IAACC,KAAK,EAAE9C,MAAO;IAAA+C,MAAA;IAAAC,QAAA;MAAAC,QAAA,EAAAxF,YAAA;MAAAyF,UAAA;MAAAC,YAAA;IAAA;EAAA,GAAEjE,QAAiC,CAAC;AAE9E,CAAC;AAACkE,OAAA,CAAApE,cAAA,GAAAA,cAAA;AAEK,MAAMqE,SAAS,GAAGA,CAAA,KAAoB;EAC3C,MAAMC,OAAO,GAAG,IAAAC,iBAAU,EAACzE,aAAa,CAAC;EACzC,IAAI,CAACwE,OAAO,EAAE;IACZ,MAAM,IAAIvC,KAAK,CAAC,gDAAgD,CAAC;EACnE;EACA,OAAOuC,OAAO;AAChB,CAAC;AAACF,OAAA,CAAAC,SAAA,GAAAA,SAAA","ignoreList":[]}