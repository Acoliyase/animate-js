# Collection Page Actions

## ⚠️ Required Actions

- **Every collection page must include a create action that navigates to the entity page for adding new entities** - this is essential for user workflow

The `actions` property is an optional object within the `collectionPage` configuration, but it is strongly recommended to always include primaryActions with a create action for better user experience.

## `primaryActions` and `secondaryActions` Structure

Both `primaryActions` and `secondaryActions` are optional and share the same underlying structure for defining how actions are displayed. They can be configured in one of two ways:

### A. Action Layout (`type: "action"`)
*   **Description**: This layout is used to display a single, prominent page-level action. For example, a "Create New Item" button.
*   **`action.item`**: Contains the configuration for the single action.

### B. Action Menu Layout (`type: "menu"`)
*   **Description**: This layout groups several page-level actions, often rendered as a dropdown menu or a set of related buttons under a common label.
*   **`menu.label`**: A string that serves as the title or accessible label for the group of actions.
*   **`menu.items`**: A flat array of action configurations, which can include divider objects for visual separation.

## Individual Action Configuration

Each individual action, whether standalone in an `action` layout or part of an `items` array in a `menu` layout, is defined by the action item structure (see `AppConfig Structure`).

In addition to these common properties, each action item must specify a `type` which determines the action's behavior and additional required configuration.

### 1. `type: "create"`
*   **Purpose**: Navigates to an entity page, allowing the user to create a new item in the specified collection.
*   **Details**:
    *   `create.mode`: Must be `'page'`.
    *   `create.page.id`: Must be the `id` of an existing `entityPage` in your `AppConfig`. This entity page should be set up to handle the creation of new entities for the `collection.collectionId`.

### 2. `type: "custom"`
*   **Purpose**: Executes custom JavaScript logic defined in your application's overrides.
*   **Details**:
    *   The `custom` object in the configuration is typically empty. The functionality is determined by a custom action resolver function that you implement and register in the `actions` section of your `PatternsWizardOverridesProvider`. The `id` of this action item must exactly match the name (key) of the registered custom action resolver. The resolver will receive parameters including `collectionId`.

### 3. `type: "divider"`
*   **Purpose**: Creates a visual separator between action groups in menus and lists.
*   **Details**:
    *   Divider actions require no additional configuration beyond `{ "type": "divider" }`.
    *   Used within flat arrays to create logical groupings.

## Note on `secondaryActions`

`secondaryActions` follow the exact same structural rules (`type: "action"` or `type: "menu"`) and use the same action item options as `primaryActions`. They are typically used for less prominent or less frequently used page-level actions, often rendered in a secondary position or within a "more options" style menu.

## Custom Collection Page Action Configuration

Custom collection page actions execute JavaScript code that you define for collection-level operations. These actions receive parameters that give them access to collection context and utilities. Here's how to implement a custom collection page action:

1. First, create the actions folder structure in your page folder:
   ```
   your-page/
   ├── page.tsx
   └── components/
       └── actions/
           ├── index.tsx                    // Exports all actions
           └── exportCollection.tsx        // Your custom collection action
   ```

2. Create your collection action handler in `exportCollection.tsx`:
   ```typescript
   import { CustomActionCollectionPageActionResolver } from '@wix/auto-patterns';
   import React from 'react';
   import { Download } from '@wix/ui-icons-common';

   // IMPORTANT: Function name MUST match the action id in your configuration
   export const exportCollection: CustomActionCollectionPageActionResolver = (params) => {
     const { actionParams, sdk } = params;
     const { collectionId } = actionParams;

     return {
       label: 'Export Collection',
       icon: <Download />,
       onClick: () => {
         // sdk is provided to custom action resolvers (see SDK Utilities section)
         const optimisticActions = sdk.getOptimisticActions(collectionId);
         const schema = sdk.getSchema(collectionId);

         // Example: Mark entire collection as exported
         optimisticActions.updateAll(
           (item) => ({ lastExported: new Date() }),
           {
             submit: async () => {
               // Your collection export logic here
               console.log(`Exporting collection: ${collectionId}`);
               // Export and update all items on server
               return await schema.actions.bulkUpdate({ lastExported: new Date() });
             },
             successToast: 'Collection exported successfully',
             errorToast: (err, {retry}) => ({
               text: 'Export failed',
               action: { text: 'Retry', onClick: retry }
             })
           }
         );
       },
     };
   };
   ```

3. Export your action in `actions/index.tsx`:
   ```typescript
   export * from './exportCollection';
   ```

4. Configure the action in your JSON configuration:
   ```json
   {
     "id": "exportCollection",        // MUST match the function name exactly
     "type": "custom",                // REQUIRED: Must be exactly "custom"
     "label": "Export Collection",    // Optional: Displayed text
     "collection": {
       "collectionId": "WixPets",
       "entityTypeSource": "cms"
     }
   }
   ```

5. Register your action in the `PatternsWizardOverridesProvider`:
   ```typescript
   import * as actions from './components/actions';

   <PatternsWizardOverridesProvider value={{ actions }}>
     <AutoPatternsApp configuration={config as AppConfig} />
   </PatternsWizardOverridesProvider>
   ```

## Key Points for Custom Collection Page Actions:
- The action `id` in the configuration MUST exactly match the function name exported from your actions folder
- The function name and file name should follow a consistent naming convention (e.g., camelCase)
- The implementation must be exported as a named export (not default export)
- The implementation must use the `CustomActionCollectionPageActionResolver` type
- Access collection context through `actionParams.collectionId`

---

## Custom Row Click Actions

In addition to page-level actions, you can also customize what happens when users click on individual rows in your collection table. By default, clicking a row navigates to the entity page, but you can override this behavior with custom logic.

**Before You Start:**
- Only configure `onRowClick` if you need custom behavior (e.g., opening modals, side panels, custom actions)
- If you just want navigation to entity page, don't configure `onRowClick` - it's the default behavior
- Once you configure `onRowClick`, you must provide a complete working implementation

### Configuration

Row click actions are configured at the table level using the `onRowClick` property:

```json
{
  "type": "Table",
  "table": {
    "columns": [...],
    "onRowClick": {
      "id": "handleRowClick",        // MUST match the function name exactly
      "type": "custom",              // REQUIRED: Must be exactly "custom"
    }
  }
}
```

### Implementation Requirements

⚠️ **CRITICAL**: When you configure `onRowClick` in your JSON, you MUST provide a complete working implementation. The Auto Patterns framework cannot function without it.

Custom row click actions use the `CustomActionCollectionPageActionOnRowClickResolver` type and MUST return a `ResolvedAction` object with all required properties:

#### Required Return Object Structure:
```typescript
return {
  label: string,        // REQUIRED: Action label
  icon: ReactElement,   // REQUIRED: Icon component
  onClick: () => void   // REQUIRED: Click handler function
};
```

#### Complete Implementation Example:

```typescript
import { CustomActionCollectionPageActionOnRowClickResolver } from '@wix/auto-patterns';
import React from 'react';
import { More } from '@wix/wix-ui-icons-common';

// IMPORTANT: Function name MUST match the action id in your configuration
export const handleRowClick: CustomActionCollectionPageActionOnRowClickResolver = (params) => {
  const { actionParams, sdk } = params;
  const { item } = actionParams; // The clicked row's data

  return {
    label: 'View Details',           // REQUIRED
    icon: <More />,                  // REQUIRED
    onClick: () => {                 // REQUIRED
      // Your custom row click logic here
      console.log('Row clicked:', item);

      // Example: Show a custom modal, perform an action, etc.
      // You can access all SDK utilities here (see SDK Utilities section)
      const optimisticActions = sdk.getOptimisticActions(sdk.collectionId);
      const schema = sdk.getSchema(sdk.collectionId);

      // Your custom logic...
    },
  };
};
```

### Common Use Cases and Complete Examples

#### 1. Opening a Side Panel Modal

This is a complete working example for opening a side panel when clicking a row:

**Step 1: Create the row click action** (`components/actions/openSidePanel.tsx`):
```typescript
import { CustomActionCollectionPageActionOnRowClickResolver } from '@wix/auto-patterns';
import React from 'react';
import { More } from '@wix/wix-ui-icons-common';

export const openSidePanel: CustomActionCollectionPageActionOnRowClickResolver = (params) => {
  const { actionParams, sdk } = params;
  const { item } = actionParams;

  return {
    label: 'View Details',
    icon: <More />,
    onClick: () => {
      // Open a custom modal with the item data
      // You need to implement the modal opening mechanism
      // This could be through a modal context, state management, etc.
      console.log('Opening side panel for:', item);

      // Example: Using a global modal state (you need to implement this)
      // window.dispatchEvent(new CustomEvent('openSidePanel', { detail: item }));

      // Or use a modal service/context that you've set up
      // modalService.openSidePanel(item);
    },
  };
};
```

**Step 2: Configure in JSON**:
```json
{
  "type": "Table",
  "table": {
    "onRowClick": {
      "id": "openSidePanel",
      "type": "custom"
    },
    "columns": [...]
  }
}
```

**Step 3: Export and Register**:
```typescript
// components/actions/index.tsx
export * from './openSidePanel';

// page.tsx
import * as actions from './components/actions';

<PatternsWizardOverridesProvider value={{ actions }}>
  <AutoPatternsApp configuration={config as AppConfig} />
</PatternsWizardOverridesProvider>
```

#### 2. Direct Data Manipulation

```typescript
export const quickToggle: CustomActionCollectionPageActionOnRowClickResolver = (params) => {
  const { actionParams, sdk } = params;
  const { item } = actionParams;

  return {
    label: 'Quick Toggle',
    icon: <Toggle />,
    onClick: () => {
      const optimisticActions = sdk.getOptimisticActions(sdk.collectionId);
      const schema = sdk.getSchema(sdk.collectionId);

      // Example: Toggle a boolean field
      const updatedItem = { ...item, isActive: !item.isActive };

      optimisticActions.updateOne(updatedItem, {
        submit: async (items) => schema.actions.update(items[0]),
        successToast: `${item.name} toggled successfully`,
        errorToast: (err, {retry}) => ({
          text: 'Toggle failed',
          action: { text: 'Retry', onClick: retry }
        })
      });
    },
  };
};
```

### Default vs Custom Behavior

**Default Behavior (when `onRowClick` is not configured):**
- Clicking a row automatically navigates to the entity page
- Uses the `entityPageId` configuration to determine the target page
- Passes the selected item's data to the entity page

**Custom Behavior (when `onRowClick` is configured):**
- Default navigation is **disabled**
- Your custom action function is executed instead
- You have complete control over the row click behavior
- You can still navigate to the entity page programmatically if needed using the SDK navigation utilities

### Key Points for Custom Row Click Actions:
- **MANDATORY IMPLEMENTATION**: If you configure `onRowClick` in JSON, you MUST provide a complete working implementation - the framework cannot function without it
- The action `id` in the configuration MUST exactly match the function name exported from your actions folder
- The implementation must use the `CustomActionCollectionPageActionOnRowClickResolver` type
- **Required Return Object**: Must return an object with `label`, `icon`, and `onClick` properties - all are required
- Access the clicked item's data through `actionParams.item`
- The implementation must be exported as a named export and registered in your `PatternsWizardOverridesProvider`
- When `onRowClick` is configured, the default navigation to entity page is completely disabled
- **Complete Setup Required**: You need to create the action file, export it in the index, and register it in the provider - missing any step will cause errors

## Validation Checklist for Collection Page Actions

✓ Every collection page must include a create action.
✓ `actions` is an optional property of `collectionPage`.
✓ `primaryActions` and `secondaryActions` (if defined) have a valid `type` ("action" or "menu").
✓ If `type: "action"`, `action.item` is a valid action item configuration.
✓ If `type: "menu"`, `menu.items` is an array of valid action item configurations that can include dividers.
✓ Each action item contains a unique `id`, and the full `collection` object (`collectionId`, `entityTypeSource: 'cms'`).
✓ Each action item has a supported `type` (`create`, `custom`) and its corresponding configuration block (e.g., `create` block for `type: "create"`).
✓ `create` actions specify a `create.page.id` that matches an existing `entityPage` ID in the configuration.
✓ `custom` actions (identified by their main `id`) correspond to an action resolver function name registered in the `actions` override.
✓ Divider actions use `{ "type": "divider" }` format and require no additional properties.
✓ If `onRowClick` is configured in table layout, it must have a valid `id` and `type: "custom"`.
✓ **CRITICAL**: Custom row click actions must have corresponding implementations registered in the `actions` override - configuration without implementation will cause errors.
✓ Custom row click action implementations must return an object with `label`, `icon`, and `onClick` properties - all are required.
✓ Custom row click action implementations must be exported as named exports and included in the actions index file.
✓ `onRowClick` is optional - when not configured, rows navigate to entity page by default.
✓ **IMPORTANT**: Configuring `onRowClick` completely disables default navigation - you must handle all row click logic in your custom implementation.
