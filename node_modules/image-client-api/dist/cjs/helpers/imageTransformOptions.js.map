{"version":3,"sources":["../../../src/helpers/imageTransformOptions.js"],"names":["utils","require","constants","imageServiceUtils","setTransformOptions","transformsObj","options","quality","getQuality","progressive","getProgressive","watermark","getWatermark","unsharpMask","getUnsharpMask","filters","getFilters","transformData","last","parts","defaultQuality","getPreferredImageQuality","width","height","parseInt","filterOptions","isValidImageFilter","imageFilters","CONTRAST","BRIGHTNESS","SATURATION","HUE","BLUR","filterValue","minValue","maxValue","isNaN","usm","isUSMValid","radius","amount","threshold","isZeroUSM","isUSMNeeded","defaultUSM","roundToFixed","transformPart","upscale","scaleFactor","forceUSM","module","exports"],"mappings":"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","file":"imageTransformOptions.js","sourcesContent":["'use strict'\n\nconst utils = require('./utils')\nconst constants = require('./imageServiceConstants')\nconst imageServiceUtils = require('./imageServiceUtils')\n\n\n/**\n * returns image filters part of the image transform uri\n * @param {object}                  transformsObj    transform parts object\n * @param {ImageTransformOptions}   options\n */\nfunction setTransformOptions(transformsObj, options) {\n    options = options || {}\n    // options - general\n    transformsObj.quality = getQuality(transformsObj, options)\n    transformsObj.progressive = getProgressive(options)\n    transformsObj.watermark = getWatermark(options)\n    // options - filters & adjustments\n    transformsObj.unsharpMask = getUnsharpMask(transformsObj, options)\n    transformsObj.filters = getFilters(options)\n}\n\n/**\n *\n * @param {ImageTransformOptions}   options\n * @returns {string}\n */\nfunction getWatermark(options) {\n    return options.watermark\n}\n\n\n/**\n * returns progressive if required\n * @param {ImageTransformOptions}   options\n *\n * @returns {boolean}\n */\nfunction getProgressive(options) {\n    return options.progressive !== false\n}\n\n/**\n * returns image filters part of the image transform uri\n * @param {object}                  transformsObj    transform parts object\n * @param {ImageTransformOptions}   options\n *\n * @returns {number}\n */\nfunction getQuality(transformsObj, options) {\n    const transformData = utils.last(transformsObj.parts)\n\n    const defaultQuality = imageServiceUtils.getPreferredImageQuality(transformData.width, transformData.height)\n    const quality = options.quality && (options.quality >= 5 && options.quality <= 90) ? options.quality : defaultQuality\n\n    // return quality\n    return parseInt(quality, 10)\n}\n\n/**\n * returns the desired transformed image filters\n * @param {ImageTransformOptions}   options\n *\n * @returns {object}\n */\nfunction getFilters(options) {\n    const filterOptions = options.filters || {}\n    const filters = {}\n\n\n    // contrast\n    if (isValidImageFilter(filterOptions[constants.imageFilters.CONTRAST], -100, 100)) {\n        filters[constants.imageFilters.CONTRAST] = filterOptions[constants.imageFilters.CONTRAST]\n    }\n\n    // brightness\n    if (isValidImageFilter(filterOptions[constants.imageFilters.BRIGHTNESS], -100, 100)) {\n        filters[constants.imageFilters.BRIGHTNESS] = filterOptions[constants.imageFilters.BRIGHTNESS]\n    }\n\n    // saturation\n    if (isValidImageFilter(filterOptions[constants.imageFilters.SATURATION], -100, 100)) {\n        filters[constants.imageFilters.SATURATION] = filterOptions[constants.imageFilters.SATURATION]\n    }\n\n    // hue\n    if (isValidImageFilter(filterOptions[constants.imageFilters.HUE], -180, 180)) {\n        filters[constants.imageFilters.HUE] = filterOptions[constants.imageFilters.HUE]\n    }\n\n    // blur\n    if (isValidImageFilter(filterOptions[constants.imageFilters.BLUR], 0, 100)) {\n        filters[constants.imageFilters.BLUR] = filterOptions[constants.imageFilters.BLUR]\n    }\n\n    return filters\n}\n\n/**\n * indicates if requested filter value is valid\n * @param {number}  filterValue     filter's value\n * @param {number}  minValue        min range\n * @param {number}  maxValue        max range\n *\n * @returns {boolean}\n */\nfunction isValidImageFilter(filterValue, minValue, maxValue) {\n    // check if filter name and filter values range valid\n    return !isNaN(filterValue) && typeof filterValue === 'number' && filterValue !== 0 && (filterValue >= minValue && filterValue <= maxValue)\n}\n\n/**\n * returns the desired transformed image unSharpMask values\n * @param {object}                  transformsObj    transform parts object\n * @param {ImageTransformOptions}   options\n *\n * @returns {object}\n */\nfunction getUnsharpMask(transformsObj, options) {\n    // construct usm values\n    let usm\n\n    // If options.unsharpMask is a valid value, use it\n    if (isUSMValid(options.unsharpMask)) {\n        usm = {\n            radius: options.unsharpMask.radius,\n            amount: options.unsharpMask.amount,\n            threshold: options.unsharpMask.threshold\n        }\n    // if options.unsharpMask is not all zeros and not valid and usm should be used, use default\n    } else if (!isZeroUSM(options.unsharpMask)) {\n        if (isUSMNeeded(transformsObj)) {\n            usm = constants.defaultUSM\n        }\n    }\n    // If we got usm, change values to have trailing zeros (.00), else return undefined\n    if (usm) {\n        usm.radius = imageServiceUtils.roundToFixed(usm.radius, 2)\n        usm.amount = imageServiceUtils.roundToFixed(usm.amount, 2)\n        usm.threshold = imageServiceUtils.roundToFixed(usm.threshold, 2)\n    }\n\n    return usm\n}\n\n/**\n * indicates if usm is needed\n * @param {object}      transformsObj   transform parts object\n *\n * @returns {boolean}\n */\nfunction isUSMNeeded(transformsObj) {\n    // ---------------------------------------------------------------------------------------\n    // do not apply usm if transformed image width & height is same as source image or larger\n    // and no force usm is desired\n    // ---------------------------------------------------------------------------------------\n    const transformPart = utils.last(transformsObj.parts)\n    const upscale = transformPart.scaleFactor >= 1\n\n    // return if usm is needed\n    return !upscale || transformPart.forceUSM\n}\n\n\n/**\n * indicates if all usm values are presented and in range\n * @param {object}  usm     unsharp mask\n *\n * @returns {boolean}\n */\nfunction isUSMValid(usm) {\n    usm = usm || {}\n    const radius = !isNaN(usm.radius) && typeof usm.radius === 'number' && (usm.radius >= 0.1 && usm.radius <= 500)\n    const amount = !isNaN(usm.amount) && typeof usm.amount === 'number' && (usm.amount >= 0 && usm.amount <= 10)\n    const threshold = !isNaN(usm.threshold) && typeof usm.threshold === 'number' && (usm.threshold >= 0 && usm.threshold <= 255)\n\n    // return is a valid USM data\n    return radius && amount && threshold\n}\n\n/**\n * indicates if all usm values are presented and are zero. an explicit request to not apply usm\n * @param {object}  usm     unsharp mask\n *\n * @returns {boolean}\n */\nfunction isZeroUSM(usm) {\n    usm = usm || {}\n    return !isNaN(usm.radius) && typeof usm.radius === 'number' && usm.radius === 0 &&\n        (!isNaN(usm.amount) && typeof usm.amount === 'number' && usm.amount === 0) &&\n        (!isNaN(usm.threshold) && typeof usm.threshold === 'number' && usm.threshold === 0)\n}\n\nmodule.exports = {\n    setTransformOptions\n}\n"]}