{"version":3,"sources":["../../../src/helpers/imageServiceUtils.js"],"names":["utils","require","constants","globalFeatureSupportObject","checkWEBPSupport","type","webpTypes","lossy","lossless","alpha","animation","webpImg","window","Image","onload","isWebpFeature","getFeature","width","height","setFeature","src","populateGlobalFeatureSupport","webp","LOSSY","LOSSLESS","ALPHA","ANIMATION","isPropertySupported","isWEBPBrowserSupport","fileType","isLosssyJPG","JPG","isLosslessPNG","PNG","isAlphaPNG","isObjectFitBrowserSupport","property","document","documentElement","style","isImageTypeSupported","uri","supportedImageExtensions","JPEG","WIX_ICO_MP","WIX_MP","includes","getFileExtension","isValidRequest","fittingType","target","isUrlEmptyOrNone","id","fittingTypes","isImageTransformApplicable","isExternalUrl","isJPG","isPNG","isWEBP","url","test","trim","toLowerCase","getFileName","name","beforeLeadingSlashRegexp","fileExtensionRegexp","length","illegalChars","map","encodeURIComponent","urlSafeIllegalChars","illegalCharsRegex","RegExp","concat","join","illegalCharsReplacement","fileName","extension","match","supportedExtensions","replace","trimmed","getFileType","WEBP","UNRECOGNIZED","splitURI","exec","getFitScaleFactor","sWidth","sHeight","dWidth","dHeight","Math","min","getFillScaleFactor","max","getScaleFactor","transformType","scaleFactor","transformTypes","FILL","FIT","getSafeTransformData","SAFE_TRANSFORMED_AREA","dimensionScaleFactor","sqrt","getTransformData","upscaleMethod","DAR","getDevicePixelRatio","getOptimizedTransformData","getAlignedRect","sRect","dRect","alignment","x","y","alignTypes","CENTER","TOP","TOP_LEFT","TOP_RIGHT","BOTTOM","BOTTOM_LEFT","BOTTOM_RIGHT","LEFT","RIGHT","getOverlappingRect","isValidRect","pixelAspectRatio","MAX_DEVICE_PIXEL_RATIO","getAlignment","alignTypesMap","getFocalPoint","focalPoint","fp","isNaN","roundToFixed","getPreferredImageQuality","imageWidth","imageHeight","imageScaleDefaults","getImageQualityKey","quality","getClassicScaleData","imageKey","optimizedScaleFactor","maxUpscale","upscaleMethodValue","upscaleMethodsValues","classic","forceUSM","getAutoScaleData","getSuperScaleData","last","SUPER_UPSCALE_MODELS","super","getOptimizedScaleData","scaleDataFunc","auto","tWidth","tHeight","cssUpscaleNeeded","size","imageQuality","HIGH","MEDIUM","LOW","TINY","getDimension","round","value","precision","truncatePrecision","pow","toFixed","parseInt","getUpscaleString","options","upscaleMethods","AUTO","toUpperCase","module","exports"],"mappings":"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","file":"imageServiceUtils.js","sourcesContent":["'use strict'\nconst utils = require('./utils')\nconst constants = require('./imageServiceConstants')\nconst globalFeatureSupportObject = require('./imageServiceFeatureSupportObject')\n\n/**\n * Check once for browser support and store on global features support object\n * https://developers.google.com/speed/webp/faq#how_can_i_detect_browser_support_using_javascript\n */\nfunction checkWEBPSupport(type) {\n    const webpTypes = {\n        lossy: 'UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA',\n        lossless: 'UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==',\n        alpha: 'UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==',\n        animation: 'UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA'\n    }\n\n    const webpImg = new window.Image()\n    webpImg.onload = function () {\n        const isWebpFeature = globalFeatureSupportObject.getFeature('isWEBP')\n        isWebpFeature[type] = webpImg.width > 0 && webpImg.height > 0\n        globalFeatureSupportObject.setFeature('isWEBP', isWebpFeature)\n    }\n\n    webpImg.src = `data:image/webp;base64,${webpTypes[type]}`\n}\n\n/**\n * Populate the global feature support object with browser specific values\n */\nfunction populateGlobalFeatureSupport() {\n    if (typeof window !== 'undefined') {\n        // jpg 2 webp\n        checkWEBPSupport(constants.webp.LOSSY)\n        // png 2 webp\n        checkWEBPSupport(constants.webp.LOSSLESS)\n        checkWEBPSupport(constants.webp.ALPHA)\n        // 2 animation\n        checkWEBPSupport(constants.webp.ANIMATION)\n\n        // objectfit support\n        globalFeatureSupportObject.setFeature('isObjectFitBrowser', isPropertySupported('objectFit'))\n    }\n}\n\n/**\n * check if the browser supports webp image display\n * for the image source type\n * @param {string}    fileType\n *\n * @returns {boolean}\n */\nfunction isWEBPBrowserSupport(fileType) {\n    const isWebpFeature = globalFeatureSupportObject.getFeature('isWEBP')\n    const isLosssyJPG = fileType === constants.fileType.JPG && isWebpFeature[constants.webp.LOSSY]\n    const isLosslessPNG = fileType === constants.fileType.PNG && isWebpFeature[constants.webp.LOSSLESS]\n    const isAlphaPNG = fileType === constants.fileType.PNG && isWebpFeature[constants.webp.ALPHA]\n\n    return isLosssyJPG || isLosslessPNG && isAlphaPNG\n}\n\n/**\n * check if the browser supports ObjectFit css attribute\n *\n * @returns {boolean}\n */\nfunction isObjectFitBrowserSupport() {\n    return globalFeatureSupportObject.getFeature('isObjectFitBrowser')\n}\n\n/**\n * returns if a css property is supported\n * @param property\n *\n * @returns {boolean}\n */\nfunction isPropertySupported(property) {\n    return property in window.document.documentElement.style\n}\n\n/**\n * checks if image type is supported\n * @param {string}     uri      image source uri\n *\n * @returns {boolean}\n */\nfunction isImageTypeSupported(uri) {\n    const supportedImageExtensions = [\n        constants.fileType.PNG,\n        constants.fileType.JPEG,\n        constants.fileType.JPG,\n        constants.fileType.WIX_ICO_MP,\n        constants.fileType.WIX_MP\n    ]\n    return utils.includes(supportedImageExtensions, getFileExtension(uri))\n}\n\n/**\n * check request integrity\n * @param {string}                  fittingType         imageService.fittingTypes\n * @param {ImageTransformSource}    src\n * @param {ImageTransformTarget}    target\n *\n * @returns {boolean}\n */\nfunction isValidRequest(fittingType, src, target) {\n    return target && (src && !isUrlEmptyOrNone(src.id)) && utils.includes(constants.fittingTypes, fittingType)\n}\n\n/**\n * check if image transform is supported for source image\n * @param {string}     uri\n *\n * @returns {boolean}\n */\nfunction isImageTransformApplicable(uri) {\n    return isImageTypeSupported(uri) && !isExternalUrl(uri)\n}\n\n/**\n * returns true if image is of JPG type\n * @param {string}  uri\n *\n * @returns {boolean}\n */\nfunction isJPG(uri) {\n    return utils.includes(['jpg', 'jpeg'], getFileExtension(uri))\n}\n\n/**\n * returns true if image is of PNG type\n * @param {string}  uri\n *\n * @returns {boolean}\n */\nfunction isPNG(uri) {\n    return utils.includes(['png'], getFileExtension(uri))\n}\n\n/**\n * returns true if image is of webP type\n * @param {string}  uri\n *\n * @returns {boolean}\n */\nfunction isWEBP(uri) {\n    return utils.includes(['webp'], getFileExtension(uri))\n}\n\n/**\n * returns true if the url starts with http, https, // or data\n * @param {string}  url\n *\n * @returns {boolean}\n */\nfunction isExternalUrl(url) {\n    return (/(^https?)|(^data)|(^\\/\\/)/).test(url)\n}\n\n/**\n * returns true if the url empty or none string\n * @param {string}  url\n *\n * @returns {boolean}\n */\nfunction isUrlEmptyOrNone(url) {\n    return !url || !url.trim() || url.toLowerCase() === 'none'\n}\n\n/**\n * returns source image file name (no extension)\n * @param {string}     uri      image source uri\n * @param {string}     [name]   optional image source name\n *\n * @returns {string}\n */\nfunction getFileName(uri, name) {\n    const beforeLeadingSlashRegexp = /\\/(.*?)$/\n    const fileExtensionRegexp = /\\.([^.]*)$/\n\n    // if name is a non empty string, remove only supported extension if exists and url encode the string\n    if (typeof name === 'string' && name.length) {\n        //https://jira.wixpress.com/browse/WEED-12667\n        //const illegalChars = ['/', '\\\\', '#', '^', '?', '{', '}', '<', '>', '|', '`', '“', ':', '\"'].map(encodeURIComponent)\n        const illegalChars = ['/', '\\\\', '?', '<', '>', '|', '“', ':', '\"'].map(encodeURIComponent)\n        const urlSafeIllegalChars = ['\\\\.', '\\\\*']\n        const illegalCharsRegex = new RegExp(`(${illegalChars.concat(urlSafeIllegalChars).join('|')})`, 'g')\n        const illegalCharsReplacement = '_'\n\n        let fileName = name\n\n        const extension = name.match(fileExtensionRegexp)\n\n        if (extension && utils.includes(constants.supportedExtensions, extension[1])) {\n            fileName = name.replace(fileExtensionRegexp, '')\n        }\n        return encodeURIComponent(fileName).replace(illegalCharsRegex, illegalCharsReplacement)\n    }\n\n    // else, trim any preceding media structure from the uri string (like \"media/\" etc.) and remove extension\n    const trimmed = uri.match(beforeLeadingSlashRegexp)\n    const fileName = trimmed ? trimmed[1] : uri\n    return fileName.replace(fileExtensionRegexp, '')\n}\n\n/**\n * returns source image file name (no extension)\n * @param {string}     uri      image source uri\n *\n * @returns {string}\n */\nfunction getFileType(uri) {\n    if (isJPG(uri)) {\n        return constants.fileType.JPG\n    } else if (isPNG(uri)) {\n        return constants.fileType.PNG\n    } else if (isWEBP(uri)) {\n        return constants.fileType.WEBP\n    }\n    return constants.fileType.UNRECOGNIZED\n}\n\n/**\n * returns source image file extension\n * @param {string}     uri      image source uri\n *\n * @returns {string}\n */\nfunction getFileExtension(uri) {\n    const splitURI = /[.]([^.]+)$/.exec(uri)\n    return (splitURI && /[.]([^.]+)$/.exec(uri)[1] || '').toLowerCase()\n}\n\n/**\n * returns scale factor needed if FIT fitting\n * @param {number}  sWidth\n * @param {number}  sHeight\n * @param {number}  dWidth\n * @param {number}  dHeight\n *\n * @returns {number}\n */\nfunction getFitScaleFactor(sWidth, sHeight, dWidth, dHeight) {\n    return Math.min(dWidth / sWidth, dHeight / sHeight)\n}\n\n/**\n * returns scale factor needed if FILL fitting\n * @param {number}  sWidth\n * @param {number}  sHeight\n * @param {number}  dWidth\n * @param {number}  dHeight\n *\n * @returns {number}\n */\nfunction getFillScaleFactor(sWidth, sHeight, dWidth, dHeight) {\n    return Math.max(dWidth / sWidth, dHeight / sHeight)\n}\n\n/**\n * returns scale factor source target\n * @param {number}  sWidth\n * @param {number}  sHeight\n * @param {number}  dWidth\n * @param {number}  dHeight\n * @param {string}  transformType\n *\n * @returns {number}\n */\nfunction getScaleFactor(sWidth, sHeight, dWidth, dHeight, transformType) {\n    let scaleFactor\n    if (transformType === constants.transformTypes.FILL) {\n        scaleFactor = getFillScaleFactor(sWidth, sHeight, dWidth, dHeight)\n    } else if (transformType === constants.transformTypes.FIT) {\n        scaleFactor = getFitScaleFactor(sWidth, sHeight, dWidth, dHeight)\n    } else {\n        scaleFactor = 1\n    }\n    return scaleFactor\n}\n\n\n/**\n * get calculated scale factor , width and height while considering wixmp image transform dimension limits\n * @param sWidth\n * @param sHeight\n * @param dWidth\n * @param dHeight\n * @param transformType\n * @returns {{scaleFactor: *, width: *, height: *}}\n */\nfunction getSafeTransformData(sWidth, sHeight, dWidth, dHeight, transformType) {\n    let scaleFactor\n    let width\n    let height\n\n\n    // calculate safe image transformed area\n    scaleFactor = getScaleFactor(sWidth, sHeight, dWidth, dHeight, transformType)\n    if (transformType === constants.transformTypes.FILL) {\n        width = dWidth\n        height = dHeight\n    } else if (transformType === constants.transformTypes.FIT) {\n        width = sWidth * scaleFactor\n        height = sHeight * scaleFactor\n    }\n\n    // adjust target width & height & scaleFactor\n    if (width * height > constants.SAFE_TRANSFORMED_AREA) {\n        const dimensionScaleFactor = Math.sqrt(constants.SAFE_TRANSFORMED_AREA / (width * height))\n        width *= dimensionScaleFactor\n        height *= dimensionScaleFactor\n        //get the new scale factor\n        scaleFactor = getScaleFactor(sWidth, sHeight, width, height, transformType)\n    }\n\n    return {\n        scaleFactor,\n        width,\n        height\n    }\n}\n\n\n\n/**\n * returns the destination rectangle\n * @param {number}                  sWidth\n * @param {number}                  sHeight\n * @param {ImageTransformTarget}    target\n * @param {string}                  transformType\n * @param {string}                  upscaleMethod\n *\n * @returns {object}                {width, height, scaleFactor, upscaleMethodValue, forceUSM, cssUpscaleNeeded}\n */\nfunction getTransformData(sWidth, sHeight, target, transformType, upscaleMethod) {\n    //use target dimension is src not provided\n    sWidth = sWidth || target.width\n    sHeight = sHeight || target.height\n    // device pixel aspect ratio\n    const DAR = getDevicePixelRatio(target)\n\n    // adjust image transform values considering server side transform limitations and performance\n    const {scaleFactor, width, height} = getSafeTransformData(sWidth, sHeight, target.width * DAR, target.height * DAR, transformType)\n\n    // adjust image transform values to optimizing upsacle quality and payload\n    return getOptimizedTransformData(sWidth, sHeight, width, height, upscaleMethod, scaleFactor, transformType)\n}\n\n/**\n * returns overlapping rectangle where sRect\n * id aligned (according to alignment) within dRect\n * @param {object}      sRect         rect 1\n * @param {object}      dRect         rect 2\n * @param {string}      alignment\n *\n * @returns {{x:number,y:number,width:number, height:number}}\n */\nfunction getAlignedRect(sRect, dRect, alignment) {\n    let x\n    let y\n\n    // calculate cropping x,y\n    switch (alignment) {\n        case constants.alignTypes.CENTER:\n            x = Math.max(0, (sRect.width - dRect.width) / 2)\n            y = Math.max(0, (sRect.height - dRect.height) / 2)\n            break\n        case constants.alignTypes.TOP:\n            x = Math.max(0, (sRect.width - dRect.width) / 2)\n            y = 0\n            break\n        case constants.alignTypes.TOP_LEFT:\n            x = 0\n            y = 0\n            break\n        case constants.alignTypes.TOP_RIGHT:\n            x = Math.max(0, sRect.width - dRect.width)\n            y = 0\n            break\n        case constants.alignTypes.BOTTOM:\n            x = Math.max(0, (sRect.width - dRect.width) / 2)\n            y = Math.max(0, sRect.height - dRect.height)\n            break\n        case constants.alignTypes.BOTTOM_LEFT:\n            x = 0\n            y = Math.max(0, sRect.height - dRect.height)\n            break\n        case constants.alignTypes.BOTTOM_RIGHT:\n            x = Math.max(0, sRect.width - dRect.width)\n            y = Math.max(0, sRect.height - dRect.height)\n            break\n        case constants.alignTypes.LEFT:\n            x = 0\n            y = Math.max(0, (sRect.height - dRect.height) / 2)\n            break\n        case constants.alignTypes.RIGHT:\n            x = Math.max(0, sRect.width - dRect.width)\n            y = Math.max(0, (sRect.height - dRect.height) / 2)\n            break\n    }\n\n    // rect\n    return {\n        x: sRect.x ? sRect.x + x : x,\n        y: sRect.y ? sRect.y + y : y,\n        width: Math.min(sRect.width, dRect.width),\n        height: Math.min(sRect.height, dRect.height)\n    }\n}\n\n/**\n * returns overlapping rectangle between sRect and dRect\n * @param {object}      sRect         rect 1\n * @param {object}      dRect         rect 2\n *\n * @returns {{x:number,y:number,width:number, height:number} || null}\n */\nfunction getOverlappingRect(sRect, dRect) {\n    const width = Math.max(0, Math.min(sRect.width, dRect.x + dRect.width) - Math.max(0, dRect.x))\n    const height = Math.max(0, Math.min(sRect.height, dRect.y + dRect.height) - Math.max(0, dRect.y))\n\n\n    const isValidRect = width && height && (sRect.width !== width || sRect.height !== height)\n\n    // return overlapping sRect/dRect rectangle(x, y, width, height)\n    return isValidRect ? {\n        x: Math.max(0, dRect.x),\n        y: Math.max(0, dRect.y),\n        width,\n        height\n    } : null\n}\n\n/**\n * returns pixel aspect ratio value\n * @param {ImageTransformTarget}    target\n *\n * @returns {number}\n */\nfunction getDevicePixelRatio(target) {\n    return Math.min(target.pixelAspectRatio || 1, constants.MAX_DEVICE_PIXEL_RATIO)\n}\n\n/**\n * returns target alignment value\n * @param {ImageTransformTarget}    target\n *\n * @returns {string}\n */\nfunction getAlignment(target) {\n    return constants.alignTypesMap[target.alignment] || constants.alignTypesMap[constants.alignTypes.CENTER]\n}\n\n/**\n * returns the focal point value, if no focal point passed use alignment\n * @param {{x: number, y: number}|undefined} focalPoint\n */\nfunction getFocalPoint(focalPoint) {\n    let fp = null\n\n    if (typeof focalPoint.x === 'number' && !isNaN(focalPoint.x) && typeof focalPoint.y === 'number' && !isNaN(focalPoint.y)) {\n        fp = {\n            x: roundToFixed(Math.max(0, Math.min(100, focalPoint.x)) / 100, 2),\n            y: roundToFixed(Math.max(0, Math.min(100, focalPoint.y)) / 100, 2)\n        }\n    }\n\n    return fp\n}\n\n/**\n * returns preferred image quality value\n * @param {number}    imageWidth\n * @param {number}    imageHeight\n *\n * @returns {number}\n */\nfunction getPreferredImageQuality(imageWidth, imageHeight) {\n    return constants.imageScaleDefaults[getImageQualityKey(imageWidth, imageHeight)].quality\n}\n\n/**\n * returns the scale descriptor of CLASSIC upscale method\n * @param sWidth\n * @param sHeight\n * @returns {{optimizedScaleFactor: number, upscaleMethodValue: number, forceUSM: boolean}}\n */\nfunction getClassicScaleData(sWidth, sHeight) {\n    const imageKey = getImageQualityKey(sWidth, sHeight)\n    return {\n        optimizedScaleFactor: constants.imageScaleDefaults[imageKey].maxUpscale,\n        upscaleMethodValue: constants.upscaleMethodsValues.classic,\n        forceUSM: false\n    }\n}\n\n/**\n * returns the scale descriptor of AUTO upscale method\n * @param sWidth\n * @param sHeight\n * @returns {{optimizedScaleFactor: number, upscaleMethodValue: number, forceUSM: boolean}}\n */\nfunction getAutoScaleData(sWidth, sHeight) {\n    const imageKey = getImageQualityKey(sWidth, sHeight)\n    return {\n        optimizedScaleFactor: constants.imageScaleDefaults[imageKey].maxUpscale,\n        upscaleMethodValue: constants.upscaleMethodsValues.classic,\n        forceUSM: false\n    }\n}\n\n/**\n * returns the scale descriptor of SUPER upscale method\n * @param sWidth\n * @param sHeight\n * @param scaleFactor\n * @returns {{optimizedScaleFactor: number, upscaleMethodValue: number, forceUSM: boolean}}\n */\nfunction getSuperScaleData(sWidth, sHeight, scaleFactor) {\n    return {\n        optimizedScaleFactor: utils.last(constants.SUPER_UPSCALE_MODELS),\n        upscaleMethodValue: constants.upscaleMethodsValues.super,\n        forceUSM: !(constants.SUPER_UPSCALE_MODELS.includes(scaleFactor) || scaleFactor > utils.last(constants.SUPER_UPSCALE_MODELS))\n    }\n}\n\n/**\n * returns upscale descriptor object\n * @param {number}    sWidth\n * @param {number}    sHeight\n * @param {string}    upscaleMethod\n * @param {number}    scaleFactor\n *\n * @returns  {{maxScale: number, upscaleMethodValue: number, forceUSM: boolean}}\n */\nfunction getOptimizedScaleData(sWidth, sHeight, scaleFactor, upscaleMethod) {\n    const scaleDataFunc = {\n        classic: getClassicScaleData,\n        auto: getAutoScaleData,\n        super: getSuperScaleData\n    }\n    return scaleDataFunc[upscaleMethod](sWidth, sHeight, scaleFactor)\n}\n\n/**\n * returns optimized upscale data, considering requested upscale method , optimize upscale for best quality and banswidth\n * @param {number}    sWidth\n * @param {number}    sHeight\n * @param {number}    tWidth\n * @param {number}    tHeight\n * @param {string}    upscaleMethod\n * @param {number}    scaleFactor\n * @param {string}    transformType\n *\n * @returns  {{width: number, height: number, sacleFactor: number, upscaleMethodValue: number, forceUSM: boolean, cssUpscaleNeeded: boolean}}\n */\nfunction getOptimizedTransformData(sWidth, sHeight, tWidth, tHeight, upscaleMethod, scaleFactor, transformType) {\n    const {optimizedScaleFactor, upscaleMethodValue, forceUSM} = getOptimizedScaleData(sWidth, sHeight, scaleFactor, upscaleMethod)\n\n    if (scaleFactor <= optimizedScaleFactor) {\n        // target upscale within limits or downscale\n        return {\n            width: tWidth,\n            height: tHeight,\n            scaleFactor,\n            upscaleMethodValue,\n            forceUSM,\n            cssUpscaleNeeded: false\n        }\n    }\n    // limited upscale\n    let width\n    let height\n    switch (transformType) {\n        case constants.transformTypes.FILL:\n            width = tWidth * (optimizedScaleFactor / scaleFactor)\n            height = tHeight * (optimizedScaleFactor / scaleFactor)\n            break\n        case constants.transformTypes.FIT:\n            width = sWidth * optimizedScaleFactor\n            height = sHeight * optimizedScaleFactor\n            break\n        default:\n            break\n    }\n    // adjust transform values\n    return {\n        width,\n        height,\n        scaleFactor: optimizedScaleFactor,\n        upscaleMethodValue,\n        forceUSM,\n        cssUpscaleNeeded: true\n    }\n}\n\n\n/**\n * returns image quality key\n * @param {number}    imageWidth\n * @param {number}    imageHeight\n *\n * @returns {string}\n */\nfunction getImageQualityKey(imageWidth, imageHeight) {\n    const size = imageWidth * imageHeight\n\n    if (size > constants.imageScaleDefaults[constants.imageQuality.HIGH].size) {\n        return constants.imageQuality.HIGH\n    } else if (size > constants.imageScaleDefaults[constants.imageQuality.MEDIUM].size) {\n        return constants.imageQuality.MEDIUM\n    } else if (size > constants.imageScaleDefaults[constants.imageQuality.LOW].size) {\n        return constants.imageQuality.LOW\n    }\n    return constants.imageQuality.TINY\n}\n\n/**\n * return the actual rounded dimension of a scaled rectangle\n * @param sWidth\n * @param sHeight\n * @param tWidth\n * @param tHeight\n * @param transformType\n * @returns {{width: number, height: number}}\n */\nfunction getDimension(sWidth, sHeight, tWidth, tHeight, transformType) {\n    const scaleFactor = getScaleFactor(sWidth, sHeight, tWidth, tHeight, transformType)\n    return {\n        width: Math.round(sWidth * scaleFactor),\n        height: Math.round(sHeight * scaleFactor)\n    }\n}\n\n/**\n * rounds number n digit precision and converts to string\n * @param {number}      value\n * @param {number}      precision\n *\n * @returns {string}\n */\nfunction roundToFixed(value, precision) {\n    const truncatePrecision = Math.pow(10, precision || 0)\n    return (value * truncatePrecision / truncatePrecision).toFixed(parseInt(precision, 10))\n}\n\n/**\n * get normalize scale method\n * @param options\n * @returns {*}\n */\nfunction getUpscaleString(options) {\n    if (!options || !options.upscaleMethod || typeof options.upscaleMethod !== 'string') {\n        return constants.upscaleMethods.AUTO\n    }\n    return constants.upscaleMethods[options.upscaleMethod.toUpperCase()] || constants.upscaleMethods.AUTO\n}\n\n\nmodule.exports = {\n    populateGlobalFeatureSupport,\n    isWEBPBrowserSupport,\n    isObjectFitBrowserSupport,\n    isImageTransformApplicable,\n    isValidRequest,\n    isImageTypeSupported,\n    isExternalUrl,\n    isWEBP,\n    getFileType,\n    getFileExtension,\n    getFileName,\n    getAlignedRect,\n    getOverlappingRect,\n    getScaleFactor,\n    getTransformData,\n    getAlignment,\n    getPreferredImageQuality,\n    getDimension,\n    getFocalPoint,\n    getUpscaleString,\n    roundToFixed\n}\n"]}