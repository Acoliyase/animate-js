{"version":3,"sources":["../../../src/helpers/imageTransformParts.js"],"names":["utils","require","constants","imageServiceUtils","setTransformParts","transformsObj","src","target","rect","crop","getOverlappingRect","width","height","cropped","parts","push","getCropPart","fittingType","fittingTypes","SCALE_TO_FIT","LEGACY_FIT_WIDTH","LEGACY_FIT_HEIGHT","LEGACY_FULL","FIT_AND_TILE","LEGACY_BG_FIT_AND_TILE","LEGACY_BG_FIT_AND_TILE_HORIZONTAL","LEGACY_BG_FIT_AND_TILE_VERTICAL","LEGACY_BG_NORMAL","getFitPart","SCALE_TO_FILL","getFillPart","STRETCH","getStretchPart","TILE_HORIZONTAL","TILE_VERTICAL","TILE","LEGACY_ORIGINAL_SIZE","ORIGINAL_SIZE","getAlignedRect","alignment","isCropped","assign","LEGACY_STRIP_TILE_HORIZONTAL","LEGACY_STRIP_TILE_VERTICAL","LEGACY_STRIP_TILE","LEGACY_STRIP_ORIGINAL_SIZE","getLegacyCropPart","LEGACY_STRIP_SCALE_TO_FIT","LEGACY_STRIP_FIT_AND_TILE","getLegacyFitPart","LEGACY_STRIP_SCALE_TO_FILL","getLegacyFillPart","transformedData","getTransformData","transformTypes","FIT","upscaleMethod","transformType","FILL","Math","round","alignTypesMap","center","upscale","scaleFactor","forceUSM","cssUpscaleNeeded","upscaleMethodValue","focalPoint","getFocalPoint","FILL_FOCAL","getAlignment","focalPointX","x","focalPointY","y","getScaleFactor","clonedTarget","CROP","LEGACY_FILL","LEGACY_CROP","module","exports"],"mappings":"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","file":"imageTransformParts.js","sourcesContent":["'use strict'\n\nconst utils = require('./utils')\nconst constants = require('./imageServiceConstants')\nconst imageServiceUtils = require('./imageServiceUtils')\n\n/**\n * request analysis, returns parsed transforms object\n * @param {object}                  transformsObj\n * @param {ImageTransformSource}    src\n * @param {ImageTransformTarget}    target\n */\nfunction setTransformParts(transformsObj, src, target) {\n    let rect\n\n    // crop source image if needed\n    // set crop part and adjust source dimensions\n    if (src.crop) {\n        rect = imageServiceUtils.getOverlappingRect(src, src.crop)\n        if (rect) {\n            transformsObj.src.width = rect.width\n            transformsObj.src.height = rect.height\n            transformsObj.src.cropped = true\n            transformsObj.parts.push(getCropPart(rect))\n        }\n    }\n\n    // set additional transform part\n    switch (transformsObj.fittingType) {\n        case constants.fittingTypes.SCALE_TO_FIT:\n        case constants.fittingTypes.LEGACY_FIT_WIDTH:\n        case constants.fittingTypes.LEGACY_FIT_HEIGHT:\n        case constants.fittingTypes.LEGACY_FULL:\n        case constants.fittingTypes.FIT_AND_TILE:\n        case constants.fittingTypes.LEGACY_BG_FIT_AND_TILE:\n        case constants.fittingTypes.LEGACY_BG_FIT_AND_TILE_HORIZONTAL:\n        case constants.fittingTypes.LEGACY_BG_FIT_AND_TILE_VERTICAL:\n        case constants.fittingTypes.LEGACY_BG_NORMAL:\n        // fit\n            transformsObj.parts.push(getFitPart(transformsObj, target))\n            break\n\n        case constants.fittingTypes.SCALE_TO_FILL:\n        // fill\n            transformsObj.parts.push(getFillPart(transformsObj, target))\n            break\n\n        case constants.fittingTypes.STRETCH:\n        // stretch\n            transformsObj.parts.push(getStretchPart(transformsObj, target))\n            break\n\n        case constants.fittingTypes.TILE_HORIZONTAL:\n        case constants.fittingTypes.TILE_VERTICAL:\n        case constants.fittingTypes.TILE:\n        case constants.fittingTypes.LEGACY_ORIGINAL_SIZE:\n        case constants.fittingTypes.ORIGINAL_SIZE:\n        // use crop transform\n        // if crop of source image was requested adjust cropping rectangle\n            rect = imageServiceUtils.getAlignedRect(transformsObj.src, target, target.alignment)\n            if (transformsObj.src.isCropped) {\n                utils.assign(transformsObj.parts[0], rect)\n\n                // update source width & height accordingly\n                transformsObj.src.width = rect.width\n                transformsObj.src.height = rect.height\n            } else {\n                transformsObj.parts.push(getCropPart(rect))\n            }\n            break\n\n        // ---------------------------------------------------------------------------------------\n        // handles a legacy bug on bgImageStrip, background html tag\n        // component Full Width Strip stored incorrect image source width and height\n        // ---------------------------------------------------------------------------------------\n        case constants.fittingTypes.LEGACY_STRIP_TILE_HORIZONTAL:\n        case constants.fittingTypes.LEGACY_STRIP_TILE_VERTICAL:\n        case constants.fittingTypes.LEGACY_STRIP_TILE:\n        case constants.fittingTypes.LEGACY_STRIP_ORIGINAL_SIZE:\n        // crop request of source image is not supported\n        // use legacy crop\n            transformsObj.parts.push(getLegacyCropPart(target))\n            break\n\n        case constants.fittingTypes.LEGACY_STRIP_SCALE_TO_FIT:\n        case constants.fittingTypes.LEGACY_STRIP_FIT_AND_TILE:\n        // legacy fit\n            transformsObj.parts.push(getLegacyFitPart(target))\n            break\n\n        case constants.fittingTypes.LEGACY_STRIP_SCALE_TO_FILL:\n        // legacy fill\n            transformsObj.parts.push(getLegacyFillPart(target))\n            break\n    }\n}\n\n/**\n * returns fit part of the image transform uri\n * @param {object}                  transformsObj\n * @param {ImageTransformTarget}    target\n *\n * @returns {object}\n */\nfunction getFitPart(transformsObj, target) {\n    // calculate the transformed image size needed\n    const transformedData = imageServiceUtils.getTransformData(\n        transformsObj.src.width,\n        transformsObj.src.height,\n        target,\n        constants.transformTypes.FIT,\n        transformsObj.upscaleMethod)\n    const transformType = constants.transformTypes.FILL\n\n    // return fit transform data\n    return {\n        transformType,\n        width: Math.round(transformedData.width),\n        height: Math.round(transformedData.height),\n        alignment: constants.alignTypesMap.center,\n        upscale: transformedData.scaleFactor > 1,\n\n        forceUSM: transformedData.forceUSM,\n        scaleFactor: transformedData.scaleFactor,\n        cssUpscaleNeeded: transformedData.cssUpscaleNeeded,\n        upscaleMethodValue: transformedData.upscaleMethodValue\n    }\n}\n\n/**\n * returns fill part of the image transform uri\n * @param {object}                  transformsObj\n * @param {ImageTransformTarget}    target\n *\n * @returns {object}                {transformType, width, height, alignment, upscale, scaleFactor}\n */\nfunction getFillPart(transformsObj, target) {\n    // calculate the transformed image size needed\n    const transformedData = imageServiceUtils.getTransformData(\n        transformsObj.src.width,\n        transformsObj.src.height,\n        target,\n        constants.transformTypes.FILL,\n        transformsObj.upscaleMethod\n    )\n    const focalPoint = imageServiceUtils.getFocalPoint(transformsObj.focalPoint)\n    const transformType = focalPoint ? constants.transformTypes.FILL_FOCAL : constants.transformTypes.FILL\n\n    // return fill transform data\n    return {\n        transformType,\n        width: Math.round(transformedData.width),\n        height: Math.round(transformedData.height),\n        alignment: imageServiceUtils.getAlignment(target),\n        focalPointX: focalPoint && focalPoint.x,\n        focalPointY: focalPoint && focalPoint.y,\n        upscale: transformedData.scaleFactor > 1,\n\n        forceUSM: transformedData.forceUSM,\n        scaleFactor: transformedData.scaleFactor,\n        cssUpscaleNeeded: transformedData.cssUpscaleNeeded,\n        upscaleMethodValue: transformedData.upscaleMethodValue\n    }\n}\n\n/**\n * returns fill part of the image transform uri\n * @param {object}                  transformsObj\n * @param {ImageTransformTarget}    target\n *\n * @returns {object}\n */\nfunction getStretchPart(transformsObj, target) {\n    // stretch data\n    const scaleFactor = imageServiceUtils.getScaleFactor(transformsObj.src.width, transformsObj.src.height, target.width, target.height, constants.transformTypes.FILL)\n    const clonedTarget = utils.assign({}, target)\n    clonedTarget.width = transformsObj.src.width * scaleFactor\n    clonedTarget.height = transformsObj.src.height * scaleFactor\n\n    // return stretch part\n    return getFitPart(transformsObj, clonedTarget)\n}\n\n/**\n * returns crop part of the image transform uri\n * @param {Object}  rect     x, y, width, height\n *\n * @returns {object}\n */\nfunction getCropPart(rect) {\n    // crop data\n    return {\n        transformType: constants.transformTypes.CROP,\n        x: Math.round(rect.x),\n        y: Math.round(rect.y),\n        width: Math.round(rect.width),\n        height: Math.round(rect.height),\n        upscale: false,\n\n        forceUSM: false,\n        scaleFactor: 1,\n        cssUpscaleNeeded: false\n    }\n}\n\n// ---------------------------------------------------------------------------------------\n// handles a legacy bug on bgImageStrip, background html tag\n// component Full Width Strip stored incorrect image source width and height\n// ---------------------------------------------------------------------------------------\n\n/**\n * returns fit part of the image transform uri\n * @param {ImageTransformTarget}    target\n *\n * @returns {object}\n */\nfunction getLegacyFitPart(target) {\n    // return fit part\n    return {\n        transformType: constants.transformTypes.FIT,\n        width: Math.round(target.width),\n        height: Math.round(target.height),\n        upscale: false,\n\n        forceUSM: true,\n        scaleFactor: 1,\n        cssUpscaleNeeded: false\n    }\n}\n\n\n/**\n * returns fill part of the image transform uri\n * @param {ImageTransformTarget}    target\n *\n * @returns {object}\n */\nfunction getLegacyFillPart(target) {\n    // return fill part\n    return {\n        transformType: constants.transformTypes.LEGACY_FILL,\n        width: Math.round(target.width),\n        height: Math.round(target.height),\n        alignment: imageServiceUtils.getAlignment(target),\n        upscale: false,\n\n        forceUSM: true,\n        scaleFactor: 1,\n        cssUpscaleNeeded: false\n    }\n}\n\n/**\n * returns legacy crop part of the image transform uri\n * @param {ImageTransformTarget}     target\n *\n * @returns {object}\n */\nfunction getLegacyCropPart(target) {\n    // return crop part\n    return {\n        transformType: constants.transformTypes.LEGACY_CROP,\n        width: Math.round(target.width),\n        height: Math.round(target.height),\n        alignment: imageServiceUtils.getAlignment(target),\n        upscale: false,\n\n        forceUSM: false,\n        scaleFactor: 1,\n        cssUpscaleNeeded: false\n    }\n}\n\n\nmodule.exports = {\n    setTransformParts\n}\n"]}