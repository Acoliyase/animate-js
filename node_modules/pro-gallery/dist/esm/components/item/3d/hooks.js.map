{"version":3,"file":"hooks.js","sourceRoot":"","sources":["../../../../../src/components/item/3d/hooks.ts"],"names":[],"mappings":"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","sourcesContent":["import { GALLERY_CONSTS, Options, ThreeDimensionalScene } from 'pro-gallery-lib';\nimport { ThreeDImplementation } from './types.js';\nimport { useSceneManager } from '../../helpers/3dManager.js';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nfunction mapSceneToStyleParams(scene: ThreeDimensionalScene, options: Options) {\n  return {\n    behaviourParams_item_threeDimensionalScene_transform_rotation:\n      scene.transform?.rotation || options.behaviourParams_item_threeDimensionalScene_transform_rotation,\n    behaviourParams_item_threeDimensionalScene_transform_scale:\n      scene.transform?.scale || options.behaviourParams_item_threeDimensionalScene_transform_scale,\n    behaviourParams_item_threeDimensionalScene_transform_position:\n      scene.transform?.position || options.behaviourParams_item_threeDimensionalScene_transform_position,\n    behaviourParams_item_threeDimensionalScene_controls_enablePan:\n      scene.controls?.enablePan || options.behaviourParams_item_threeDimensionalScene_controls_enablePan,\n    behaviourParams_item_threeDimensionalScene_controls_enableRotate:\n      scene.controls?.enableRotate || options.behaviourParams_item_threeDimensionalScene_controls_enableRotate,\n    behaviourParams_item_threeDimensionalScene_controls_enableZoom:\n      scene.controls?.enableZoom || options.behaviourParams_item_threeDimensionalScene_controls_enableZoom,\n    behaviourParams_item_threeDimensionalScene_controls_enableAutoRotate:\n      scene.controls?.enableAutoRotate || options.behaviourParams_item_threeDimensionalScene_controls_enableAutoRotate,\n  };\n}\n\nexport function use3DItem(props: ThreeDImplementation): ThreeDItemHooks {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const { sceneManager, render } = useSceneManager();\n  const [isLoaded, setIsLoaded] = useState(false);\n\n  const sceneParams = mapSceneToStyleParams(props.scene || {}, props.options);\n\n  const loadedManager = useMemo(() => {\n    if (!props.shouldPlay) {\n      return sceneManager;\n    }\n    if (sceneManager) {\n      return sceneManager;\n    }\n    if (!props.itemContainer.current || !canvasRef.current) {\n      return sceneManager;\n    }\n    const manager = render(props.itemContainer.current, canvasRef.current);\n    if (!manager) {\n      throw new Error('Could not create scene manager post play');\n    }\n    manager.opacity = 0;\n    manager.model\n      .load3DModel(props.createUrl(GALLERY_CONSTS.urlSizes.RESIZED, GALLERY_CONSTS.urlTypes.THREE_D))\n      .then(({ punctualLights }) => {\n        props.actions.setItemLoaded();\n        manager.opacity = 1;\n        manager.model.addGround();\n        if (punctualLights) {\n          manager.environment.addAmbientLight();\n          manager.environment.sun();\n        }\n        requestAnimationFrame(() => {\n          setIsLoaded(true);\n        });\n      });\n    return manager;\n  }, [render, sceneManager, props.shouldPlay, props.itemContainer.current, canvasRef.current]);\n\n  const postLoadUpdate = useCallback(\n    ({\n      behaviourParams_item_threeDimensionalScene_transform_rotation,\n      behaviourParams_item_threeDimensionalScene_transform_scale,\n      behaviourParams_item_threeDimensionalScene_transform_position,\n      behaviourParams_item_threeDimensionalScene_controls_enablePan,\n      behaviourParams_item_threeDimensionalScene_controls_enableRotate,\n      behaviourParams_item_threeDimensionalScene_controls_enableZoom,\n      behaviourParams_item_threeDimensionalScene_controls_enableAutoRotate,\n    }: typeof sceneParams) => {\n      if (!loadedManager) {\n        return;\n      }\n      const rotation = GALLERY_CONSTS.parse3DDimensions(behaviourParams_item_threeDimensionalScene_transform_rotation);\n      const scale = GALLERY_CONSTS.parse3DDimensions(behaviourParams_item_threeDimensionalScene_transform_scale);\n      const position = GALLERY_CONSTS.parse3DDimensions(behaviourParams_item_threeDimensionalScene_transform_position);\n      loadedManager.model.transform.setPosition(position.x, position.y, position.z);\n      loadedManager.model.transform.setRotation(rotation.x, rotation.y, rotation.z);\n      loadedManager.camera.enablePan = behaviourParams_item_threeDimensionalScene_controls_enablePan;\n      loadedManager.camera.enableRotate = behaviourParams_item_threeDimensionalScene_controls_enableRotate;\n      loadedManager.camera.enableZoom = behaviourParams_item_threeDimensionalScene_controls_enableZoom;\n      loadedManager.camera.enableAutoRotate = behaviourParams_item_threeDimensionalScene_controls_enableAutoRotate;\n\n      loadedManager.model.transform.setScale(scale.x, scale.y, scale.z);\n    },\n    [loadedManager]\n  );\n\n  useEffect(() => {\n    if (isLoaded && loadedManager && props.shouldPlay === loadedManager.stop) {\n      loadedManager.stop = !props.shouldPlay;\n      return;\n    }\n  }, [props.shouldPlay, loadedManager, isLoaded]);\n\n  postLoadUpdate(sceneParams);\n\n  useEffect(() => {\n    return () => {\n      if (loadedManager) {\n        loadedManager.dispose();\n      }\n    };\n  }, [loadedManager]);\n\n  return {\n    canvasRef,\n    isLoaded,\n  };\n}\n\nexport interface ThreeDItemHooks {\n  canvasRef: React.RefObject<HTMLCanvasElement>;\n  isLoaded: boolean;\n}\n"]}